@page "/settings/notifications"
@page "/admin/notifications"
@page "/notifications"
@using Privatekonomi.Core.Models
@using Privatekonomi.Core.Services
@inject INotificationService NotificationService
@inject ICurrentUserService CurrentUserService
@inject NavigationManager NavigationManager

<PageTitle>Notifikationer</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">
        <MudIcon Icon="@Icons.Material.Filled.Notifications" Color="Color.Primary" Class="mr-2" aria-hidden="true" />
        Notifikationer
    </MudText>

    <MudPaper Class="pa-4 mt-4">
        <div class="d-flex justify-space-between align-center mb-4">
            <MudText Typo="Typo.h6">
                @if (_showUnreadOnly)
                {
                    <text>Ol√§sta notifikationer (@_unreadCount)</text>
                }
                else
                {
                    <text>Alla notifikationer</text>
                }
            </MudText>
            <div>
                <MudButton OnClick="ToggleUnreadFilter" 
                           Color="Color.Primary" 
                           Variant="Variant.Outlined" 
                           Size="Size.Small"
                           Class="mr-2">
                    @if (_showUnreadOnly)
                    {
                        <text>Visa alla</text>
                    }
                    else
                    {
                        <text>Visa ol√§sta</text>
                    }
                </MudButton>
                @if (_notifications.Any(n => !n.IsRead))
                {
                    <MudButton OnClick="MarkAllAsRead" 
                               Color="Color.Primary" 
                               Variant="Variant.Filled" 
                               Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.DoneAll">
                        Markera alla som l√§sta
                    </MudButton>
                }
            </div>
        </div>

        @if (_loading)
        {
            <div class="d-flex justify-center pa-8">
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            </div>
        }
        else if (!_notifications.Any())
        {
            <MudAlert Severity="Severity.Info">
                @if (_showUnreadOnly)
                {
                    <text>Du har inga ol√§sta notifikationer.</text>
                }
                else
                {
                    <text>Du har inga notifikationer √§n.</text>
                }
            </MudAlert>
        }
        else
        {
            @foreach (var notification in _notifications)
            {
                <MudPaper Class="pa-3 mb-2" Elevation="1" Style="@(notification.SnoozeUntil.HasValue && notification.SnoozeUntil.Value > DateTime.UtcNow ? "opacity: 0.7;" : "")">
                    <div class="d-flex align-start">
                        <MudIcon Icon="@GetNotificationIcon(notification.Type)" 
                                 Color="@GetNotificationColor(notification.Priority)" 
                                 Class="mr-3 mt-1" />
                        <div style="flex: 1;">
                            <MudText Typo="Typo.subtitle1" Style="@(notification.IsRead ? "" : "font-weight: bold;")">
                                @notification.Title
                            </MudText>
                            <MudText Typo="Typo.body2" Color="Color.Default">
                                @notification.Message
                            </MudText>
                            <MudText Typo="Typo.caption" Color="Color.Default">
                                @notification.CreatedAt.ToString("g")
                                @if (notification.IsRead && notification.ReadAt.HasValue)
                                {
                                    <text> - L√§st @notification.ReadAt.Value.ToString("g")</text>
                                }
                                @if (notification.SnoozeUntil.HasValue && notification.SnoozeUntil.Value > DateTime.UtcNow)
                                {
                                    <text> - üí§ Snoozad till @notification.SnoozeUntil.Value.ToLocalTime().ToString("g")</text>
                                }
                                @if (notification.SnoozeCount > 0)
                                {
                                    <text> (@notification.SnoozeCount snooz)</text>
                                }
                            </MudText>
                            
                            @* Quick actions for bill reminders *@
                            @if (IsBillReminder(notification) && !notification.IsRead)
                            {
                                <div class="d-flex gap-2 mt-2">
                                    <MudButton Size="Size.Small" 
                                               Variant="Variant.Outlined" 
                                               Color="Color.Success"
                                               StartIcon="@Icons.Material.Filled.CheckCircle"
                                               OnClick="@(() => MarkReminderAsCompleted(notification))">
                                        Markera som betald
                                    </MudButton>
                                    <MudMenu Label="Snooze" 
                                             Size="Size.Small" 
                                             Variant="Variant.Outlined"
                                             StartIcon="@Icons.Material.Filled.Snooze">
                                        <MudMenuItem OnClick="@(() => SnoozeNotification(notification, SnoozeDuration.OneHour))">
                                            1 timme
                                        </MudMenuItem>
                                        <MudMenuItem OnClick="@(() => SnoozeNotification(notification, SnoozeDuration.OneDay))">
                                            1 dag
                                        </MudMenuItem>
                                        <MudMenuItem OnClick="@(() => SnoozeNotification(notification, SnoozeDuration.OneWeek))">
                                            1 vecka
                                        </MudMenuItem>
                                    </MudMenu>
                                    @if (notification.ActionUrl?.Contains("/bills/") == true)
                                    {
                                        <MudButton Size="Size.Small"
                                                   Variant="Variant.Outlined"
                                                   Color="Color.Primary"
                                                   StartIcon="@Icons.Material.Filled.Receipt"
                                                   OnClick="@(() => CreateTransaction(notification))">
                                            Skapa transaktion
                                        </MudButton>
                                    }
                                </div>
                            }
                        </div>
                        <div class="d-flex flex-column gap-2">
                            @if (!notification.IsRead && !IsBillReminder(notification))
                            {
                                <MudIconButton Icon="@Icons.Material.Filled.Done" 
                                               Size="Size.Small"
                                               Color="Color.Success"
                                               OnClick="@(() => MarkAsRead(notification))"
                                               aria-label="Markera som l√§st" />
                            }
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                           Size="Size.Small"
                                           Color="Color.Error"
                                           OnClick="@(() => DeleteNotification(notification))"
                                           aria-label="Ta bort" />
                        </div>
                    </div>
                </MudPaper>
            }
        }
    </MudPaper>
</MudContainer>

@code {
    private List<Notification> _notifications = new();
    private int _unreadCount = 0;
    private bool _loading = true;
    private bool _showUnreadOnly = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadNotifications();
    }

    private async Task LoadNotifications()
    {
        _loading = true;
        try
        {
            var userId = CurrentUserService.UserId;
            if (userId != null)
            {
                _notifications = await NotificationService.GetUserNotificationsAsync(userId, _showUnreadOnly);
                _unreadCount = await NotificationService.GetUnreadCountAsync(userId);
            }
        }
        catch (Exception ex)
        {
            // Log error
            Console.WriteLine($"Error loading notifications: {ex.Message}");
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task ToggleUnreadFilter()
    {
        _showUnreadOnly = !_showUnreadOnly;
        await LoadNotifications();
    }

    private async Task MarkAsRead(Notification notification)
    {
        var userId = CurrentUserService.UserId;
        if (userId != null)
        {
            await NotificationService.MarkAsReadAsync(notification.NotificationId, userId);
            notification.IsRead = true;
            notification.ReadAt = DateTime.UtcNow;
            _unreadCount--;
            StateHasChanged();
        }
    }

    private async Task MarkAllAsRead()
    {
        var userId = CurrentUserService.UserId;
        if (userId != null)
        {
            await NotificationService.MarkAllAsReadAsync(userId);
            foreach (var notification in _notifications)
            {
                notification.IsRead = true;
                notification.ReadAt = DateTime.UtcNow;
            }
            _unreadCount = 0;
            StateHasChanged();
        }
    }

    private async Task DeleteNotification(Notification notification)
    {
        var userId = CurrentUserService.UserId;
        if (userId != null)
        {
            await NotificationService.DeleteNotificationAsync(notification.NotificationId, userId);
            _notifications.Remove(notification);
            if (!notification.IsRead)
            {
                _unreadCount--;
            }
            StateHasChanged();
        }
    }

    private async Task HandleNotificationClick(Notification notification)
    {
        if (!notification.IsRead)
        {
            await MarkAsRead(notification);
        }

        if (!string.IsNullOrEmpty(notification.ActionUrl))
        {
            NavigationManager.NavigateTo(notification.ActionUrl);
        }
    }

    private string GetNotificationIcon(SystemNotificationType type)
    {
        return type switch
        {
            SystemNotificationType.BudgetExceeded => Icons.Material.Filled.MoneyOff,
            SystemNotificationType.BudgetWarning => Icons.Material.Filled.Warning,
            SystemNotificationType.LowBalance => Icons.Material.Filled.AccountBalance,
            SystemNotificationType.UpcomingBill => Icons.Material.Filled.Event,
            SystemNotificationType.BillDue => Icons.Material.Filled.EventAvailable,
            SystemNotificationType.BillOverdue => Icons.Material.Filled.EventBusy,
            SystemNotificationType.GoalAchieved => Icons.Material.Filled.EmojiEvents,
            SystemNotificationType.GoalMilestone => Icons.Material.Filled.TrendingUp,
            SystemNotificationType.InvestmentChange => Icons.Material.Filled.ShowChart,
            SystemNotificationType.SignificantGain => Icons.Material.Filled.TrendingUp,
            SystemNotificationType.SignificantLoss => Icons.Material.Filled.TrendingDown,
            SystemNotificationType.UnusualTransaction => Icons.Material.Filled.ReportProblem,
            SystemNotificationType.LargeTransaction => Icons.Material.Filled.Receipt,
            SystemNotificationType.BankSyncFailed => Icons.Material.Filled.SyncProblem,
            SystemNotificationType.BankSyncSuccess => Icons.Material.Filled.Sync,
            SystemNotificationType.HouseholdActivity => Icons.Material.Filled.People,
            SystemNotificationType.HouseholdInvitation => Icons.Material.Filled.GroupAdd,
            SystemNotificationType.SubscriptionPriceIncrease => Icons.Material.Filled.TrendingUp,
            SystemNotificationType.SubscriptionRenewal => Icons.Material.Filled.Autorenew,
            SystemNotificationType.SystemMaintenance => Icons.Material.Filled.Build,
            SystemNotificationType.SystemAlert => Icons.Material.Filled.Error,
            _ => Icons.Material.Filled.Notifications
        };
    }

    private Color GetNotificationColor(NotificationPriority priority)
    {
        return priority switch
        {
            NotificationPriority.Critical => Color.Error,
            NotificationPriority.High => Color.Warning,
            NotificationPriority.Normal => Color.Primary,
            NotificationPriority.Low => Color.Info,
            _ => Color.Default
        };
    }

    private bool IsBillReminder(Notification notification)
    {
        return notification.Type is SystemNotificationType.UpcomingBill 
            or SystemNotificationType.BillDue 
            or SystemNotificationType.BillOverdue;
    }

    private async Task SnoozeNotification(Notification notification, SnoozeDuration duration)
    {
        var userId = CurrentUserService.UserId;
        if (userId != null)
        {
            try
            {
                // Call API to snooze
                using var httpClient = new HttpClient { BaseAddress = new Uri(NavigationManager.BaseUri) };
                var response = await httpClient.PostAsJsonAsync($"api/notifications/{notification.NotificationId}/snooze", 
                    new { Duration = duration });
                
                if (response.IsSuccessStatusCode)
                {
                    // Update local state
                    var snoozeUntil = duration switch
                    {
                        SnoozeDuration.OneHour => DateTime.UtcNow.AddHours(1),
                        SnoozeDuration.OneDay => DateTime.UtcNow.AddDays(1),
                        SnoozeDuration.OneWeek => DateTime.UtcNow.AddDays(7),
                        _ => DateTime.UtcNow.AddHours(1)
                    };
                    
                    notification.SnoozeUntil = snoozeUntil;
                    notification.SnoozeCount++;
                    StateHasChanged();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error snoozing notification: {ex.Message}");
            }
        }
    }

    private async Task MarkReminderAsCompleted(Notification notification)
    {
        var userId = CurrentUserService.UserId;
        if (userId != null)
        {
            try
            {
                // Call API to complete reminder
                using var httpClient = new HttpClient { BaseAddress = new Uri(NavigationManager.BaseUri) };
                var response = await httpClient.PostAsync($"api/notifications/{notification.NotificationId}/complete", null);
                
                if (response.IsSuccessStatusCode)
                {
                    notification.IsRead = true;
                    notification.ReadAt = DateTime.UtcNow;
                    _unreadCount--;
                    StateHasChanged();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error completing reminder: {ex.Message}");
            }
        }
    }

    private void CreateTransaction(Notification notification)
    {
        // Navigate to create transaction with pre-filled data from bill
        if (!string.IsNullOrEmpty(notification.ActionUrl))
        {
            // Extract bill ID from action URL
            var billId = notification.ActionUrl.Split('/').LastOrDefault();
            NavigationManager.NavigateTo($"/transactions/create?billId={billId}");
        }
    }
}
