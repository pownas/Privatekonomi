@page "/economy/transactions"
@page "/transactions"
@rendermode InteractiveServer
@using Privatekonomi.Web.Components.Dialogs
@inject ITransactionService TransactionService
@inject IHouseholdService HouseholdService
@inject ICategoryService CategoryService
@inject ICategoryRuleService CategoryRuleService
@inject IExportService ExportService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>Transaktioner - Privatekonomi</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">
    <MudIcon Icon="@Icons.Material.Filled.List" Color="Color.Primary" Class="mr-2" aria-hidden="true" />
    Transaktioner
    <MudIconButton Icon="@Icons.Material.Filled.Help" 
                   Color="Color.Default" 
                   Size="Size.Small"
                   Class="mobile-only ml-2"
                   OnClick="ShowGestureHelp"
                   title="Visa touch-gester hjälp" />
</MudText>

<MudPaper Class="pa-4">
    <MudGrid>
        <MudItem xs="12" Class="d-flex flex-column flex-sm-row justify-space-between align-start align-sm-center gap-2 mb-4">
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       StartIcon="@Icons.Material.Filled.Add" 
                       OnClick="@(() => Navigation.NavigateTo("/economy/transactions/new"))">
                Ny Transaktion
            </MudButton>
            <MudButtonGroup Color="Color.Primary" Variant="Variant.Outlined">
                <MudButton StartIcon="@Icons.Material.Filled.Download" OnClick="ExportToCsv">
                    <span class="d-none d-sm-inline">Exportera </span>CSV
                </MudButton>
                <MudButton StartIcon="@Icons.Material.Filled.Download" OnClick="ExportToJson">
                    <span class="d-none d-sm-inline">Exportera </span>JSON
                </MudButton>
            </MudButtonGroup>
        </MudItem>
    </MudGrid>

    <!-- Enhanced Filter Panel -->
    <MudExpansionPanels Class="mb-4">
        <MudExpansionPanel Text="Filter och sökning" Icon="@Icons.Material.Filled.FilterList" @bind-Expanded="_filterPanelExpanded">
            <MudGrid Spacing="2">
                <MudItem xs="12" md="4">
                    <MudTextField @bind-Value="_searchString" 
                                  @bind-Value:after="ApplyFilter"
                                  Placeholder="Sök efter beskrivning, tagg..." 
                                  Adornment="Adornment.Start" 
                                  AdornmentIcon="@Icons.Material.Filled.Search" 
                                  IconSize="Size.Medium" 
                                  Variant="Variant.Outlined"
                                  aria-label="Sök i transaktioner"
                                  Immediate="true" />
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudSelect T="int?" 
                              @bind-Value="_selectedCategoryId" 
                              @bind-Value:after="ApplyFilter"
                              Label="Kategori" 
                              Clearable="true"
                              Variant="Variant.Outlined"
                              aria-label="Filtrera efter kategori">
                        @foreach (var category in _categories)
                        {
                            <MudSelectItem Value="@((int?)category.CategoryId)">
                                <div class="d-flex align-center gap-2">
                                    <div style="@($"width: 12px; height: 12px; background-color: {category.Color}; border-radius: 50%;")"></div>
                                    @category.Name
                                </div>
                            </MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudSelect T="int?" 
                              @bind-Value="_selectedHouseholdId" 
                              @bind-Value:after="ApplyFilter"
                              Label="Hushåll" 
                              Clearable="true"
                              Variant="Variant.Outlined"
                              aria-label="Filtrera efter hushåll">
                        @foreach (var household in _households)
                        {
                            <MudSelectItem Value="@((int?)household.HouseholdId)">@household.Name</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="6" md="3">
                    <MudNumericField @bind-Value="_minAmount" 
                                    @bind-Value:after="ApplyFilter"
                                    Label="Min belopp" 
                                    Variant="Variant.Outlined"
                                    Adornment="Adornment.End"
                                    AdornmentText="kr"
                                    Clearable="true"
                                    aria-label="Minsta belopp" />
                </MudItem>
                <MudItem xs="6" md="3">
                    <MudNumericField @bind-Value="_maxAmount" 
                                    @bind-Value:after="ApplyFilter"
                                    Label="Max belopp" 
                                    Variant="Variant.Outlined"
                                    Adornment="Adornment.End"
                                    AdornmentText="kr"
                                    Clearable="true"
                                    aria-label="Största belopp" />
                </MudItem>
                <MudItem xs="6" md="3">
                    <MudDatePicker @bind-Date="_dateFrom" 
                                   @bind-Date:after="ApplyFilter"
                                   Label="Från datum" 
                                   Variant="Variant.Outlined"
                                   Clearable="true"
                                   aria-label="Från datum" />
                </MudItem>
                <MudItem xs="6" md="3">
                    <MudDatePicker @bind-Date="_dateTo" 
                                   @bind-Date:after="ApplyFilter"
                                   Label="Till datum" 
                                   Variant="Variant.Outlined"
                                   Clearable="true"
                                   aria-label="Till datum" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudSelect T="string" 
                              @bind-Value="_transactionTypeFilter" 
                              @bind-Value:after="ApplyFilter"
                              Label="Transaktionstyp" 
                              Clearable="true"
                              Variant="Variant.Outlined"
                              aria-label="Filtrera efter transaktionstyp">
                        <MudSelectItem Value="@("income")">Inkomster</MudSelectItem>
                        <MudSelectItem Value="@("expense")">Utgifter</MudSelectItem>
                        <MudSelectItem Value="@("uncategorized")">Okategoriserade</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" md="6" Class="d-flex align-end">
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="ClearFilters" StartIcon="@Icons.Material.Filled.Clear">
                        Rensa filter
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudExpansionPanel>
    </MudExpansionPanels>

    @if (_loading)
    {
        <div class="d-flex flex-column align-center pa-6">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-4">Laddar transaktioner...</MudText>
        </div>
    }
    else if (!_transactions.Any())
    {
        <MudPaper Class="pa-6" Elevation="0" Style="text-align: center;">
            <MudIcon Icon="@Icons.Material.Filled.Receipt" Size="Size.Large" Color="Color.Secondary" Class="mb-4" Style="font-size: 4rem;" />
            <MudText Typo="Typo.h6" Class="mb-2">Inga transaktioner än</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                Kom igång genom att skapa din första transaktion eller importera transaktioner från din bank.
            </MudText>
            <div class="d-flex justify-center gap-2">
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary" 
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="@(() => Navigation.NavigateTo("/economy/transactions/new"))">
                    Skapa Transaktion
                </MudButton>
                <MudButton Variant="Variant.Outlined" 
                           Color="Color.Primary" 
                           StartIcon="@Icons.Material.Filled.Upload"
                           OnClick="@(() => Navigation.NavigateTo("/settings/import"))">
                    Importera från Bank
                </MudButton>
            </div>
        </MudPaper>
    }
    else
    {
        @if (_selectedTransactions.Any())
        {
            <MudPaper Class="pa-4 mb-4" Elevation="2">
                <MudGrid>
                    <MudItem xs="12" sm="6" md="4">
                        <MudText Typo="Typo.subtitle1">
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Class="mr-2" />
                            <strong>@_selectedTransactions.Count</strong> @(_selectedTransactions.Count == 1 ? "transaktion vald" : "transaktioner valda")
                        </MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="8" Class="d-flex flex-wrap gap-2 justify-end">
                        <MudButton Variant="Variant.Filled" 
                                   Color="Color.Primary" 
                                   StartIcon="@Icons.Material.Filled.Category"
                                   OnClick="BulkCategorize"
                                   Size="Size.Small">
                            Kategorisera
                        </MudButton>
                        <MudButton Variant="Variant.Filled" 
                                   Color="Color.Primary" 
                                   StartIcon="@Icons.Material.Filled.Home"
                                   OnClick="BulkLinkHousehold"
                                   Size="Size.Small">
                            Koppla hushåll
                        </MudButton>
                        <MudButton Variant="Variant.Filled" 
                                   Color="Color.Primary" 
                                   StartIcon="@Icons.Material.Filled.Download"
                                   OnClick="BulkExport"
                                   Size="Size.Small">
                            Exportera
                        </MudButton>
                        <MudButton Variant="Variant.Filled" 
                                   Color="Color.Error" 
                                   StartIcon="@Icons.Material.Filled.Delete"
                                   OnClick="BulkDelete"
                                   Size="Size.Small">
                            Ta bort
                        </MudButton>
                        <MudButton Variant="Variant.Text" 
                                   Color="Color.Default"
                                   OnClick="ClearSelection"
                                   Size="Size.Small">
                            Avmarkera alla
                        </MudButton>
                        @if (_undoStack.Any())
                        {
                            <MudButton Variant="Variant.Text" 
                                       Color="Color.Secondary"
                                       StartIcon="@Icons.Material.Filled.Undo"
                                       OnClick="UndoLastOperation"
                                       Size="Size.Small">
                                Ångra
                            </MudButton>
                        }
                    </MudItem>
                </MudGrid>
            </MudPaper>
        }

        <MudDataGrid T="Transaction" 
                     Items="@_filteredTransactions" 
                     MultiSelection="true"
                     @bind-SelectedItems="_selectedTransactions"
                     Hover="true" 
                     Striped="true"
                     Dense="@_dense"
                     FixedHeader="true"
                     Height="600px"
                     SortMode="SortMode.Multiple">
            <ToolBarContent>
                <MudText Typo="Typo.subtitle1" Class="mr-4">@_filteredTransactions.Count() transaktioner</MudText>
                <MudSpacer />
                <MudTooltip Text="Tät/luftig layout">
                    <MudIconButton Icon="@Icons.Material.Filled.DensityMedium" 
                                   OnClick="@(() => _dense = !_dense)"
                                   Color="Color.Default"
                                   aria-label="Växla mellan tät och luftig layout" />
                </MudTooltip>
            </ToolBarContent>
            <Columns>
                <SelectColumn T="Transaction" />
                <PropertyColumn Property="x => x.Date" Title="Datum" Format="yyyy-MM-dd" />
                <TemplateColumn Title="Beskrivning" Sortable="false">
                    <CellTemplate>
                        <div Style="cursor: pointer;" @onclick="@(() => ViewTransactionDetails(context.Item))">
                            @context.Item.Description
                            @if (!string.IsNullOrWhiteSpace(context.Item.Notes))
                            {
                                <div class="mt-1">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary" Style="font-style: italic;">
                                        <MudIcon Icon="@Icons.Material.Filled.StickyNote2" Size="Size.Small" Style="vertical-align: middle;" />
                                        @(context.Item.Notes.Length > MaxNotePreviewLength ? context.Item.Notes.Substring(0, MaxNotePreviewLength) + "..." : context.Item.Notes)
                                    </MudText>
                                </div>
                            }
                        </div>
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Bank" Sortable="false">
                    <CellTemplate>
                        @if (context.Item.BankSource != null)
                        {
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Filled"
                                     Style="@($"background-color: {context.Item.BankSource.Color}; color: white;")">
                                @context.Item.BankSource.Name
                            </MudChip>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Default">-</MudText>
                        }
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Hushåll" Sortable="false">
                    <CellTemplate>
                        @if (context.Item.Household != null)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Secondary" Variant="Variant.Outlined">
                                <MudIcon Icon="@Icons.Material.Filled.Home" Size="Size.Small" /> @context.Item.Household.Name
                            </MudChip>
                        }
                        else
                        {
                            <MudText Typo="Typo.caption" Color="Color.Default">Personlig</MudText>
                        }
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Kategori" Sortable="false">
                    <CellTemplate>
                        @if (context.Item.TransactionCategories.Any())
                        {
                            @foreach (var tc in context.Item.TransactionCategories)
                            {
                                <MudChip T="string" Size="Size.Small" Variant="Variant.Filled"
                                         Style="@($"background-color: {tc.Category.Color}; color: white; margin: 2px;")">
                                    @tc.Category.Name
                                </MudChip>
                            }
                        }
                        else
                        {
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Default">
                                Okategoriserad
                            </MudChip>
                        }
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Belopp" Sortable="true" SortBy="@(x => x.Amount)">
                    <CellTemplate>
                        <div Style="text-align: right;">
                            <MudText Typo="Typo.body1" Style="@($"font-weight: 600; color: {(context.Item.IsIncome ? "#2e7d32" : "#d32f2f")};")">
                                @(context.Item.IsIncome ? "+" : "")@context.Item.Amount.ToString("N2", new System.Globalization.CultureInfo("sv-SE")) kr
                            </MudText>
                        </div>
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Åtgärder" Sortable="false" CellStyle="width: 150px;">
                    <CellTemplate>
                        <div class="d-flex gap-1">
                            <MudTooltip Text="Snabbkategorisera">
                                <MudIconButton Icon="@Icons.Material.Filled.Category" 
                                             Size="Size.Small" 
                                             Color="Color.Primary"
                                             OnClick="@(() => QuickCategorize(context.Item))"
                                             aria-label="Snabbkategorisera transaktion" />
                            </MudTooltip>
                            <MudTooltip Text="Skapa kategoriseringsregel">
                                <MudIconButton Icon="@Icons.Material.Filled.AutoAwesome" 
                                             Size="Size.Small" 
                                             Color="Color.Secondary"
                                             OnClick="@(() => CreateRuleFromTransaction(context.Item))"
                                             aria-label="Skapa kategoriseringsregel" />
                            </MudTooltip>
                            <MudTooltip Text="Redigera">
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                             Size="Size.Small" 
                                             Color="Color.Default"
                                             OnClick="@(() => EditTransaction(context.Item))"
                                             aria-label="Redigera transaktion" />
                            </MudTooltip>
                        </div>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
        </MudDataGrid>
    }
</MudPaper>

@code {
    private const int MaxNotePreviewLength = 50;
    
    private bool _loading = true;
    private bool _dense = false;
    private IEnumerable<Transaction> _transactions = new List<Transaction>();
    private IEnumerable<Transaction> _filteredTransactions = new List<Transaction>();
    private HashSet<Transaction> _selectedTransactions = new();
    private List<Household> _households = new();
    private List<Category> _categories = new();
    private string _searchString = "";
    private int? _selectedHouseholdId = null;
    private int? _selectedCategoryId = null;
    private decimal? _minAmount = null;
    private decimal? _maxAmount = null;
    private DateTime? _dateFrom = null;
    private DateTime? _dateTo = null;
    private string? _transactionTypeFilter = null;
    private bool _filterPanelExpanded = false;
    private DotNetObjectReference<Transactions>? _dotNetHelper;
    private Stack<BulkOperationSnapshot> _undoStack = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetHelper = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("mobileGestureHandler.init", _dotNetHelper);
            await AttachGestureListeners();
        }
    }

    private async Task AttachGestureListeners()
    {
        // Attach swipe listeners to transaction rows
        foreach (var transaction in _transactions)
        {
            var elementId = $"transaction-row-{transaction.TransactionId}";
            await JSRuntime.InvokeVoidAsync("eval", 
                $@"(function() {{
                    var element = document.getElementById('{elementId}');
                    if (element) {{
                        window.mobileGestureHandler.attachSwipeListeners(element, {transaction.TransactionId});
                    }}
                }})()");
        }
    }

    [JSInvokable]
    public async Task HandleSwipeGesture(string direction, int transactionId)
    {
        var transaction = _transactions.FirstOrDefault(t => t.TransactionId == transactionId);
        if (transaction == null) return;

        if (direction == "left")
        {
            // Swipe left - delete
            await DeleteTransaction(transactionId);
        }
        else if (direction == "right")
        {
            // Swipe right - edit
            await EditTransaction(transaction);
        }
    }

    [JSInvokable]
    public async Task HandlePullToRefresh()
    {
        await LoadData();
        Snackbar.Add("Transaktioner uppdaterade", Severity.Success);
    }

    public void Dispose()
    {
        _dotNetHelper?.Dispose();
    }

    private async Task LoadData()
    {
        _loading = true;
        var households = await HouseholdService.GetAllHouseholdsAsync();
        _households = households.ToList();
        var categories = await CategoryService.GetAllCategoriesAsync();
        _categories = categories.ToList();
        _transactions = await TransactionService.GetAllTransactionsAsync();
        ApplyFilter();
        _loading = false;
    }

    private void ApplyFilter()
    {
        _filteredTransactions = _transactions.Where(FilterFunc).ToList();
    }

    private bool FilterFunc(Transaction transaction)
    {
        // Filter by household
        if (_selectedHouseholdId.HasValue)
        {
            if (transaction.HouseholdId != _selectedHouseholdId.Value)
                return false;
        }
        
        // Filter by category
        if (_selectedCategoryId.HasValue)
        {
            if (!transaction.TransactionCategories.Any(tc => tc.CategoryId == _selectedCategoryId.Value))
                return false;
        }
        
        // Filter by amount range
        if (_minAmount.HasValue && transaction.Amount < _minAmount.Value)
            return false;
        if (_maxAmount.HasValue && transaction.Amount > _maxAmount.Value)
            return false;
        
        // Filter by date range
        if (_dateFrom.HasValue && transaction.Date < _dateFrom.Value)
            return false;
        if (_dateTo.HasValue && transaction.Date > _dateTo.Value)
            return false;
        
        // Filter by transaction type
        if (!string.IsNullOrEmpty(_transactionTypeFilter))
        {
            if (_transactionTypeFilter == "income" && !transaction.IsIncome)
                return false;
            if (_transactionTypeFilter == "expense" && transaction.IsIncome)
                return false;
            if (_transactionTypeFilter == "uncategorized" && transaction.TransactionCategories.Any())
                return false;
        }
        
        // Filter by search string
        if (!string.IsNullOrWhiteSpace(_searchString))
        {
            if (!transaction.Description.Contains(_searchString, StringComparison.OrdinalIgnoreCase) &&
                !transaction.TransactionCategories.Any(tc => tc.Category.Name.Contains(_searchString, StringComparison.OrdinalIgnoreCase)) &&
                !(transaction.BankSource != null && transaction.BankSource.Name.Contains(_searchString, StringComparison.OrdinalIgnoreCase)) &&
                !(transaction.Tags?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true) &&
                !(transaction.Notes?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true) &&
                !(transaction.Payee?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true))
            {
                return false;
            }
        }
        
        return true;
    }

    private void ClearFilters()
    {
        _searchString = "";
        _selectedHouseholdId = null;
        _selectedCategoryId = null;
        _minAmount = null;
        _maxAmount = null;
        _dateFrom = null;
        _dateTo = null;
        _transactionTypeFilter = null;
        ApplyFilter();
    }

    private async Task ViewTransactionDetails(Transaction transaction)
    {
        var parameters = new DialogParameters<TransactionDetailsDialog>
        {
            { x => x.Transaction, transaction },
            { x => x.OnEdit, EventCallback.Factory.Create<Transaction>(this, EditTransactionFromDetails) },
            { x => x.OnDelete, EventCallback.Factory.Create<Transaction>(this, DeleteTransactionFromDetails) }
        };

        var dialog = await DialogService.ShowAsync<TransactionDetailsDialog>("Transaktionsdetaljer", parameters, new DialogOptions 
        { 
            MaxWidth = MaxWidth.Large, 
            FullWidth = true 
        });
        
        var result = await dialog.Result;
        
        if (result is not null && !result.Canceled)
        {
            await LoadData();
        }
    }

    private async Task EditTransactionFromDetails(Transaction transaction)
    {
        await EditTransaction(transaction);
    }

    private async Task DeleteTransactionFromDetails(Transaction transaction)
    {
        await DeleteTransaction(transaction.TransactionId);
    }

    private async Task EditTransaction(Transaction transaction)
    {
        var parameters = new DialogParameters<EditTransactionDialog>
        {
            { x => x.Transaction, transaction }
        };

        var dialog = await DialogService.ShowAsync<EditTransactionDialog>("Redigera transaktion", parameters, new DialogOptions 
        { 
            MaxWidth = MaxWidth.Large, 
            FullWidth = true 
        });
        
        var result = await dialog.Result;
        
        if (result is not null && !result.Canceled)
        {
            await LoadData();
        }
    }

    private async Task DeleteTransaction(int id)
    {
        var result = await DialogService.ShowMessageBox(
            "Bekräfta borttagning",
            "Är du säker på att du vill ta bort denna transaktion?",
            yesText: "Ja", cancelText: "Avbryt");

        if (result == true)
        {
            await TransactionService.DeleteTransactionAsync(id);
            Snackbar.Add("Transaktion borttagen", Severity.Success);
            await LoadData();
        }
    }

    private async Task QuickCategorize(Transaction transaction)
    {
        var parameters = new DialogParameters<QuickCategorizeDialog>
        {
            { x => x.Transaction, transaction }
        };

        var dialog = await DialogService.ShowAsync<QuickCategorizeDialog>("Snabbkategorisera", parameters, new DialogOptions 
        { 
            MaxWidth = MaxWidth.Medium, 
            FullWidth = true 
        });
        
        var result = await dialog.Result;
        
        if (result is not null && !result.Canceled && result.Data is QuickCategorizeDialog.QuickCategorizeResult categorizeResult)
        {
            try
            {
                // Update the transaction category
                var categories = new List<TransactionCategory>
                {
                    new TransactionCategory
                    {
                        TransactionId = transaction.TransactionId,
                        CategoryId = categorizeResult.CategoryId,
                        Amount = transaction.Amount,
                        Percentage = 100
                    }
                };

                await TransactionService.UpdateTransactionCategoriesAsync(transaction.TransactionId, categories);
                
                // Optionally create a rule
                if (categorizeResult.CreateRule)
                {
                    var pattern = categorizeResult.RulePattern ?? transaction.Description;
                    var rule = new CategoryRule
                    {
                        Pattern = pattern,
                        MatchType = PatternMatchType.Contains,
                        CategoryId = categorizeResult.CategoryId,
                        Field = MatchField.Both,
                        Priority = 50,
                        IsActive = true,
                        Description = $"Skapad från transaktion: {transaction.Description}"
                    };

                    await CategoryRuleService.CreateRuleAsync(rule);
                    Snackbar.Add("Transaktion kategoriserad och regel skapad!", Severity.Success);
                }
                else
                {
                    Snackbar.Add("Transaktion kategoriserad!", Severity.Success);
                }

                await LoadData();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Fel vid kategorisering: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task CreateRuleFromTransaction(Transaction transaction)
    {
        var parameters = new DialogParameters<CreateRuleFromTransactionDialog>
        {
            { x => x.Transaction, transaction }
        };

        var dialog = await DialogService.ShowAsync<CreateRuleFromTransactionDialog>("Skapa Kategoriseringsregel", parameters, new DialogOptions 
        { 
            MaxWidth = MaxWidth.Medium, 
            FullWidth = true 
        });
        
        var result = await dialog.Result;
        
        if (result is not null && !result.Canceled)
        {
            Snackbar.Add("Kategoriseringsregel skapad!", Severity.Success);
        }
    }

    private async Task ShowGestureHelp()
    {
        await DialogService.ShowAsync<GestureHelpDialog>("Touch-gester", new DialogOptions 
        { 
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        });
    }

    private async Task ExportToCsv()
    {
        try
        {
            var csvData = await ExportService.ExportTransactionsToCsvAsync();
            var fileName = $"transaktioner_{DateTime.Now:yyyyMMdd_HHmmss}.csv";
            
            await DownloadFile(csvData, fileName, "text/csv");
            Snackbar.Add("Transaktioner exporterade till CSV", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ett fel uppstod vid export: {ex.Message}", Severity.Error);
        }
    }

    private async Task ExportToJson()
    {
        try
        {
            var jsonData = await ExportService.ExportTransactionsToJsonAsync();
            var fileName = $"transaktioner_{DateTime.Now:yyyyMMdd_HHmmss}.json";
            
            await DownloadFile(jsonData, fileName, "application/json");
            Snackbar.Add("Transaktioner exporterade till JSON", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ett fel uppstod vid export: {ex.Message}", Severity.Error);
        }
    }

    private async Task DownloadFile(byte[] fileData, string fileName, string contentType)
    {
        var base64 = Convert.ToBase64String(fileData);
        await JSRuntime.InvokeVoidAsync("downloadFile", fileName, contentType, base64);
    }

    // Bulk Operations
    private void ClearSelection()
    {
        _selectedTransactions.Clear();
    }

    private async Task BulkCategorize()
    {
        if (!_selectedTransactions.Any())
        {
            Snackbar.Add("Välj minst en transaktion", Severity.Warning);
            return;
        }

        var parameters = new DialogParameters<BulkCategorizeDialog>
        {
            { x => x.SelectedTransactionCount, _selectedTransactions.Count }
        };

        var dialog = await DialogService.ShowAsync<BulkCategorizeDialog>("Bulk-kategorisera", parameters, new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        });

        var result = await dialog.Result;

        if (result is not null && !result.Canceled && result.Data != null)
        {
            try
            {
                var selectedCategories = (List<dynamic>)result.Data;
                var transactionIds = _selectedTransactions.Select(t => t.TransactionId).ToList();

                // Create snapshot for undo
                var snapshot = await TransactionService.CreateOperationSnapshotAsync(
                    transactionIds,
                    BulkOperationType.Categorize);
                
                var categories = selectedCategories
                    .Select(c => ((int)c.CategoryId, (decimal?)c.Amount))
                    .ToList();

                var bulkResult = await TransactionService.BulkCategorizeTransactionsAsync(
                    transactionIds,
                    categories);

                if (bulkResult.IsSuccess)
                {
                    _undoStack.Push(snapshot);
                    Snackbar.Add($"{bulkResult.SuccessCount} transaktioner kategoriserade", Severity.Success);
                }
                else if (bulkResult.IsPartialSuccess)
                {
                    _undoStack.Push(snapshot);
                    Snackbar.Add($"{bulkResult.SuccessCount} kategoriserade, {bulkResult.FailureCount} misslyckades", Severity.Warning);
                }
                else
                {
                    Snackbar.Add($"Misslyckades: {string.Join(", ", bulkResult.Errors)}", Severity.Error);
                }

                await LoadData();
                ClearSelection();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Fel vid bulk-kategorisering: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task BulkLinkHousehold()
    {
        if (!_selectedTransactions.Any())
        {
            Snackbar.Add("Välj minst en transaktion", Severity.Warning);
            return;
        }

        var parameters = new DialogParameters<BulkLinkHouseholdDialog>
        {
            { x => x.SelectedTransactionCount, _selectedTransactions.Count }
        };

        var dialog = await DialogService.ShowAsync<BulkLinkHouseholdDialog>("Bulk-koppla hushåll", parameters, new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        });

        var result = await dialog.Result;

        if (result is not null && !result.Canceled)
        {
            try
            {
                var householdId = (int?)result.Data;
                var transactionIds = _selectedTransactions.Select(t => t.TransactionId).ToList();

                // Create snapshot for undo
                var snapshot = await TransactionService.CreateOperationSnapshotAsync(
                    transactionIds,
                    BulkOperationType.LinkHousehold);

                var bulkResult = await TransactionService.BulkLinkToHouseholdAsync(
                    transactionIds,
                    householdId);

                if (bulkResult.IsSuccess)
                {
                    _undoStack.Push(snapshot);
                    var message = householdId.HasValue
                        ? $"{bulkResult.SuccessCount} transaktioner kopplade till hushåll"
                        : $"{bulkResult.SuccessCount} transaktioner bortkopplade från hushåll";
                    Snackbar.Add(message, Severity.Success);
                }
                else if (bulkResult.IsPartialSuccess)
                {
                    _undoStack.Push(snapshot);
                    Snackbar.Add($"{bulkResult.SuccessCount} kopplade, {bulkResult.FailureCount} misslyckades", Severity.Warning);
                }
                else
                {
                    Snackbar.Add($"Misslyckades: {string.Join(", ", bulkResult.Errors)}", Severity.Error);
                }

                await LoadData();
                ClearSelection();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Fel vid bulk-koppling: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task BulkExport()
    {
        if (!_selectedTransactions.Any())
        {
            Snackbar.Add("Välj minst en transaktion", Severity.Warning);
            return;
        }

        var parameters = new DialogParameters
        {
            { "Message", $"Välj format för export av {_selectedTransactions.Count} transaktioner" }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowMessageBox(
            "Exportera transaktioner",
            new MarkupString($"Välj format för export av <strong>{_selectedTransactions.Count}</strong> transaktioner:"),
            "CSV", "JSON", "Avbryt",
            options);

        if (dialog == true) // CSV
        {
            await ExportSelectedToCsv();
        }
        else if (dialog == false) // JSON
        {
            await ExportSelectedToJson();
        }
    }

    private async Task ExportSelectedToCsv()
    {
        try
        {
            var transactionIds = _selectedTransactions.Select(t => t.TransactionId).ToList();
            var csvData = await ExportService.ExportSelectedTransactionsToCsvAsync(transactionIds);
            var fileName = $"transaktioner_{DateTime.Now:yyyyMMdd_HHmmss}.csv";
            
            await DownloadFile(csvData, fileName, "text/csv");
            Snackbar.Add($"{_selectedTransactions.Count} transaktioner exporterade till CSV", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ett fel uppstod vid export: {ex.Message}", Severity.Error);
        }
    }

    private async Task ExportSelectedToJson()
    {
        try
        {
            var transactionIds = _selectedTransactions.Select(t => t.TransactionId).ToList();
            var jsonData = await ExportService.ExportSelectedTransactionsToJsonAsync(transactionIds);
            var fileName = $"transaktioner_{DateTime.Now:yyyyMMdd_HHmmss}.json";
            
            await DownloadFile(jsonData, fileName, "application/json");
            Snackbar.Add($"{_selectedTransactions.Count} transaktioner exporterade till JSON", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ett fel uppstod vid export: {ex.Message}", Severity.Error);
        }
    }

    private async Task BulkDelete()
    {
        if (!_selectedTransactions.Any())
        {
            Snackbar.Add("Välj minst en transaktion", Severity.Warning);
            return;
        }

        var transactionText = _selectedTransactions.Count == 1 ? "transaktion" : "transaktioner";
        var result = await DialogService.ShowMessageBox(
            "Bekräfta borttagning",
            new MarkupString($"Är du säker på att du vill ta bort <strong>{_selectedTransactions.Count}</strong> {transactionText}?<br/><br/><em>OBS: Denna åtgärd kan inte ångras!</em>"),
            yesText: "Ja, ta bort", cancelText: "Avbryt");

        if (result == true)
        {
            try
            {
                var transactionIds = _selectedTransactions.Select(t => t.TransactionId).ToList();

                var bulkResult = await TransactionService.BulkDeleteTransactionsAsync(transactionIds);

                if (bulkResult.IsSuccess)
                {
                    Snackbar.Add($"{bulkResult.SuccessCount} transaktioner borttagna", Severity.Success);
                }
                else if (bulkResult.IsPartialSuccess)
                {
                    Snackbar.Add($"{bulkResult.SuccessCount} borttagna, {bulkResult.FailureCount} misslyckades", Severity.Warning);
                }
                else
                {
                    Snackbar.Add($"Misslyckades: {string.Join(", ", bulkResult.Errors)}", Severity.Error);
                }

                await LoadData();
                ClearSelection();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Fel vid borttagning: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task UndoLastOperation()
    {
        if (!_undoStack.Any())
        {
            Snackbar.Add("Ingen operation att ångra", Severity.Info);
            return;
        }

        var snapshot = _undoStack.Pop();

        try
        {
            var result = await TransactionService.UndoBulkOperationAsync(snapshot);

            if (result.IsSuccess)
            {
                Snackbar.Add($"{result.SuccessCount} transaktioner återställda", Severity.Success);
            }
            else if (result.IsPartialSuccess)
            {
                Snackbar.Add($"{result.SuccessCount} återställda, {result.FailureCount} misslyckades", Severity.Warning);
            }
            else
            {
                Snackbar.Add($"Misslyckades: {string.Join(", ", result.Errors)}", Severity.Error);
                // Push back if failed
                _undoStack.Push(snapshot);
            }

            await LoadData();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fel vid ångra: {ex.Message}", Severity.Error);
            _undoStack.Push(snapshot);
        }
    }
}
