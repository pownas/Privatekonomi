@page "/settings/import"
@page "/admin/import"
@page "/import"
@rendermode InteractiveServer
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject HttpClient Http
@inject IInvestmentService InvestmentService
@inject IBankSourceService BankSourceService
@using Privatekonomi.Web.Services
@using System.Globalization

<PageTitle>Importera - Privatekonomi</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">
    <MudIcon Icon="@Icons.Material.Filled.Upload" Color="Color.Primary" Class="mr-2" aria-hidden="true" />
    @(_importType == ImportType.None ? "Importera" : _importType == ImportType.Transactions ? "Importera Transaktioner" : "Importera Investeringar")
</MudText>

@if (_currentStep == ImportStep.TypeSelection)
{
    <MudPaper Class="pa-6">
        <MudText Typo="Typo.h6" Class="mb-4">Vad vill du importera?</MudText>
        
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudPaper Outlined="true" Class="pa-6 cursor-pointer" Style="height: 100%;" @onclick="() => SelectImportType(ImportType.Transactions)">
                    <div class="d-flex flex-column align-center text-center">
                        <MudIcon Icon="@Icons.Material.Filled.AccountBalance" Size="Size.Large" Color="Color.Primary" Class="mb-2" />
                        <MudText Typo="Typo.h6" Class="mb-2">Transaktioner</MudText>
                        <MudText Typo="Typo.body2">Importera transaktioner från bankfiler (ICA-banken, Swedbank)</MudText>
                    </div>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" md="6">
                <MudPaper Outlined="true" Class="pa-6 cursor-pointer" Style="height: 100%;" @onclick="() => SelectImportType(ImportType.Investments)">
                    <div class="d-flex flex-column align-center text-center">
                        <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Size="Size.Large" Color="Color.Primary" Class="mb-2" />
                        <MudText Typo="Typo.h6" Class="mb-2">Investeringar</MudText>
                        <MudText Typo="Typo.body2">Importera innehav från depåfiler (Avanza)</MudText>
                    </div>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudPaper>
}
else if (_currentStep == ImportStep.BankSelection)
{
    <MudPaper Class="pa-6">
        <MudText Typo="Typo.h6" Class="mb-4">Välj bank</MudText>
        
        @if (_importType == ImportType.Transactions)
        {
            <MudRadioGroup @bind-Value="_selectedBank">
                <MudRadio Value="@("ICA-banken")" Color="Color.Primary">
                    <MudText>ICA-banken</MudText>
                </MudRadio>
                <MudRadio Value="@("Swedbank")" Color="Color.Primary">
                    <MudText>Swedbank</MudText>
                </MudRadio>
            </MudRadioGroup>
        }
        else if (_importType == ImportType.Investments)
        {
            <MudRadioGroup @bind-Value="_selectedBankId">
                @foreach (var bank in _investmentBanks)
                {
                    <MudRadio Value="@bank.BankSourceId" Color="Color.Primary">
                        <MudText>@bank.Name</MudText>
                    </MudRadio>
                }
            </MudRadioGroup>
        }
        
        <MudDivider Class="my-4" />
        
        <div class="d-flex justify-space-between">
            <MudButton Variant="Variant.Outlined" Color="Color.Default" OnClick="BackToTypeSelection">
                Tillbaka
            </MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                       OnClick="NextToFileSelection" 
                       Disabled="@IsNextButtonDisabled">
                Nästa
            </MudButton>
        </div>
    </MudPaper>
}
else if (_currentStep == ImportStep.FileSelection)
{
    <MudPaper Class="pa-6">
        <MudText Typo="Typo.h6" Class="mb-4">Välj fil att importera</MudText>
        <MudText Typo="Typo.body2" Class="mb-2">
            Bank: <strong>@(_importType == ImportType.Transactions ? _selectedBank : _selectedBankName)</strong>
        </MudText>
        
        @if (_importType == ImportType.Investments && _selectedBankName == "Avanza")
        {
            <MudAlert Severity="Severity.Info" Class="mb-4">
                Avanza tillhandahåller två CSV-format:
                <ul>
                    <li><strong>Mitt innehav fördelat per konto</strong> - Visar innehav per konto med kontonummer</li>
                    <li><strong>Mitt sammanställda innehav</strong> - Visar sammanställt innehav över alla konton</li>
                </ul>
                Båda formaten stöds!
            </MudAlert>
        }
        
        <MudFileUpload T="IBrowserFile" FilesChanged="OnFileSelected" Accept=".csv">
            <ActivatorContent>
                <MudPaper Outlined="true" Class="pa-8 d-flex flex-column align-center justify-center" Style="min-height: 200px; cursor: pointer;">
                    <MudIcon Icon="@Icons.Material.Filled.CloudUpload" Size="Size.Large" Class="mb-2" />
                    <MudText Typo="Typo.h6">Dra och släpp CSV-fil här</MudText>
                    <MudText Typo="Typo.body2" Class="mt-2">eller</MudText>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-2">
                        Välj fil från dator
                    </MudButton>
                </MudPaper>
            </ActivatorContent>
        </MudFileUpload>
        
        @if (_selectedFile != null)
        {
            <MudAlert Severity="Severity.Info" Class="mt-4">
                Vald fil: <strong>@_selectedFile.Name</strong> (@FormatFileSize(_selectedFile.Size))
            </MudAlert>
        }
        
        <MudText Typo="Typo.caption" Class="mt-4">
            Tillåtna format: .csv<br/>
            Max storlek: 10 MB
        </MudText>
        
        <MudDivider Class="my-4" />
        
        <div class="d-flex justify-space-between">
            <MudButton Variant="Variant.Outlined" Color="Color.Default" OnClick="BackToBankSelection">
                Tillbaka
            </MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                       OnClick="@(_importType == ImportType.Transactions ? UploadAndPreview : ImportInvestmentFile)" 
                       Disabled="_selectedFile == null || _uploading || _importing">
                @if (_uploading || _importing)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                    <MudText Class="ml-2">@(_importType == ImportType.Transactions ? "Läser fil..." : "Importerar...")</MudText>
                }
                else
                {
                    <span>@(_importType == ImportType.Transactions ? "Förhandsgranska" : "Importera")</span>
                }
            </MudButton>
        </div>
    </MudPaper>
}
else if (_currentStep == ImportStep.Preview)
{
    <MudPaper Class="pa-6">
        <MudText Typo="Typo.h6" Class="mb-4">Förhandsvisning</MudText>
        
        @if (_previewData != null && _previewData.Any())
        {
            <MudText Typo="Typo.body2" Class="mb-4">Visar första 5 transaktionerna:</MudText>
            
            <MudSimpleTable Hover="true" Dense="true" Class="mb-4">
                <thead>
                    <tr>
                        <th>Datum</th>
                        <th>Belopp</th>
                        <th>Beskrivning</th>
                        <th>Typ</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var transaction in _previewData)
                    {
                        <tr>
                            <td>@transaction.Date</td>
                            <td style="@(transaction.IsIncome ? "color: green;" : "color: red;")">
                                @(transaction.IsIncome ? "+" : "-")@transaction.Amount.ToString("N2") kr
                            </td>
                            <td>@transaction.Description</td>
                            <td>
                                <MudChip T="string" Size="Size.Small" Color="@(transaction.IsIncome ? Color.Success : Color.Error)">
                                    @(transaction.IsIncome ? "Inkomst" : "Utgift")
                                </MudChip>
                            </td>
                        </tr>
                    }
                </tbody>
            </MudSimpleTable>
        }
        
        @if (_summary != null)
        {
            <MudAlert Severity="Severity.Info" Class="mb-4">
                <MudText><strong>Sammanfattning:</strong></MudText>
                <MudText>• @_summary.ValidTransactions transaktioner kommer importeras</MudText>
                @if (_summary.Duplicates > 0)
                {
                    <MudText>• @_summary.Duplicates dubbletter hittades (hoppas över)</MudText>
                }
                @if (_summary.Errors > 0)
                {
                    <MudText Class="red-text">• @_summary.Errors rader kunde inte läsas</MudText>
                }
                <MudDivider Class="my-2" />
                <MudText>Totalt belopp: @_summary.TotalAmount.ToString("N2") kr</MudText>
                <MudText Class="green-text">Inkomster: +@_summary.IncomeAmount.ToString("N2") kr</MudText>
                <MudText Class="red-text">Utgifter: -@_summary.ExpenseAmount.ToString("N2") kr</MudText>
            </MudAlert>
        }
        
        <MudDivider Class="my-4" />
        
        <div class="d-flex justify-space-between">
            <MudButton Variant="Variant.Outlined" Color="Color.Default" OnClick="BackToFileSelection">
                Avbryt
            </MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Success" 
                       OnClick="ConfirmImport" Disabled="_confirming">
                @if (_confirming)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                    <MudText Class="ml-2">Importerar...</MudText>
                }
                else
                {
                    <span>Bekräfta import</span>
                }
            </MudButton>
        </div>
    </MudPaper>
}
else if (_currentStep == ImportStep.Complete)
{
    var successState = GetSuccessState();
    <MudPaper Class="pa-6">
        <div class="d-flex flex-column align-center">
            <MudIcon Icon="@successState.Icon" 
                     Color="@successState.Color" 
                     Size="Size.Large" Class="mb-4" />
            <MudText Typo="Typo.h5" Class="mb-2">
                @successState.Message
            </MudText>
            
            @if (_importType == ImportType.Transactions && _importResult != null)
            {
                <MudAlert Severity="Severity.Success" Class="mt-4" Style="width: 100%;">
                    <MudText><strong>@_importResult.Imported</strong> transaktioner importerade</MudText>
                    @if (_importResult.Duplicates > 0)
                    {
                        <MudText><strong>@_importResult.Duplicates</strong> dubbletter överhoppades</MudText>
                    }
                    @if (_importResult.Errors > 0)
                    {
                        <MudText Class="red-text"><strong>@_importResult.Errors</strong> rader kunde inte importeras</MudText>
                    }
                </MudAlert>
            }
            else if (_importType == ImportType.Investments && _investmentImportResult != null)
            {
                <MudAlert Severity="@(_investmentImportResult.Success ? Severity.Success : Severity.Error)" Class="mt-4" Style="width: 100%;">
                    @if (_investmentImportResult.Success)
                    {
                        <MudText><strong>@_investmentImportResult.ImportedCount</strong> nya investeringar importerade</MudText>
                        @if (_investmentImportResult.DuplicateCount > 0)
                        {
                            <MudText><strong>@_investmentImportResult.DuplicateCount</strong> befintliga investeringar uppdaterades</MudText>
                        }
                        <MudText>Totalt <strong>@_investmentImportResult.TotalRows</strong> rader bearbetades</MudText>
                    }
                    
                    @if (_investmentImportResult.ErrorCount > 0 || _investmentImportResult.Errors.Any())
                    {
                        <MudText Class="mt-2"><strong>Fel:</strong></MudText>
                        @foreach (var error in _investmentImportResult.Errors)
                        {
                            <MudText Class="red-text">• @error.ErrorMessage</MudText>
                        }
                    }
                </MudAlert>
            }
            
            <MudDivider Class="my-4" Style="width: 100%;" />
            
            <div class="d-flex gap-4">
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="StartNewImport">
                    Importera fler
                </MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                           OnClick="@(_importType == ImportType.Transactions ? GoToTransactions : GoToInvestments)">
                    Gå till @(_importType == ImportType.Transactions ? "transaktioner" : "investeringar")
                </MudButton>
            </div>
        </div>
    </MudPaper>
}

@code {
    private enum ImportStep
    {
        TypeSelection,
        BankSelection,
        FileSelection,
        Preview,
        Complete
    }

    private enum ImportType
    {
        None,
        Transactions,
        Investments
    }

    private ImportStep _currentStep = ImportStep.TypeSelection;
    private ImportType _importType = ImportType.None;
    
    // Transaction import fields
    private string _selectedBank = string.Empty;
    private IBrowserFile? _selectedFile;
    private bool _uploading = false;
    private bool _confirming = false;
    private string _fileId = string.Empty;
    private List<PreviewTransaction>? _previewData;
    private SummaryData? _summary;
    private ImportResultData? _importResult;
    
    // Investment import fields
    private List<BankSource> _investmentBanks = new();
    private int _selectedBankId = 0;
    private string _selectedBankName = "";
    private bool _importing = false;
    private CsvImportResult? _investmentImportResult;

    protected override async Task OnInitializedAsync()
    {
        var allBanks = await BankSourceService.GetAllBankSourcesAsync();
        // Only show Avanza for now
        _investmentBanks = allBanks.Where(b => b.Name == "Avanza").ToList();
        
        // If Avanza doesn't exist, add all banks
        if (!_investmentBanks.Any())
        {
            _investmentBanks = allBanks.ToList();
        }
    }

    private void SelectImportType(ImportType type)
    {
        _importType = type;
        _currentStep = ImportStep.BankSelection;
    }

    private void BackToTypeSelection()
    {
        _currentStep = ImportStep.TypeSelection;
        _importType = ImportType.None;
        _selectedBank = string.Empty;
        _selectedBankId = 0;
        _selectedFile = null;
    }

    private void NextToFileSelection()
    {
        if (_importType == ImportType.Investments)
        {
            _selectedBankName = _investmentBanks.FirstOrDefault(b => b.BankSourceId == _selectedBankId)?.Name ?? "";
        }
        _currentStep = ImportStep.FileSelection;
    }

    private void BackToBankSelection()
    {
        _currentStep = ImportStep.BankSelection;
        _selectedFile = null;
    }

    private void BackToFileSelection()
    {
        _currentStep = ImportStep.FileSelection;
        _previewData = null;
        _summary = null;
        _fileId = string.Empty;
    }

    private void OnFileSelected(IBrowserFile file)
    {
        _selectedFile = file;
    }

    private async Task ImportInvestmentFile()
    {
        if (_selectedFile == null) return;

        const long maxFileSize = 10 * 1024 * 1024; // 10 MB

        if (_selectedFile.Size > maxFileSize)
        {
            Snackbar.Add("Filen är för stor. Max storlek är 10 MB.", Severity.Error);
            return;
        }

        _importing = true;

        try
        {
            using var stream = _selectedFile.OpenReadStream(maxFileSize);
            _investmentImportResult = await InvestmentService.ImportFromCsvAsync(stream, _selectedBankId);

            if (_investmentImportResult.Success)
            {
                Snackbar.Add($"Import slutförd! {_investmentImportResult.ImportedCount} investeringar importerade.", Severity.Success);
            }
            else
            {
                Snackbar.Add("Import misslyckades. Se detaljer nedan.", Severity.Error);
            }

            _currentStep = ImportStep.Complete;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ett fel uppstod: {ex.Message}", Severity.Error);
        }
        finally
        {
            _importing = false;
        }
    }

    private async Task UploadAndPreview()
    {
        if (_selectedFile == null) return;

        _uploading = true;

        try
        {
            // Validate file size
            if (_selectedFile.Size > 10 * 1024 * 1024)
            {
                Snackbar.Add("Filen är för stor. Max storlek är 10 MB.", Severity.Error);
                return;
            }

            // Create multipart form data
            using var content = new MultipartFormDataContent();
            var fileContent = new StreamContent(_selectedFile.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024));
            fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("text/csv");
            content.Add(fileContent, "file", _selectedFile.Name);
            content.Add(new StringContent(_selectedBank), "bankName");

            // Upload to API
            var response = await Http.PostAsync("https://localhost:7023/api/import/upload", content);
            
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<PreviewResponse>();
                
                if (result != null && result.Success)
                {
                    _fileId = result.FileId;
                    _previewData = result.Preview;
                    _summary = result.Summary;
                    _currentStep = ImportStep.Preview;
                }
                else
                {
                    Snackbar.Add("Kunde inte läsa CSV-filen. Kontrollera formatet.", Severity.Error);
                }
            }
            else
            {
                var errorMessage = await ApiErrorHandler.GetErrorMessageAsync(response);
                Snackbar.Add(errorMessage, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ett fel uppstod: {ex.Message}", Severity.Error);
        }
        finally
        {
            _uploading = false;
        }
    }

    private async Task ConfirmImport()
    {
        _confirming = true;

        try
        {
            var request = new ConfirmImportRequest
            {
                FileId = _fileId,
                Bank = _selectedBank,
                SkipDuplicates = true
            };

            var response = await Http.PostAsJsonAsync("https://localhost:7023/api/import/confirm", request);
            
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<ImportResultData>();
                
                if (result != null && result.Success)
                {
                    _importResult = result;
                    _currentStep = ImportStep.Complete;
                    Snackbar.Add($"{result.Imported} transaktioner importerade!", Severity.Success);
                }
                else
                {
                    Snackbar.Add("Import misslyckades", Severity.Error);
                }
            }
            else
            {
                var errorMessage = await ApiErrorHandler.GetErrorMessageAsync(response);
                Snackbar.Add(errorMessage, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ett fel uppstod: {ex.Message}", Severity.Error);
        }
        finally
        {
            _confirming = false;
        }
    }

    private void StartNewImport()
    {
        _currentStep = ImportStep.TypeSelection;
        _importType = ImportType.None;
        _selectedBank = string.Empty;
        _selectedBankId = 0;
        _selectedBankName = "";
        _selectedFile = null;
        _previewData = null;
        _summary = null;
        _importResult = null;
        _investmentImportResult = null;
        _fileId = string.Empty;
    }

    private void GoToTransactions()
    {
        Navigation.NavigateTo("/economy/transactions");
    }

    private void GoToInvestments()
    {
        Navigation.NavigateTo("/investments/overview");
    }

    private (string Icon, Color Color, string Message) GetSuccessState()
    {
        if (_importType == ImportType.Investments && _investmentImportResult != null)
        {
            return _investmentImportResult.Success 
                ? (Icons.Material.Filled.CheckCircle, Color.Success, "Import slutförd!")
                : (Icons.Material.Filled.Error, Color.Error, "Import misslyckades");
        }
        return (Icons.Material.Filled.CheckCircle, Color.Success, "Import slutförd!");
    }

    private bool IsNextButtonDisabled
    {
        get
        {
            return _importType == ImportType.Transactions 
                ? string.IsNullOrEmpty(_selectedBank) 
                : _selectedBankId == 0;
        }
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    private class PreviewTransaction
    {
        public string Date { get; set; } = string.Empty;
        public decimal Amount { get; set; }
        public string Description { get; set; } = string.Empty;
        public bool IsIncome { get; set; }
    }

    private class PreviewResponse
    {
        public bool Success { get; set; }
        public string FileId { get; set; } = string.Empty;
        public List<PreviewTransaction> Preview { get; set; } = new();
        public SummaryData Summary { get; set; } = new();
    }

    private class SummaryData
    {
        public int TotalRows { get; set; }
        public int ValidTransactions { get; set; }
        public int Duplicates { get; set; }
        public int Errors { get; set; }
        public decimal TotalAmount { get; set; }
        public decimal IncomeAmount { get; set; }
        public decimal ExpenseAmount { get; set; }
    }

    private class ConfirmImportRequest
    {
        public string FileId { get; set; } = string.Empty;
        public string Bank { get; set; } = string.Empty;
        public bool SkipDuplicates { get; set; } = true;
    }

    private class ImportResultData
    {
        public bool Success { get; set; }
        public int Imported { get; set; }
        public int Duplicates { get; set; }
        public int Errors { get; set; }
    }
}
