@page "/savings/goals"
@page "/goals"
@rendermode InteractiveServer
@using Privatekonomi.Core.Models
@using Privatekonomi.Web.Components.Shared
@inject IGoalService GoalService
@inject IGoalMilestoneService GoalMilestoneService
@inject IBankSourceService BankSourceService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Sparmål - Privatekonomi</PageTitle>

<div class="page-header mb-4">
    <MudText Typo="Typo.h4">
        <MudIcon Icon="@Icons.Material.Filled.EmojiEvents" Color="Color.Primary" Class="mr-2" aria-hidden="true" />
        Sparmål
    </MudText>
    <div class="page-header-buttons">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="ToggleCreateForm">
            Nytt Sparmål
        </MudButton>
    </div>
</div>

@if (_showCreateForm)
{
    <MudPaper Class="pa-4 mb-4">
        <MudText Typo="Typo.h6" Class="mb-3">@(_editingGoal != null ? "Redigera Sparmål" : "Lägg till Nytt Sparmål")</MudText>
        
        <MudTextField @bind-Value="_formGoal.Name" 
                      Label="Namn" 
                      Variant="Variant.Outlined"
                      Required="true"
                      MaxLength="200"
                      Class="mb-3" />
        
        <MudTextField @bind-Value="_formGoal.Description" 
                      Label="Beskrivning" 
                      Variant="Variant.Outlined"
                      Lines="3"
                      MaxLength="500"
                      Class="mb-3" />

        <MudNumericField @bind-Value="_formGoal.TargetAmount" 
                         Label="Målbelopp (kr)" 
                         Variant="Variant.Outlined"
                         Min="0"
                         Format="N2"
                         Culture="@(SwedishCulture)"
                         Class="mb-3" />

        <MudNumericField @bind-Value="_formGoal.CurrentAmount" 
                         Label="Sparat belopp (kr)" 
                         Variant="Variant.Outlined"
                         Min="0"
                         Format="N2"
                         Culture="@(SwedishCulture)"
                         Class="mb-3" />

        <MudDatePicker @bind-Date="_formGoalTargetDate"
                       Label="Målsättningsdatum"
                       Variant="Variant.Outlined"
                       Class="mb-3" />

        <MudSelect @bind-Value="_formGoal.Priority" Label="Prioritet" Variant="Variant.Outlined" Class="mb-3">
            <MudSelectItem Value="1">1 - Högst</MudSelectItem>
            <MudSelectItem Value="2">2 - Hög</MudSelectItem>
            <MudSelectItem Value="3">3 - Normal</MudSelectItem>
            <MudSelectItem Value="4">4 - Låg</MudSelectItem>
            <MudSelectItem Value="5">5 - Lägst</MudSelectItem>
        </MudSelect>

        <MudSelect @bind-Value="_formGoal.FundedFromBankSourceId" 
                   Label="Sparkonto (valfritt)" 
                   Variant="Variant.Outlined" 
                   Class="mb-3"
                   Clearable="true">
            @foreach (var bankSource in _bankSources)
            {
                <MudSelectItem Value="@((int?)bankSource.BankSourceId)">@bankSource.Name</MudSelectItem>
            }
        </MudSelect>

        <MudDivider Class="my-4" />
        
        <MudText Typo="Typo.h6" Class="mb-3">Automatiskt sparande</MudText>
        
        <MudSelect @bind-Value="_formGoal.AutoSavingsType" 
                   Label="Typ av automatiskt sparande" 
                   Variant="Variant.Outlined" 
                   Class="mb-3">
            <MudSelectItem Value="@AutoSavingsType.None">Inget automatiskt sparande</MudSelectItem>
            <MudSelectItem Value="@AutoSavingsType.FixedAmount">Fast belopp per månad</MudSelectItem>
            <MudSelectItem Value="@AutoSavingsType.RoundUp">Avrundning (Round-up)</MudSelectItem>
        </MudSelect>

        @if (_formGoal.AutoSavingsType == AutoSavingsType.FixedAmount)
        {
            <MudNumericField @bind-Value="_formGoal.MonthlyAutoSavingsAmount" 
                             Label="Månadsbelopp (kr)" 
                             Variant="Variant.Outlined"
                             Min="0"
                             Format="N2"
                             Culture="@(SwedishCulture)"
                             Adornment="Adornment.End"
                             AdornmentText="kr/mån"
                             HelperText="Det belopp som automatiskt sparas varje månad"
                             Class="mb-3" />
        }
        else if (_formGoal.AutoSavingsType == AutoSavingsType.RoundUp)
        {
            <MudAlert Severity="Severity.Info" Class="mb-3">
                Round-up sparande avrunda dina transaktioner till närmaste krona och sparar skillnaden.
                Konfigurera detta under "Round-up Sparande" i menyn.
            </MudAlert>
        }

        <div class="d-flex gap-2">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveGoal">
                @(_editingGoal != null ? "Uppdatera" : "Lägg till")
            </MudButton>
            <MudButton Variant="Variant.Outlined" OnClick="CancelForm">Avbryt</MudButton>
        </div>
    </MudPaper>
}

@if (_loading)
{
    <div class="d-flex flex-column align-center pa-6">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-4">Laddar sparmål...</MudText>
    </div>
}
else
{
    <MudPaper Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" md="4">
                <MudCard Elevation="2" Class="pa-4">
                    <MudCardContent>
                        <MudText Typo="Typo.h6">Totalt Sparmål</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Primary">@_totalTargetAmount.ToString("C", SwedishCulture)</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="12" md="4">
                <MudCard Elevation="2" Class="pa-4">
                    <MudCardContent>
                        <MudText Typo="Typo.h6">Totalt Sparat</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Success">@_totalCurrentAmount.ToString("C", SwedishCulture)</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="12" md="4">
                <MudCard Elevation="2" Class="pa-4">
                    <MudCardContent>
                        <MudText Typo="Typo.h6">Genomsnittligt Framsteg</MudText>
                        <MudText Typo="Typo.h4">@_averageProgress.ToString("F1")%</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudTable Items="@_goals" Hover="true" Striped="true" Dense="false">
        <HeaderContent>
            <MudTh Style="width: 50px;"></MudTh>
            <MudTh Style="width: 50px;"></MudTh>
            <MudTh>Namn</MudTh>
            <MudTh>Beskrivning</MudTh>
            <MudTh>Målbelopp</MudTh>
            <MudTh>Sparat</MudTh>
            <MudTh>Framsteg</MudTh>
            <MudTh>Milestones</MudTh>
            <MudTh>Målsättningsdatum</MudTh>
            <MudTh>Prioritet</MudTh>
            <MudTh>Sparkonto</MudTh>
            <MudTh>Åtgärder</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>
                <MudIcon Icon="@Icons.Material.Filled.DragIndicator" 
                         Style="cursor: move; color: var(--mud-palette-text-secondary);" 
                         Title="Dra för att ändra prioritet" />
            </MudTd>
            <MudTd>
                @if (_goalMilestones.ContainsKey(context.GoalId) && _goalMilestones[context.GoalId].Any())
                {
                    <MudIconButton Icon="@(_expandedGoals.Contains(context.GoalId) ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)" 
                                   Size="Size.Small" 
                                   OnClick="@(() => ToggleMilestones(context.GoalId))"
                                   aria-label="@(_expandedGoals.Contains(context.GoalId) ? "Dölj målstolpar" : "Visa målstolpar")" />
                }
            </MudTd>
            <MudTd DataLabel="Namn">
                <MudText Typo="Typo.body1"><strong>@context.Name</strong></MudText>
            </MudTd>
            <MudTd DataLabel="Beskrivning">
                <MudText Typo="Typo.body2" Color="Color.Secondary">@context.Description</MudText>
            </MudTd>
            <MudTd DataLabel="Målbelopp">
                <MudText Typo="Typo.body1">@context.TargetAmount.ToString("C", SwedishCulture)</MudText>
            </MudTd>
            <MudTd DataLabel="Sparat">
                <MudText Typo="Typo.body1" Color="Color.Success">@context.CurrentAmount.ToString("C", SwedishCulture)</MudText>
            </MudTd>
            <MudTd DataLabel="Framsteg" Style="min-width: 200px;">
                <div class="d-flex flex-column gap-1">
                    <MudProgressLinear Color="@GetProgressColor(context)" 
                                       Rounded="true" 
                                       Size="Size.Large" 
                                       Value="@GetProgress(context)" 
                                       Style="height: 24px;" />
                    <MudText Typo="Typo.caption" Align="Align.Center">
                        @context.CurrentAmount.ToString("N0", SwedishCulture) / @context.TargetAmount.ToString("N0", SwedishCulture) kr (@GetProgress(context).ToString("F0")%)
                    </MudText>
                </div>
            </MudTd>
            <MudTd DataLabel="Milestones">
                @if (_goalMilestones.ContainsKey(context.GoalId))
                {
                    var milestones = _goalMilestones[context.GoalId];
                    var reached = milestones.Count(m => m.IsReached);
                    <MudChip T="string" Size="Size.Small" Color="@(reached == milestones.Count() ? Color.Success : Color.Primary)">
                        @reached/@milestones.Count()
                    </MudChip>
                }
                else
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Default">0/0</MudChip>
                }
            </MudTd>
            <MudTd DataLabel="Målsättningsdatum">
                @if (context.TargetDate.HasValue)
                {
                    <MudText Typo="Typo.body2">@context.TargetDate.Value.ToString("yyyy-MM-dd")</MudText>
                }
                else
                {
                    <span>-</span>
                }
            </MudTd>
            <MudTd DataLabel="Prioritet">
                <div class="d-flex align-center gap-2">
                    <div class="d-flex flex-column">
                        <MudIconButton Icon="@Icons.Material.Filled.KeyboardArrowUp" 
                                       Size="Size.Small" 
                                       OnClick="@(() => MovePriorityUp(context))"
                                       Disabled="@(context.Priority <= 1)"
                                       title="Öka prioritet"
                                       Style="height: 20px; padding: 0;" />
                        <MudIconButton Icon="@Icons.Material.Filled.KeyboardArrowDown" 
                                       Size="Size.Small" 
                                       OnClick="@(() => MovePriorityDown(context))"
                                       Disabled="@(context.Priority >= 5)"
                                       title="Minska prioritet"
                                       Style="height: 20px; padding: 0;" />
                    </div>
                    <MudChip T="string" Color="@GetPriorityColor(context.Priority)" Size="Size.Small">
                        Prioritet @context.Priority
                    </MudChip>
                </div>
            </MudTd>
            <MudTd DataLabel="Sparkonto">
                @if (context.FundedFromBankSource != null)
                {
                    <MudChip T="string" Size="Size.Small" Style="@($"background-color: {context.FundedFromBankSource.Color}; color: white;")">
                        @context.FundedFromBankSource.Name
                    </MudChip>
                }
                else
                {
                    <span>-</span>
                }
            </MudTd>
            <MudTd DataLabel="Åtgärder">
                <div class="d-flex gap-1">
                    <MudIconButton Icon="@Icons.Material.Filled.Calculate" 
                                   Size="Size.Small" 
                                   OnClick="@(() => OpenSimulationDialog(context))" 
                                   Color="Color.Info" 
                                   title="Simulera sparande"
                                   aria-label="Simulera sparande" />
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                   Size="Size.Small" 
                                   OnClick="@(() => EditGoal(context))" 
                                   Color="Color.Primary" 
                                   aria-label="Redigera sparmål" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                   Size="Size.Small" 
                                   OnClick="@(() => DeleteGoal(context.GoalId))" 
                                   Color="Color.Error" 
                                   aria-label="Ta bort sparmål" />
                </div>
            </MudTd>
        </RowTemplate>
        <ChildRowContent>
            @if (_expandedGoals.Contains(context.GoalId) && _goalMilestones.ContainsKey(context.GoalId))
            {
                <MudTr>
                    <td colspan="11">
                        <MudCard Elevation="0" Outlined="true" Class="ma-2 mb-3">
                            <MudCardHeader>
                                <MudText Typo="Typo.h6">Målstolpar för @context.Name</MudText>
                            </MudCardHeader>
                            <MudCardContent>
                                <div class="d-flex flex-column gap-3">
                                    @foreach (var milestone in _goalMilestones[context.GoalId].OrderBy(m => m.Percentage))
                                    {
                                        <div class="d-flex align-center gap-3 pa-2" style="@(milestone.IsReached ? "background-color: rgba(76, 175, 80, 0.08); border-radius: 8px;" : "")">
                                            <MudIcon Icon="@(milestone.IsReached ? Icons.Material.Filled.CheckCircle : Icons.Material.Outlined.RadioButtonUnchecked)" 
                                                     Color="@(milestone.IsReached ? Color.Success : Color.Default)" 
                                                     Size="Size.Medium" />
                                            <div class="flex-grow-1">
                                                <MudText Typo="Typo.body1">
                                                    <strong>@milestone.Percentage%</strong> (@milestone.TargetAmount.ToString("C", SwedishCulture))
                                                </MudText>
                                                @if (!string.IsNullOrEmpty(milestone.Description))
                                                {
                                                    <MudText Typo="Typo.body2" Color="Color.Secondary">@milestone.Description</MudText>
                                                }
                                                @if (milestone.IsReached && milestone.ReachedAt.HasValue)
                                                {
                                                    <MudText Typo="Typo.caption" Color="Color.Success">
                                                        Uppnådd: @milestone.ReachedAt.Value.ToString("yyyy-MM-dd HH:mm")
                                                    </MudText>
                                                }
                                                else if (!milestone.IsReached)
                                                {
                                                    var remaining = milestone.TargetAmount - context.CurrentAmount;
                                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                        Återstår: @remaining.ToString("C", SwedishCulture)
                                                    </MudText>
                                                }
                                            </div>
                                        </div>
                                    }
                                </div>
                            </MudCardContent>
                        </MudCard>
                    </td>
                </MudTr>
            }
        </ChildRowContent>
    </MudTable>

    @if (!_goals.Any())
    {
        <EmptyState IconName="@Icons.Material.Filled.EmojiEvents"
                    IconColor="Color.Secondary"
                    Title="Inga sparmål än"
                    Description="Sätt upp sparmål för att hålla dig motiverad och följa din ekonomiska framgång. Välj målbelopp, deadline och prioritet."
                    ActionText="Skapa Ditt Första Sparmål"
                    ActionIcon="@Icons.Material.Filled.Add"
                    OnActionClick="ToggleCreateForm"
                    Class="mt-4" />
    }
}

@code {
    private static readonly System.Globalization.CultureInfo SwedishCulture = new System.Globalization.CultureInfo("sv-SE");
    
    private IEnumerable<Goal> _goals = new List<Goal>();
    private IEnumerable<BankSource> _bankSources = new List<BankSource>();
    private Dictionary<int, IEnumerable<GoalMilestone>> _goalMilestones = new();
    private HashSet<int> _expandedGoals = new();
    private bool _loading = true;
    private bool _showCreateForm = false;
    private Goal _formGoal = new();
    private DateTime? _formGoalTargetDate;
    private Goal? _editingGoal;

    private decimal _totalTargetAmount;
    private decimal _totalCurrentAmount;
    private double _averageProgress;

    protected override async Task OnInitializedAsync()
    {
        _loading = true;
        await LoadGoals();
        await LoadBankSources();
        await LoadMilestones();
        _loading = false;
    }

    private async Task LoadGoals()
    {
        _goals = await GoalService.GetAllGoalsAsync();
        
        _totalTargetAmount = _goals.Sum(g => g.TargetAmount);
        _totalCurrentAmount = _goals.Sum(g => g.CurrentAmount);
        _averageProgress = _goals.Any() ? _goals.Average(g => GetProgress(g)) : 0;
    }

    private async Task LoadBankSources()
    {
        _bankSources = await BankSourceService.GetAllBankSourcesAsync();
    }
    
    private async Task LoadMilestones()
    {
        _goalMilestones.Clear();
        foreach (var goal in _goals)
        {
            var milestones = await GoalMilestoneService.GetMilestonesByGoalIdAsync(goal.GoalId);
            _goalMilestones[goal.GoalId] = milestones;
        }
    }
    
    private void ToggleMilestones(int goalId)
    {
        if (_expandedGoals.Contains(goalId))
        {
            _expandedGoals.Remove(goalId);
        }
        else
        {
            _expandedGoals.Add(goalId);
        }
    }

    private void ToggleCreateForm()
    {
        _showCreateForm = !_showCreateForm;
        if (_showCreateForm)
        {
            _formGoal = new Goal { Priority = 3, CurrentAmount = 0 };
            _formGoalTargetDate = DateTime.Now.AddMonths(12);
            _editingGoal = null;
        }
    }

    private void EditGoal(Goal goal)
    {
        _editingGoal = goal;
        _formGoal = new Goal
        {
            GoalId = goal.GoalId,
            Name = goal.Name,
            Description = goal.Description,
            TargetAmount = goal.TargetAmount,
            CurrentAmount = goal.CurrentAmount,
            Priority = goal.Priority,
            FundedFromBankSourceId = goal.FundedFromBankSourceId,
            AutoSavingsType = goal.AutoSavingsType,
            MonthlyAutoSavingsAmount = goal.MonthlyAutoSavingsAmount
        };
        _formGoalTargetDate = goal.TargetDate;
        _showCreateForm = true;
    }

    private async Task OpenSimulationDialog(Goal goal)
    {
        var parameters = new DialogParameters<SavingsSimulationDialog>
        {
            { x => x.Goal, goal }
        };

        var options = new DialogOptions 
        { 
            MaxWidth = MaxWidth.Medium, 
            FullWidth = true,
            CloseButton = true 
        };

        var dialog = await DialogService.ShowAsync<SavingsSimulationDialog>("Simulera Sparande", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is decimal newMonthlySavings)
        {
            goal.MonthlyAutoSavingsAmount = newMonthlySavings;
            goal.AutoSavingsType = AutoSavingsType.FixedAmount;
            await GoalService.UpdateGoalAsync(goal);
            Snackbar.Add("Månatligt sparande har uppdaterats!", Severity.Success);
            await LoadGoals();
        }
    }

    private async Task SaveGoal()
    {
        try
        {
            _formGoal.TargetDate = _formGoalTargetDate;

            if (_editingGoal != null)
            {
                await GoalService.UpdateGoalAsync(_formGoal);
                Snackbar.Add("Sparmålet har uppdaterats!", Severity.Success);
            }
            else
            {
                await GoalService.CreateGoalAsync(_formGoal);
                Snackbar.Add("Sparmålet har lagts till!", Severity.Success);
            }

            await LoadGoals();
            await LoadMilestones();
            CancelForm();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ett fel uppstod: {ex.Message}", Severity.Error);
        }
    }

    private void CancelForm()
    {
        _showCreateForm = false;
        _formGoal = new();
        _formGoalTargetDate = null;
        _editingGoal = null;
    }

    private async Task DeleteGoal(int goalId)
    {
        bool? result = await DialogService.ShowMessageBoxAsync(
            "Bekräfta borttagning",
            "Är du säker på att du vill ta bort detta sparmål?",
            yesText: "Ja", cancelText: "Avbryt");

        if (result == true)
        {
            await GoalService.DeleteGoalAsync(goalId);
            Snackbar.Add("Sparmålet har tagits bort", Severity.Info);
            await LoadGoals();
            await LoadMilestones();
        }
    }

    private async Task MovePriorityUp(Goal goal)
    {
        if (goal.Priority > 1)
        {
            goal.Priority--;
            await GoalService.UpdateGoalAsync(goal);
            await LoadGoals();
            Snackbar.Add($"Prioriteten för {goal.Name} har ökats!", Severity.Success);
        }
    }

    private async Task MovePriorityDown(Goal goal)
    {
        if (goal.Priority < 5)
        {
            goal.Priority++;
            await GoalService.UpdateGoalAsync(goal);
            await LoadGoals();
            Snackbar.Add($"Prioriteten för {goal.Name} har minskats!", Severity.Info);
        }
    }

    private double GetProgress(Goal goal)
    {
        if (goal.TargetAmount == 0) return 0;
        return Math.Min(100, (double)(goal.CurrentAmount / goal.TargetAmount * 100));
    }

    private Color GetProgressColor(Goal goal)
    {
        var progress = GetProgress(goal);
        if (progress >= 100) return Color.Success;
        if (progress >= 75) return Color.Info;
        if (progress >= 50) return Color.Primary;
        if (progress >= 25) return Color.Warning;
        return Color.Error;
    }

    private Color GetPriorityColor(int priority)
    {
        return priority switch
        {
            1 => Color.Error,
            2 => Color.Warning,
            3 => Color.Primary,
            4 => Color.Info,
            5 => Color.Default,
            _ => Color.Default
        };
    }
}
