@using MudBlazor
@inject IBudgetService BudgetService
@inject IBudgetAlertService BudgetAlertService
@inject ICategoryService CategoryService
@inject ITransactionService TransactionService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Medium" Class="onboarding-step">
    <MudPaper Elevation="3" Class="pa-8">
        <MudText Typo="Typo.h4" GutterBottom="true" Class="mb-2">
            <MudIcon Icon="@Icons.Material.Filled.PieChart" Color="Color.Primary" Class="mr-2" />
            Ditt budgetförslag
        </MudText>
        
        <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-6">
            Baserat på 50/30/20-regeln har vi skapat ett budgetförslag åt dig
        </MudText>
        
        <MudDivider Class="mb-6" />
        
        @if (_loading)
        {
            <div class="d-flex justify-center pa-6">
                <MudProgressCircular Indeterminate="true" />
            </div>
        }
        else
        {
            <MudAlert Severity="Severity.Info" Class="mb-4">
                <MudText Typo="Typo.body2">
                    <strong>50/30/20-regeln:</strong> 50% Behov (boende, mat, transport), 
                    30% Önskemål (nöje, shopping), 20% Sparande
                </MudText>
            </MudAlert>
            
            <MudPaper Elevation="0" Class="pa-4 mb-4" Style="background-color: var(--mud-palette-background-grey);">
                <MudText Typo="Typo.subtitle1" Class="mb-2">Ange din månadsinkomst:</MudText>
                <MudNumericField @bind-Value="_monthlyIncome"
                                Label="Månadsinkomst (netto)"
                                Variant="Variant.Outlined"
                                Format="N0"
                                Culture="@(new System.Globalization.CultureInfo("sv-SE"))"
                                Adornment="Adornment.Start"
                                AdornmentText="kr"
                                Min="0"
                                Step="1000M"
                                OnBlur="RecalculateBudget"
                                Class="mb-3" />
                
                <MudGrid Spacing="2" Class="mb-4">
                    <MudItem xs="12" md="4">
                        <MudCard Elevation="0" Style="background-color: #e3f2fd;">
                            <MudCardContent Class="pa-3">
                                <MudText Typo="Typo.body2" Color="Color.Primary">
                                    <strong>Behov (50%)</strong>
                                </MudText>
                                <MudText Typo="Typo.h6">
                                    @(_monthlyIncome * 0.50m).ToString("C", new System.Globalization.CultureInfo("sv-SE"))
                                </MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudCard Elevation="0" Style="background-color: #fff3e0;">
                            <MudCardContent Class="pa-3">
                                <MudText Typo="Typo.body2" Color="Color.Warning">
                                    <strong>Önskemål (30%)</strong>
                                </MudText>
                                <MudText Typo="Typo.h6">
                                    @(_monthlyIncome * 0.30m).ToString("C", new System.Globalization.CultureInfo("sv-SE"))
                                </MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudCard Elevation="0" Style="background-color: #e8f5e9;">
                            <MudCardContent Class="pa-3">
                                <MudText Typo="Typo.body2" Color="Color.Success">
                                    <strong>Sparande (20%)</strong>
                                </MudText>
                                <MudText Typo="Typo.h6">
                                    @(_monthlyIncome * 0.20m).ToString("C", new System.Globalization.CultureInfo("sv-SE"))
                                </MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                </MudGrid>
            </MudPaper>
            
            <MudText Typo="Typo.h6" GutterBottom="true" Class="mb-3">
                Detaljerad budgetfördelning
            </MudText>
            
            <MudSimpleTable Dense="true" Hover="true" Class="mb-4">
                <thead>
                    <tr>
                        <th>Kategori</th>
                        <th style="text-align: right;">Förslag</th>
                        <th style="text-align: center;">Justera</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var category in _budgetCategories)
                    {
                        <tr>
                            <td>
                                <MudIcon Icon="@GetCategoryIcon(category.Name)" Size="Size.Small" Class="mr-2" />
                                @category.Name
                            </td>
                            <td style="text-align: right;">
                                @category.Amount.ToString("C", new System.Globalization.CultureInfo("sv-SE"))
                            </td>
                            <td style="text-align: center;">
                                <MudSlider T="decimal" 
                                           @bind-Value="category.Amount" 
                                           Min="0" 
                                           Max="@(_monthlyIncome * 0.5m)"
                                           Step="100"
                                           ValueLabel="true"
                                           Size="Size.Small"
                                           Style="width: 150px;" />
                            </td>
                        </tr>
                    }
                </tbody>
            </MudSimpleTable>
            
            <MudCheckBox @bind-Value="_enableBudgetAlerts" Color="Color.Primary" Class="mb-4">
                <MudText Typo="Typo.body2">
                    Aktivera budgetvarningar när jag närmar mig gränsen för en kategori
                </MudText>
            </MudCheckBox>
            
            <MudAlert Severity="Severity.Warning" Class="mb-4">
                <MudText Typo="Typo.body2">
                    <strong>Viktigt:</strong> Detta är ett förslag baserat på 50/30/20-regeln. 
                    Du kan justera beloppen ovan eller ändra dem senare under Budget-sektionen.
                </MudText>
            </MudAlert>
            
            <div class="d-flex justify-space-between">
                <MudButton Variant="Variant.Text" 
                           Color="Color.Default"
                           OnClick="SkipBudget">
                    Hoppa över, konfigurera senare
                </MudButton>
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary"
                           OnClick="SaveBudget"
                           Disabled="_saving">
                    @if (_saving)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    }
                    Spara och aktivera budget
                </MudButton>
            </div>
        }
    </MudPaper>
</MudContainer>

@code {
    [Parameter]
    public EventCallback OnNext { get; set; }

    private bool _loading = true;
    private bool _saving = false;
    private decimal _monthlyIncome = 30000m;
    private List<BudgetCategoryItem> _budgetCategories = new();
    private Dictionary<string, int> _categoryNameToId = new();
    private bool _enableBudgetAlerts = true;

    private class BudgetCategoryItem
    {
        public string Name { get; set; } = "";
        public decimal Amount { get; set; }
        public int CategoryId { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Try to estimate income from imported transactions
            await EstimateIncomeFromHistory();
            
            // Load actual categories from the database
            var categories = await CategoryService.GetAllCategoriesAsync();
            _categoryNameToId = categories.ToDictionary(c => c.Name.ToLower(), c => c.CategoryId);
            
            // Create budget proposal based on 50/30/20 rule
            CreateBudgetProposal();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Kunde inte ladda data: {ex.Message}", MudBlazor.Severity.Error);
            // Fall back to default budget
            CreateBudgetProposal();
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task EstimateIncomeFromHistory()
    {
        try
        {
            var endDate = DateTime.Today;
            var startDate = endDate.AddMonths(-3);
            var transactions = await TransactionService.GetTransactionsByDateRangeAsync(startDate, endDate);
            var incomeTransactions = transactions.Where(t => t.IsIncome);
            
            if (incomeTransactions.Any())
            {
                _monthlyIncome = Math.Round(incomeTransactions.Sum(t => t.Amount) / 3, 0);
            }
        }
        catch
        {
            // Keep default if estimation fails
        }
    }

    private void CreateBudgetProposal()
    {
        _budgetCategories = new List<BudgetCategoryItem>
        {
            // Needs (50%)
            new BudgetCategoryItem { Name = "Boende", Amount = _monthlyIncome * 0.50m * 0.40m, CategoryId = GetCategoryId("boende") },
            new BudgetCategoryItem { Name = "Mat & Dryck", Amount = _monthlyIncome * 0.50m * 0.35m, CategoryId = GetCategoryId("mat & dryck") },
            new BudgetCategoryItem { Name = "Transport", Amount = _monthlyIncome * 0.50m * 0.15m, CategoryId = GetCategoryId("transport") },
            new BudgetCategoryItem { Name = "Hälsa", Amount = _monthlyIncome * 0.50m * 0.10m, CategoryId = GetCategoryId("hälsa") },
            
            // Wants (30%)
            new BudgetCategoryItem { Name = "Nöje", Amount = _monthlyIncome * 0.30m * 0.50m, CategoryId = GetCategoryId("nöje") },
            new BudgetCategoryItem { Name = "Shopping", Amount = _monthlyIncome * 0.30m * 0.30m, CategoryId = GetCategoryId("shopping") },
            new BudgetCategoryItem { Name = "Restaurang", Amount = _monthlyIncome * 0.30m * 0.20m, CategoryId = GetCategoryId("restaurang") },
            
            // Savings (20%)
            new BudgetCategoryItem { Name = "Sparande", Amount = _monthlyIncome * 0.20m, CategoryId = GetCategoryId("sparande") }
        };
    }

    private int GetCategoryId(string categoryName)
    {
        if (_categoryNameToId.TryGetValue(categoryName, out var id))
        {
            return id;
        }
        // Return 0 if category not found - will be filtered out when creating budget
        return 0;
    }

    private void RecalculateBudget()
    {
        CreateBudgetProposal();
    }

    private string GetCategoryIcon(string categoryName)
    {
        return categoryName.ToLower() switch
        {
            var s when s.Contains("boende") => Icons.Material.Filled.Home,
            var s when s.Contains("mat") => Icons.Material.Filled.Restaurant,
            var s when s.Contains("transport") => Icons.Material.Filled.DirectionsCar,
            var s when s.Contains("hälsa") => Icons.Material.Filled.Security,
            var s when s.Contains("nöje") => Icons.Material.Filled.Celebration,
            var s when s.Contains("shopping") => Icons.Material.Filled.ShoppingBag,
            var s when s.Contains("restaurang") => Icons.Material.Filled.Restaurant,
            var s when s.Contains("sparande") => Icons.Material.Filled.Savings,
            _ => Icons.Material.Filled.Category
        };
    }

    private async Task SaveBudget()
    {
        if (_monthlyIncome <= 0)
        {
            Snackbar.Add("Ange en månadsinkomst för att skapa en budget", MudBlazor.Severity.Warning);
            return;
        }

        _saving = true;
        try
        {
            // Calculate start and end date for current month
            var now = DateTime.Now;
            var startDate = new DateTime(now.Year, now.Month, 1);
            var endDate = startDate.AddMonths(1).AddDays(-1);

            // Create budget entity
            var budget = new Budget
            {
                Name = $"Budget {startDate:yyyy-MM}",
                Description = "Budget skapad via onboarding med 50/30/20-regeln",
                StartDate = startDate,
                EndDate = endDate,
                Period = BudgetPeriod.Monthly,
                TemplateType = BudgetTemplateType.FiftyThirtyTwenty,
                BudgetCategories = _budgetCategories
                    .Where(bc => bc.CategoryId > 0 && bc.Amount > 0)
                    .Select(bc => new BudgetCategory
                    {
                        CategoryId = bc.CategoryId,
                        PlannedAmount = bc.Amount,
                        RecurrencePeriodMonths = 1
                    })
                    .ToList()
            };

            // Save budget
            await BudgetService.CreateBudgetAsync(budget);

            // Enable budget alerts if selected
            if (_enableBudgetAlerts)
            {
                var settings = await BudgetAlertService.GetOrCreateSettingsAsync();
                settings.EnableAlert75 = true;
                settings.EnableAlert90 = true;
                settings.EnableAlert100 = true;
                settings.EnableForecastWarnings = true;
                await BudgetAlertService.UpdateSettingsAsync(settings);
            }

            Snackbar.Add("Budget skapad! Du kan justera den senare under Budget.", MudBlazor.Severity.Success);
            await Task.Delay(500);
            await OnNext.InvokeAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ett fel uppstod vid skapande av budget: {ex.Message}", MudBlazor.Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private void SkipBudget()
    {
        Snackbar.Add("Budget överhoppad. Du kan skapa en senare.", MudBlazor.Severity.Info);
        OnNext.InvokeAsync();
    }
}
