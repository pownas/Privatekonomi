@page "/investments"
@rendermode InteractiveServer
@inject IInvestmentService InvestmentService
@inject IStockPriceService StockPriceService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Aktier & Fonder - Privatekonomi</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Aktier & Fonder</MudText>

@if (_loading)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else
{
    <!-- Summary Cards -->
    <MudGrid Class="mb-4">
        <MudItem xs="12" md="6" lg="3">
            <MudCard Elevation="2" Class="pa-4">
                <MudCardContent>
                    <div class="d-flex align-center justify-space-between">
                        <div>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Totalt Värde</MudText>
                            <MudText Typo="Typo.h4" Color="Color.Info">@_totalValue.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))</MudText>
                        </div>
                        <MudIcon Icon="@Icons.Material.Filled.AccountBalance" Size="Size.Large" Color="Color.Info" />
                    </div>
                </MudCardContent>
            </MudCard>
        </MudItem>
        
        <MudItem xs="12" md="6" lg="3">
            <MudCard Elevation="2" Class="pa-4">
                <MudCardContent>
                    <div class="d-flex align-center justify-space-between">
                        <div>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Total Kostnad</MudText>
                            <MudText Typo="Typo.h4">@_totalCost.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))</MudText>
                        </div>
                        <MudIcon Icon="@Icons.Material.Filled.ShoppingCart" Size="Size.Large" Color="Color.Default" />
                    </div>
                </MudCardContent>
            </MudCard>
        </MudItem>
        
        <MudItem xs="12" md="6" lg="3">
            <MudCard Elevation="2" Class="pa-4">
                <MudCardContent>
                    <div class="d-flex align-center justify-space-between">
                        <div>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Vinst/Förlust</MudText>
                            <MudText Typo="Typo.h4" Color="@(_totalProfitLoss >= 0 ? Color.Success : Color.Error)">
                                @(_totalProfitLoss >= 0 ? "+" : "")@_totalProfitLoss.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))
                            </MudText>
                        </div>
                        <MudIcon Icon="@(_totalProfitLoss >= 0 ? Icons.Material.Filled.TrendingUp : Icons.Material.Filled.TrendingDown)" 
                                 Size="Size.Large" 
                                 Color="@(_totalProfitLoss >= 0 ? Color.Success : Color.Error)" />
                    </div>
                </MudCardContent>
            </MudCard>
        </MudItem>
        
        <MudItem xs="12" md="6" lg="3">
            <MudCard Elevation="2" Class="pa-4">
                <MudCardContent>
                    <div class="d-flex align-center justify-space-between">
                        <div>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Avkastning</MudText>
                            <MudText Typo="Typo.h4" Color="@(_totalProfitLossPercentage >= 0 ? Color.Success : Color.Error)">
                                @(_totalProfitLossPercentage >= 0 ? "+" : "")@_totalProfitLossPercentage.ToString("F2")%
                            </MudText>
                        </div>
                        <MudIcon Icon="@Icons.Material.Filled.Percent" Size="Size.Large" 
                                 Color="@(_totalProfitLossPercentage >= 0 ? Color.Success : Color.Error)" />
                    </div>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    <!-- Statistics by Type -->
    @if (_investments.Any())
    {
        <MudGrid Class="mb-4">
            @foreach (var stat in _typeStats.OrderByDescending(s => s.Value))
            {
                <MudItem xs="12" sm="6" md="4">
                    <MudCard Elevation="1">
                        <MudCardContent>
                            <div class="d-flex justify-space-between align-center mb-2">
                                <MudChip T="string" Size="Size.Small" Color="@GetTypeColor(stat.Key)">@stat.Key</MudChip>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    @((stat.Value / _totalValue * 100).ToString("F1"))%
                                </MudText>
                            </div>
                            <MudText Typo="Typo.h6">@stat.Value.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))</MudText>
                            <MudProgressLinear Value="@((double)(stat.Value / _totalValue * 100))" 
                                             Color="@GetTypeColor(stat.Key)" 
                                             Size="Size.Small" Class="mt-2" />
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }

    <!-- Investments Table -->
    <MudPaper Class="pa-4">
        <MudGrid>
            <MudItem xs="12" Class="d-flex justify-space-between align-center mb-4">
                <MudText Typo="Typo.h6">Mina Investeringar (@_filteredInvestments.Count() st)</MudText>
                <div class="d-flex gap-2 flex-wrap">
                    <MudButton Variant="Variant.Outlined" Color="Color.Success" StartIcon="@Icons.Material.Filled.Refresh" 
                               OnClick="UpdateAllPrices" Disabled="!_investments.Any() || _isUpdatingAll" Size="Size.Small">
                        @if (_isUpdatingAll)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>Uppdaterar...</span>
                        }
                        else
                        {
                            <span>Uppdatera alla kurser</span>
                        }
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.CloudDownload" 
                               OnClick="ExportToCSV" Disabled="!_investments.Any()" Size="Size.Small">
                        Exportera
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Upload" 
                               Href="/import-investments" Size="Size.Small">
                        Importera
                    </MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" 
                               OnClick="OpenAddDialog" Size="Size.Small">
                        Lägg till
                    </MudButton>
                </div>
            </MudItem>
        </MudGrid>

        @if (!_investments.Any())
        {
            <MudText>Inga investeringar ännu. Lägg till din första aktie eller fond!</MudText>
        }
        else
        {
            <MudTable Items="@_filteredInvestments" Hover="true" Striped="true" Filter="new Func<Investment,bool>(FilterFunc)"
                      SortLabel="Sortera">
                <ToolBarContent>
                    <MudTextField @bind-Value="_searchString" Placeholder="Sök" Adornment="Adornment.Start" 
                                  AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
                    <MudSpacer />
                    <MudSelect T="int?" Value="_filterBankId" Label="Bank" Clearable="true" 
                               Variant="Variant.Outlined" Margin="Margin.Dense" Class="ml-2" Style="min-width: 150px;"
                               ValueChanged="@((int? value) => { _filterBankId = value; ApplyFilters(); })">
                        @foreach (var bank in _banks)
                        {
                            <MudSelectItem Value="@((int?)bank.BankSourceId)">@bank.Name</MudSelectItem>
                        }
                    </MudSelect>
                    <MudSelect T="string" Value="_filterAccount" Label="Konto" Clearable="true" 
                               Variant="Variant.Outlined" Margin="Margin.Dense" Class="ml-2" Style="min-width: 150px;"
                               ValueChanged="@((string value) => { _filterAccount = value; ApplyFilters(); })">
                        @foreach (var account in _accounts)
                        {
                            <MudSelectItem Value="@account">@account</MudSelectItem>
                        }
                    </MudSelect>
                </ToolBarContent>
                <HeaderContent>
                    <MudTh><MudTableSortLabel SortBy="new Func<Investment, object>(x => x.Name)">Namn</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel SortBy="new Func<Investment, object>(x => x.Type)">Typ</MudTableSortLabel></MudTh>
                    <MudTh>Bank</MudTh>
                    <MudTh>Konto</MudTh>
                    <MudTh Style="text-align: right"><MudTableSortLabel SortBy="new Func<Investment, object>(x => x.Quantity)">Antal</MudTableSortLabel></MudTh>
                    <MudTh Style="text-align: right"><MudTableSortLabel SortBy="new Func<Investment, object>(x => x.PurchasePrice)">Köpkurs</MudTableSortLabel></MudTh>
                    <MudTh Style="text-align: right"><MudTableSortLabel SortBy="new Func<Investment, object>(x => x.CurrentPrice)">Aktuell kurs</MudTableSortLabel></MudTh>
                    <MudTh Style="text-align: right"><MudTableSortLabel SortBy="new Func<Investment, object>(x => x.TotalValue)">Värde</MudTableSortLabel></MudTh>
                    <MudTh Style="text-align: right"><MudTableSortLabel SortBy="new Func<Investment, object>(x => x.ProfitLoss)">Vinst/Förlust</MudTableSortLabel></MudTh>
                    <MudTh Style="text-align: right"><MudTableSortLabel SortBy="new Func<Investment, object>(x => x.ProfitLossPercentage)">%</MudTableSortLabel></MudTh>
                    <MudTh Style="text-align: center">Åtgärder</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Namn">
                        <div>
                            <MudText Typo="Typo.body2">@context.Name</MudText>
                            @if (!string.IsNullOrEmpty(context.ShortName))
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@context.ShortName</MudText>
                            }
                        </div>
                    </MudTd>
                    <MudTd DataLabel="Typ">
                        <MudChip T="string" Size="Size.Small" Color="@GetTypeColor(context.Type)">
                            @context.Type
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Bank">
                        @if (context.BankSource != null)
                        {
                            <MudChip T="string" Size="Size.Small" Style="@($"background-color: {context.BankSource.Color}; color: white;")">
                                @context.BankSource.Name
                            </MudChip>
                        }
                    </MudTd>
                    <MudTd DataLabel="Konto">
                        @if (!string.IsNullOrEmpty(context.AccountNumber))
                        {
                            <MudText Typo="Typo.body2">@context.AccountNumber</MudText>
                        }
                    </MudTd>
                    <MudTd DataLabel="Antal" Style="text-align: right">@context.Quantity.ToString("N2")</MudTd>
                    <MudTd DataLabel="Köpkurs" Style="text-align: right">@context.PurchasePrice.ToString("C", new System.Globalization.CultureInfo("sv-SE"))</MudTd>
                    <MudTd DataLabel="Aktuell kurs" Style="text-align: right">
                        <div class="d-flex align-center justify-end gap-1">
                            <MudText>@context.CurrentPrice.ToString("C", new System.Globalization.CultureInfo("sv-SE"))</MudText>
                        </div>
                    </MudTd>
                    <MudTd DataLabel="Värde" Style="text-align: right">
                        <MudText Typo="Typo.body2" Style="font-weight: 500">@context.TotalValue.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))</MudText>
                    </MudTd>
                    <MudTd DataLabel="Vinst/Förlust" Style="text-align: right">
                        <MudText Color="@(context.ProfitLoss >= 0 ? Color.Success : Color.Error)" Style="font-weight: 500">
                            @(context.ProfitLoss >= 0 ? "+" : "")@context.ProfitLoss.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))
                        </MudText>
                    </MudTd>
                    <MudTd DataLabel="%" Style="text-align: right">
                        <MudText Color="@(context.ProfitLossPercentage >= 0 ? Color.Success : Color.Error)" Style="font-weight: 500">
                            @(context.ProfitLossPercentage >= 0 ? "+" : "")@context.ProfitLossPercentage.ToString("F2")%
                        </MudText>
                    </MudTd>
                    <MudTd DataLabel="Åtgärder" Style="text-align: center">
                        <MudTooltip Text="Uppdatera kurs">
                            <MudIconButton Icon="@Icons.Material.Filled.Refresh" Color="Color.Success" Size="Size.Small"
                                           OnClick="@(() => UpdateSinglePrice(context))" 
                                           Disabled="@_updatingInvestments.Contains(context.InvestmentId)" />
                        </MudTooltip>
                        <MudTooltip Text="Ändra kurs manuellt">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Default" Size="Size.Small"
                                           OnClick="@(() => OpenQuickPriceUpdate(context))" />
                        </MudTooltip>
                        <MudTooltip Text="Redigera">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Default" Size="Size.Small"
                                           OnClick="@(() => OpenEditDialog(context))" />
                        </MudTooltip>
                        <MudTooltip Text="Ta bort">
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                                           OnClick="@(() => DeleteInvestment(context.InvestmentId))" />
                        </MudTooltip>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
    </MudPaper>
}

@inject IBankSourceService BankSourceService
@inject IJSRuntime JS
@using System.Text

@code {
    private bool _loading = true;
    private bool _isUpdatingAll = false;
    private HashSet<int> _updatingInvestments = new();
    private IEnumerable<Investment> _investments = new List<Investment>();
    private IEnumerable<Investment> _filteredInvestments = new List<Investment>();
    private List<BankSource> _banks = new();
    private List<string> _accounts = new();
    private string _searchString = "";
    private int? _filterBankId = null;
    private string? _filterAccount = null;
    
    private decimal _totalValue = 0;
    private decimal _totalCost = 0;
    private decimal _totalProfitLoss = 0;
    private decimal _totalProfitLossPercentage = 0;
    private Dictionary<string, decimal> _typeStats = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;
        _investments = await InvestmentService.GetAllInvestmentsAsync();
        _banks = (await BankSourceService.GetAllBankSourcesAsync()).ToList();
        _accounts = _investments
            .Where(i => !string.IsNullOrEmpty(i.AccountNumber))
            .Select(i => i.AccountNumber!)
            .Distinct()
            .OrderBy(a => a)
            .ToList();
        
        ApplyFilters();
        CalculateTotals();
        CalculateTypeStats();
        _loading = false;
    }

    private void ApplyFilters()
    {
        _filteredInvestments = _investments;
        
        if (_filterBankId.HasValue)
        {
            _filteredInvestments = _filteredInvestments.Where(i => i.BankSourceId == _filterBankId.Value);
        }
        
        if (!string.IsNullOrEmpty(_filterAccount))
        {
            _filteredInvestments = _filteredInvestments.Where(i => i.AccountNumber == _filterAccount);
        }
        
        CalculateTotals();
        StateHasChanged();
    }

    private void CalculateTotals()
    {
        _totalValue = _filteredInvestments.Sum(i => i.TotalValue);
        _totalCost = _filteredInvestments.Sum(i => i.TotalCost);
        _totalProfitLoss = _totalValue - _totalCost;
        _totalProfitLossPercentage = _totalCost > 0 ? (_totalProfitLoss / _totalCost) * 100 : 0;
    }

    private void CalculateTypeStats()
    {
        _typeStats = _investments
            .GroupBy(i => i.Type)
            .ToDictionary(g => g.Key, g => g.Sum(i => i.TotalValue));
    }

    private bool FilterFunc(Investment investment)
    {
        if (string.IsNullOrWhiteSpace(_searchString))
            return true;
        if (investment.Name.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (investment.Type.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (investment.ShortName?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true)
            return true;
        if (investment.BankSource?.Name.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true)
            return true;
        if (investment.AccountNumber?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true)
            return true;
        return false;
    }

    private Color GetTypeColor(string type)
    {
        return type switch
        {
            "Aktie" => Color.Primary,
            "Fond" => Color.Secondary,
            "Certifikat" => Color.Warning,
            _ => Color.Default
        };
    }

    private async Task ExportToCSV()
    {
        try
        {
            var csvContent = await InvestmentService.ExportToCsvAsync(_filteredInvestments);
            var bytes = Encoding.UTF8.GetBytes(csvContent);
            var base64 = Convert.ToBase64String(bytes);
            var fileName = $"investeringar_{DateTime.Now:yyyyMMdd}.csv";
            
            await JS.InvokeVoidAsync("downloadFile", fileName, "text/csv", base64);
            Snackbar.Add("Export slutförd!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ett fel uppstod vid export: {ex.Message}", Severity.Error);
        }
    }

    private async Task OpenQuickPriceUpdate(Investment investment)
    {
        var parameters = new DialogParameters
        {
            { "ContentText", $"Uppdatera aktuell kurs för {investment.Name}" },
            { "ButtonText", "Uppdatera" },
            { "Color", Color.Primary }
        };

        var options = new DialogOptions() { CloseButton = true };
        var dialog = await DialogService.ShowAsync<QuickPriceUpdateDialog>($"Uppdatera kurs", parameters, options);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled && result.Data is decimal newPrice && newPrice > 0)
        {
            investment.CurrentPrice = newPrice;
            investment.LastUpdated = DateTime.Now;
            await InvestmentService.UpdateInvestmentAsync(investment);
            Snackbar.Add("Kurs uppdaterad", Severity.Success);
            await LoadData();
        }
    }

    private async Task OpenAddDialog()
    {
        var parameters = new DialogParameters<InvestmentDialog>
        {
            { x => x.Investment, new Investment { PurchaseDate = DateTime.Now, LastUpdated = DateTime.Now } }
        };

        var dialog = await DialogService.ShowAsync<InvestmentDialog>("Lägg till investering", parameters);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled && result.Data is Investment investment)
        {
            await InvestmentService.AddInvestmentAsync(investment);
            Snackbar.Add("Investering tillagd", Severity.Success);
            await LoadData();
        }
    }

    private async Task OpenEditDialog(Investment investment)
    {
        var parameters = new DialogParameters<InvestmentDialog>
        {
            { x => x.Investment, new Investment
                {
                    InvestmentId = investment.InvestmentId,
                    Name = investment.Name,
                    Type = investment.Type,
                    Quantity = investment.Quantity,
                    PurchasePrice = investment.PurchasePrice,
                    CurrentPrice = investment.CurrentPrice,
                    PurchaseDate = investment.PurchaseDate,
                    LastUpdated = investment.LastUpdated
                }
            },
            { x => x.IsEdit, true }
        };

        var dialog = await DialogService.ShowAsync<InvestmentDialog>("Redigera investering", parameters);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled && result.Data is Investment updatedInvestment)
        {
            await InvestmentService.UpdateInvestmentAsync(updatedInvestment);
            Snackbar.Add("Investering uppdaterad", Severity.Success);
            await LoadData();
        }
    }

    private async Task DeleteInvestment(int id)
    {
        var result = await DialogService.ShowMessageBox(
            "Bekräfta borttagning",
            "Är du säker på att du vill ta bort denna investering?",
            yesText: "Ja", cancelText: "Avbryt");

        if (result == true)
        {
            await InvestmentService.DeleteInvestmentAsync(id);
            Snackbar.Add("Investering borttagen", Severity.Success);
            await LoadData();
        }
    }

    private async Task UpdateAllPrices()
    {
        var parameters = new DialogParameters<UpdateAllPricesDialog>
        {
            { x => x.Investments, _filteredInvestments }
        };

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<UpdateAllPricesDialog>("Uppdatera alla kurser", parameters, options);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled)
        {
            Snackbar.Add("Kurser uppdaterade", Severity.Success);
            await LoadData();
        }
    }

    private async Task UpdateSinglePrice(Investment investment)
    {
        _updatingInvestments.Add(investment.InvestmentId);
        StateHasChanged();

        try
        {
            var success = await StockPriceService.UpdatePriceAsync(investment);
            
            if (success)
            {
                Snackbar.Add($"Kurs uppdaterad för {investment.Name}", Severity.Success);
                await LoadData();
            }
            else
            {
                Snackbar.Add($"Kunde inte uppdatera kurs för {investment.Name}. Kontrollera att ticker-symbolen är korrekt.", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fel vid uppdatering: {ex.Message}", Severity.Error);
        }
        finally
        {
            _updatingInvestments.Remove(investment.InvestmentId);
            StateHasChanged();
        }
    }
}
