@page "/family/households"
@page "/households"
@using Privatekonomi.Core.Models
@using Privatekonomi.Core.Services
@inject IHouseholdService HouseholdService
@inject NavigationManager NavigationManager

<PageTitle>Hushåll</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">
    <MudIcon Icon="@Icons.Material.Filled.Group" Color="Color.Primary" Class="mr-2" aria-hidden="true" />
    Hushåll
</MudText>

<MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="OpenCreateDialog" Class="mb-4">
    Skapa nytt hushåll
</MudButton>

<MudGrid>
    @if (households == null)
    {
        <MudItem xs="12">
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
        </MudItem>
    }
    else if (!households.Any())
    {
        <MudItem xs="12">
            <MudAlert Severity="Severity.Info">
                Inga hushåll finns än. Skapa ditt första hushåll för att börja hantera delade boendekostnader.
            </MudAlert>
        </MudItem>
    }
    else
    {
        @foreach (var household in households)
        {
            <MudItem xs="12" sm="6" md="4">
                <MudCard>
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">@household.Name</MudText>
                        </CardHeaderContent>
                        <CardHeaderActions>
                            <MudMenu Icon="@Icons.Material.Filled.MoreVert" Color="Color.Default" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
                                <MudMenuItem OnClick="@(() => OpenEditDialog(household))">
                                    <MudIcon Icon="@Icons.Material.Filled.Edit" Class="mr-2" Size="Size.Small" />
                                    Redigera namn
                                </MudMenuItem>
                                <MudMenuItem OnClick="@(() => DeleteHousehold(household.HouseholdId))">
                                    <MudIcon Icon="@Icons.Material.Filled.Delete" Class="mr-2" Size="Size.Small" Color="Color.Error" />
                                    <MudText Color="Color.Error">Ta bort</MudText>
                                </MudMenuItem>
                            </MudMenu>
                        </CardHeaderActions>
                    </MudCardHeader>
                    <MudCardContent>
                        @if (!string.IsNullOrEmpty(household.Description))
                        {
                            <MudText Typo="Typo.body2" Class="mb-2">@household.Description</MudText>
                        }
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Small" /> @household.Members.Count medlem(mar)
                        </MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            <MudIcon Icon="@Icons.Material.Filled.Receipt" Size="Size.Small" /> @household.SharedExpenses.Count utgift(er)
                        </MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
                            Skapad: @household.CreatedDate.ToString("yyyy-MM-dd")
                        </MudText>
                    </MudCardContent>
                    <MudCardActions>
                        <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => ViewHousehold(household.HouseholdId))">
                            Visa detaljer
                        </MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>
        }
    }
</MudGrid>

<MudDialog @bind-Visible="showCreateDialog" Options="dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">Skapa nytt hushåll</MudText>
    </TitleContent>
    <DialogContent>
        <MudTextField @bind-Value="newHousehold.Name" Label="Namn" Required="true" />
        <MudTextField @bind-Value="newHousehold.Description" Label="Beskrivning" Lines="3" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseCreateDialog">Avbryt</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="CreateHousehold">Skapa</MudButton>
    </DialogActions>
</MudDialog>

<MudDialog @bind-Visible="showEditDialog" Options="dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">Redigera hushåll</MudText>
    </TitleContent>
    <DialogContent>
        <MudTextField @bind-Value="editHousehold.Name" Label="Namn" Required="true" />
        <MudTextField @bind-Value="editHousehold.Description" Label="Beskrivning" Lines="3" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseEditDialog">Avbryt</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="UpdateHousehold">Spara</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private List<Household>? households;
    private bool showCreateDialog = false;
    private bool showEditDialog = false;
    private Household newHousehold = new Household();
    private Household editHousehold = new Household();
    private DialogOptions dialogOptions = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };

    protected override async Task OnInitializedAsync()
    {
        await LoadHouseholds();
    }

    private async Task LoadHouseholds()
    {
        var result = await HouseholdService.GetAllHouseholdsAsync();
        households = result.ToList();
    }

    private void OpenCreateDialog()
    {
        newHousehold = new Household();
        showCreateDialog = true;
    }

    private void CloseCreateDialog()
    {
        showCreateDialog = false;
    }

    private async Task CreateHousehold()
    {
        if (string.IsNullOrWhiteSpace(newHousehold.Name))
            return;

        await HouseholdService.CreateHouseholdAsync(newHousehold);
        await LoadHouseholds();
        CloseCreateDialog();
    }

    private void OpenEditDialog(Household household)
    {
        editHousehold = new Household
        {
            HouseholdId = household.HouseholdId,
            Name = household.Name,
            Description = household.Description,
            CreatedDate = household.CreatedDate
        };
        showEditDialog = true;
    }

    private void CloseEditDialog()
    {
        showEditDialog = false;
    }

    private async Task UpdateHousehold()
    {
        if (string.IsNullOrWhiteSpace(editHousehold.Name))
            return;

        await HouseholdService.UpdateHouseholdAsync(editHousehold);
        await LoadHouseholds();
        CloseEditDialog();
    }

    private void ViewHousehold(int householdId)
    {
        NavigationManager.NavigateTo($"/family/households/{householdId}");
    }

    private async Task DeleteHousehold(int householdId)
    {
        await HouseholdService.DeleteHouseholdAsync(householdId);
        await LoadHouseholds();
    }
}
