@page "/investments/loans"
@page "/loans"
@rendermode InteractiveServer
@inject ILoanService LoanService
@inject IDebtStrategyService DebtStrategyService
@inject IMortgageAnalysisService MortgageAnalysisService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@using Privatekonomi.Core.Models

<PageTitle>L√•n & Krediter - Privatekonomi</PageTitle>

<div class="page-header mb-4">
    <MudText Typo="Typo.h4">
        <MudIcon Icon="@Icons.Material.Filled.CreditCard" Color="Color.Primary" Class="mr-2" aria-hidden="true" />
        L√•n & Krediter
    </MudText>
    <div class="page-header-buttons">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="ToggleCreateForm">
            Nytt L√•n/Kredit
        </MudButton>
    </div>
</div>

@if (_showCreateForm)
{
    <MudPaper Class="pa-4 mb-4">
        <MudText Typo="Typo.h6" Class="mb-3">@(_editingLoan != null ? "Redigera L√•n/Kredit" : "L√§gg till Nytt L√•n/Kredit")</MudText>
        
        <MudTextField @bind-Value="_formLoan.Name" 
                      Label="Namn" 
                      Variant="Variant.Outlined"
                      Required="true"
                      MaxLength="200"
                      Class="mb-3" />
        
        <MudRadioGroup @bind-Value="_formLoan.Type" Required="true">
            <MudText Typo="Typo.subtitle2" Class="mb-2">Typ</MudText>
            <MudRadio Value="@("Bol√•n")" Color="Color.Primary">Bol√•n</MudRadio>
            <MudRadio Value="@("CSN-l√•n")" Color="Color.Primary">CSN-l√•n</MudRadio>
            <MudRadio Value="@("Privatl√•n")" Color="Color.Primary">Privatl√•n</MudRadio>
            <MudRadio Value="@("Kreditkort")" Color="Color.Primary">Kreditkort</MudRadio>
            <MudRadio Value="@("BNPL/Avbetalning")" Color="Color.Primary">BNPL/Avbetalning</MudRadio>
        </MudRadioGroup>
        <MudDivider Class="mb-3 mt-3" />

        <MudNumericField @bind-Value="_formLoan.Amount" 
                         Label="Belopp (kr)" 
                         Variant="Variant.Outlined"
                         Min="0"
                         Format="N2"
                         Culture="@(new System.Globalization.CultureInfo("sv-SE"))"
                         Class="mb-3" />

        <MudNumericField @bind-Value="_formLoan.InterestRate" 
                         Label="R√§nta (%)" 
                         Variant="Variant.Outlined"
                         Min="0"
                         Max="100"
                         Format="N2"
                         Culture="@(new System.Globalization.CultureInfo("sv-SE"))"
                         Class="mb-3" />

        <MudNumericField @bind-Value="_formLoan.Amortization" 
                         Label="Amortering per m√•nad (kr)" 
                         Variant="Variant.Outlined"
                         Min="0"
                         Format="N2"
                         Culture="@(new System.Globalization.CultureInfo("sv-SE"))"
                         Class="mb-3" />

        <MudNumericField @bind-Value="_formLoan.ExtraMonthlyPayment" 
                         Label="Extra amortering per m√•nad (kr) - valfritt" 
                         Variant="Variant.Outlined"
                         Min="0"
                         Format="N2"
                         Culture="@(new System.Globalization.CultureInfo("sv-SE"))"
                         Class="mb-3" />

        @if (_formLoan.Type == "Kreditkort")
        {
            <MudNumericField @bind-Value="_formLoan.CreditLimit" 
                             Label="Kreditgr√§ns (kr)" 
                             Variant="Variant.Outlined"
                             Min="0"
                             Format="N2"
                             Culture="@(new System.Globalization.CultureInfo("sv-SE"))"
                             Class="mb-3" />
            
            <MudNumericField @bind-Value="_formLoan.MinimumPayment" 
                             Label="Minimibetalning per m√•nad (kr)" 
                             Variant="Variant.Outlined"
                             Min="0"
                             Format="N2"
                             Culture="@(new System.Globalization.CultureInfo("sv-SE"))"
                             Class="mb-3" />
        }

        @if (_formLoan.Type == "BNPL/Avbetalning")
        {
            <MudNumericField @bind-Value="_formLoan.InstallmentMonths" 
                             Label="Antal m√•nader" 
                             Variant="Variant.Outlined"
                             Min="1"
                             Max="120"
                             Class="mb-3" />
            
            <MudNumericField @bind-Value="_formLoan.InstallmentFee" 
                             Label="Fast avgift (kr)" 
                             Variant="Variant.Outlined"
                             Min="0"
                             Format="N2"
                             Culture="@(new System.Globalization.CultureInfo("sv-SE"))"
                             Class="mb-3" />
        }

        @if (_formLoan.Type == "Bol√•n")
        {
            <MudDivider Class="mb-3 mt-3" />
            <MudText Typo="Typo.subtitle2" Class="mb-2">Bol√•nespecifik information</MudText>
            
            <MudTextField @bind-Value="_formLoan.PropertyAddress" 
                          Label="Fastighetsadress (valfritt)" 
                          Variant="Variant.Outlined"
                          MaxLength="200"
                          Class="mb-3" />
            
            <MudNumericField @bind-Value="_formLoan.PropertyValue" 
                             Label="Fastighetsv√§rde (kr)" 
                             Variant="Variant.Outlined"
                             Min="0"
                             Format="N0"
                             Culture="@(new System.Globalization.CultureInfo("sv-SE"))"
                             HelperText="Anv√§nds f√∂r att ber√§kna bel√•ningsgrad (LTV)"
                             Class="mb-3" />
            
            <MudTextField @bind-Value="_formLoan.LoanProvider" 
                          Label="Bank/L√•ngivare (valfritt)" 
                          Variant="Variant.Outlined"
                          MaxLength="100"
                          Class="mb-3" />
            
            <MudSwitch @bind-Value="_formLoan.IsFixedRate" 
                       Label="Bunden r√§nta" 
                       Color="Color.Primary"
                       Class="mb-3" />
            
            @if (_formLoan.IsFixedRate)
            {
                <MudNumericField @bind-Value="_formLoan.BindingPeriodMonths" 
                                 Label="Bindningsperiod (m√•nader)" 
                                 Variant="Variant.Outlined"
                                 Min="1"
                                 Max="180"
                                 HelperText="T.ex. 12, 24, 36, 60 m√•nader"
                                 Class="mb-3" />
                
                <MudDatePicker @bind-Date="_formLoan.RateResetDate" 
                               Label="Datum n√§r bindning l√∂per ut" 
                               Variant="Variant.Outlined"
                               DateFormat="yyyy-MM-dd"
                               Editable="true"
                               Class="mb-3" />
            }
        }

        <div class="d-flex gap-2">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveLoan">
                @(_editingLoan != null ? "Uppdatera" : "L√§gg till")
            </MudButton>
            <MudButton Variant="Variant.Outlined" OnClick="CancelForm">Avbryt</MudButton>
        </div>
    </MudPaper>
}

@if (_loading)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else
{
    <MudPaper Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" md="3">
                <MudCard Elevation="2" Class="pa-4">
                    <MudCardContent>
                        <MudText Typo="Typo.h6">Total Bel√•ning</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Error">@_totalDebt.ToString("C", new System.Globalization.CultureInfo("sv-SE"))</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudCard Elevation="2" Class="pa-4">
                    <MudCardContent>
                        <MudText Typo="Typo.h6">Total M√•nadskostnad</MudText>
                        <MudText Typo="Typo.h4">@_totalMonthlyCost.ToString("C", new System.Globalization.CultureInfo("sv-SE"))</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudCard Elevation="2" Class="pa-4">
                    <MudCardContent>
                        <MudText Typo="Typo.h6">Antal L√•n/Krediter</MudText>
                        <MudText Typo="Typo.h4">@_loans.Count()</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudCard Elevation="2" Class="pa-4">
                    <MudCardContent>
                        <MudText Typo="Typo.h6">Skuldfri Datum</MudText>
                        @if (_debtFreeDate.HasValue)
                        {
                            <MudText Typo="Typo.h4" Color="Color.Success">@_debtFreeDate.Value.ToString("yyyy-MM-dd")</MudText>
                        }
                        else
                        {
                            <MudText Typo="Typo.h6">-</MudText>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
        <MudTabPanel Text="√ñversikt" Icon="@Icons.Material.Filled.List">

            @if (!_loans.Any())
            {
                <MudText>Inga l√•n eller krediter registrerade √§n.</MudText>
            }
            else
            {
                <MudTable Items="@_loans" Hover="true" Striped="true">
                    <HeaderContent>
                        <MudTh>Namn</MudTh>
                        <MudTh>Typ</MudTh>
                        <MudTh Style="text-align: right">Belopp</MudTh>
                        <MudTh Style="text-align: right">R√§nta</MudTh>
                        <MudTh Style="text-align: right">Amortering/m√•n</MudTh>
                        <MudTh Style="text-align: right">M√•nadskostnad</MudTh>
                        <MudTh Style="text-align: right">Extra Info</MudTh>
                        <MudTh>√Ötg√§rder</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Namn">@context.Name</MudTd>
                        <MudTd DataLabel="Typ">
                            <MudChip T="string" Size="Size.Small" Color="GetLoanTypeColor(context.Type)">
                                @context.Type
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="Belopp" Style="text-align: right">
                            @context.Amount.ToString("C", new System.Globalization.CultureInfo("sv-SE"))
                        </MudTd>
                        <MudTd DataLabel="R√§nta" Style="text-align: right">
                            @context.InterestRate.ToString("F2")%
                        </MudTd>
                        <MudTd DataLabel="Amortering/m√•n" Style="text-align: right">
                        @context.Amortization.ToString("C", new System.Globalization.CultureInfo("sv-SE"))
                    </MudTd>
                    <MudTd DataLabel="M√•nadskostnad" Style="text-align: right">
                        <MudText Color="Color.Warning">
                            @CalculateMonthlyCost(context).ToString("C", new System.Globalization.CultureInfo("sv-SE"))
                        </MudText>
                    </MudTd>
                    <MudTd DataLabel="Extra Info" Style="text-align: right">
                        @if (context.Type == "Kreditkort" && context.UtilizationRate.HasValue)
                        {
                            <MudChip T="string" Size="Size.Small" Color="@GetUtilizationColor(context.UtilizationRate.Value)">
                                Utnyttjande: @context.UtilizationRate.Value.ToString("F1")%
                            </MudChip>
                        }
                        @if (context.ExtraMonthlyPayment.HasValue && context.ExtraMonthlyPayment.Value > 0)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Info">
                                Extra: @context.ExtraMonthlyPayment.Value.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))
                            </MudChip>
                        }
                    </MudTd>
                    <MudTd DataLabel="√Ötg√§rder">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small"
                                       OnClick="@(() => EditLoan(context))" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                                       OnClick="@(() => DeleteLoan(context.LoanId))" />
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
        </MudTabPanel>
        
        <MudTabPanel Text="Amorteringsplan" Icon="@Icons.Material.Filled.CalendarMonth">
            @if (_selectedLoanForSchedule != null && _amortizationSchedule.Any())
            {
                <div class="d-flex justify-space-between align-center mb-4">
                    <MudText Typo="Typo.h6">Amorteringsplan f√∂r @_selectedLoanForSchedule.Name</MudText>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                               StartIcon="@Icons.Material.Filled.Download" 
                               OnClick="ExportCurrentAmortizationSchedule">
                        Exportera till CSV
                    </MudButton>
                </div>
                <MudTable Items="@_amortizationSchedule.Take(60)" Dense="true" Hover="true" Striped="true">
                    <HeaderContent>
                        <MudTh>Betalning</MudTh>
                        <MudTh>Datum</MudTh>
                        <MudTh Style="text-align: right">Ing√•ende Saldo</MudTh>
                        <MudTh Style="text-align: right">Betalning</MudTh>
                        <MudTh Style="text-align: right">R√§nta</MudTh>
                        <MudTh Style="text-align: right">Amortering</MudTh>
                        <MudTh Style="text-align: right">Utg√•ende Saldo</MudTh>
                        <MudTh Style="text-align: right">Tot. R√§nta</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Betalning">@context.PaymentNumber</MudTd>
                        <MudTd DataLabel="Datum">@context.PaymentDate.ToString("yyyy-MM")</MudTd>
                        <MudTd DataLabel="Ing√•ende Saldo" Style="text-align: right">@context.BeginningBalance.ToString("N0")</MudTd>
                        <MudTd DataLabel="Betalning" Style="text-align: right">@context.Payment.ToString("N0")</MudTd>
                        <MudTd DataLabel="R√§nta" Style="text-align: right">@context.Interest.ToString("N0")</MudTd>
                        <MudTd DataLabel="Amortering" Style="text-align: right">@context.Principal.ToString("N0")</MudTd>
                        <MudTd DataLabel="Utg√•ende Saldo" Style="text-align: right">@context.EndingBalance.ToString("N0")</MudTd>
                        <MudTd DataLabel="Tot. R√§nta" Style="text-align: right">@context.TotalInterestPaid.ToString("N0")</MudTd>
                    </RowTemplate>
                </MudTable>
                @if (_amortizationSchedule.Count > 60)
                {
                    <MudText Typo="Typo.body2" Class="mt-2">Visar f√∂rsta 60 av @_amortizationSchedule.Count betalningar</MudText>
                }
            }
            else
            {
                <MudText>V√§lj ett l√•n fr√•n √∂versikten f√∂r att se amorteringsplan.</MudText>
            }
        </MudTabPanel>
        
        <MudTabPanel Text="Avbetalningsstrategier" Icon="@Icons.Material.Filled.TrendingDown">
            <MudText Typo="Typo.h6" Class="mb-4">J√§mf√∂r avbetalningsstrategier</MudText>
            <MudAlert Severity="Severity.Info" Class="mb-4">
                Sn√∂boll-metoden betalar av minsta skulden f√∂rst f√∂r psykologiska vinster. 
                Lavin-metoden betalar av h√∂gsta r√§ntan f√∂rst f√∂r att minimera r√§ntekostnader.
            </MudAlert>
            
            <!-- Interactive simulation controls -->
            <MudPaper Class="pa-4 mb-4">
                <MudText Typo="Typo.h6" Class="mb-3">üí° Simuleringsverktyg</MudText>
                <MudText Typo="Typo.body2" Class="mb-3">
                    Justera din tillg√§ngliga m√•nadsbetalning f√∂r att se hur det p√•verkar avbetalningen av dina skulder.
                </MudText>
                <MudNumericField @bind-Value="_simulationMonthlyPayment" 
                                 Label="Tillg√§nglig m√•nadsbetalning (kr)" 
                                 Variant="Variant.Outlined"
                                 Min="0"
                                 Format="N2"
                                 Culture="@(new System.Globalization.CultureInfo("sv-SE"))"
                                 Class="mb-3" />
                <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                           OnClick="RunSimulation" 
                           Disabled="_loans.Count() == 0">
                    K√∂r simulering
                </MudButton>
                @if (_simulationRun && _loans.Any())
                {
                    <MudText Typo="Typo.caption" Class="mt-2" Color="Color.Secondary">
                        Minsta m√•natliga betalning: @_totalMonthlyCost.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))
                    </MudText>
                }
            </MudPaper>
            
            @if (_snowballStrategy != null && _avalancheStrategy != null)
            {
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudCard Elevation="2">
                            <MudCardHeader>
                                <CardHeaderContent>
                                    <div class="d-flex justify-space-between align-center">
                                        <MudText Typo="Typo.h6">‚õ∑Ô∏è Sn√∂boll-metoden</MudText>
                                        <MudIconButton Icon="@Icons.Material.Filled.Download" 
                                                       Size="Size.Small" 
                                                       Color="Color.Primary"
                                                       OnClick="ExportSnowballStrategy" />
                                    </div>
                                </CardHeaderContent>
                            </MudCardHeader>
                            <MudCardContent>
                                <MudText>@_snowballStrategy.Description</MudText>
                                <MudDivider Class="my-3" />
                                <MudText><strong>Skuldfri:</strong> @_snowballStrategy.DebtFreeDate.ToString("yyyy-MM-dd")</MudText>
                                <MudText><strong>Total r√§nta:</strong> @_snowballStrategy.TotalInterestPaid.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))</MudText>
                                <MudText><strong>Antal m√•nader:</strong> @_snowballStrategy.TotalMonths</MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudCard Elevation="2">
                            <MudCardHeader>
                                <CardHeaderContent>
                                    <div class="d-flex justify-space-between align-center">
                                        <MudText Typo="Typo.h6">üèîÔ∏è Lavin-metoden</MudText>
                                        <MudIconButton Icon="@Icons.Material.Filled.Download" 
                                                       Size="Size.Small" 
                                                       Color="Color.Primary"
                                                       OnClick="ExportAvalancheStrategy" />
                                    </div>
                                </CardHeaderContent>
                            </MudCardHeader>
                            <MudCardContent>
                                <MudText>@_avalancheStrategy.Description</MudText>
                                <MudDivider Class="my-3" />
                                <MudText><strong>Skuldfri:</strong> @_avalancheStrategy.DebtFreeDate.ToString("yyyy-MM-dd")</MudText>
                                <MudText><strong>Total r√§nta:</strong> @_avalancheStrategy.TotalInterestPaid.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))</MudText>
                                <MudText><strong>Antal m√•nader:</strong> @_avalancheStrategy.TotalMonths</MudText>
                                
                                @if (_avalancheStrategy.TotalInterestPaid < _snowballStrategy.TotalInterestPaid)
                                {
                                    <MudAlert Severity="Severity.Success" Class="mt-3" Dense="true">
                                        Sparar @((_snowballStrategy.TotalInterestPaid - _avalancheStrategy.TotalInterestPaid).ToString("C0", new System.Globalization.CultureInfo("sv-SE"))) i r√§nta!
                                    </MudAlert>
                                }
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                </MudGrid>
            }
            else
            {
                <MudText>L√§gg till l√•n f√∂r att se strategier.</MudText>
            }
        </MudTabPanel>
        
        <MudTabPanel Text="Detaljerad Simulering" Icon="@Icons.Material.Filled.Timeline">
            @if (_detailedStrategy != null && _detailedStrategy.MonthlySchedule.Any())
            {
                <MudText Typo="Typo.h6" Class="mb-4">
                    M√•nad-f√∂r-m√•nad simulering: @_detailedStrategy.StrategyName
                </MudText>
                
                <MudAlert Severity="Severity.Info" Class="mb-4" Dense="true">
                    <strong>Algoritm:</strong> @_detailedStrategy.Description
                    <br/>
                    <strong>Formel:</strong> M√•nadsr√§nta = (Belopp √ó √Örsr√§nta / 100) / 12; Amortering = Betalning - R√§nta
                </MudAlert>
                
                <!-- Summary cards -->
                <MudGrid Class="mb-4">
                    <MudItem xs="12" md="3">
                        <MudCard Elevation="2">
                            <MudCardContent>
                                <MudText Typo="Typo.subtitle2">Skuldfri datum</MudText>
                                <MudText Typo="Typo.h6" Color="Color.Success">@_detailedStrategy.DebtFreeDate.ToString("yyyy-MM-dd")</MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="12" md="3">
                        <MudCard Elevation="2">
                            <MudCardContent>
                                <MudText Typo="Typo.subtitle2">Total r√§nta</MudText>
                                <MudText Typo="Typo.h6">@_detailedStrategy.TotalInterestPaid.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))</MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="12" md="3">
                        <MudCard Elevation="2">
                            <MudCardContent>
                                <MudText Typo="Typo.subtitle2">Antal m√•nader</MudText>
                                <MudText Typo="Typo.h6">@_detailedStrategy.TotalMonths</MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="12" md="3">
                        <MudCard Elevation="2">
                            <MudCardContent>
                                <MudText Typo="Typo.subtitle2">Total kostnad</MudText>
                                <MudText Typo="Typo.h6">@_detailedStrategy.TotalAmountPaid.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))</MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                </MudGrid>
                
                <!-- Loan summaries -->
                <MudText Typo="Typo.h6" Class="mb-3">Avbetalningsordning</MudText>
                <MudTable Items="@_detailedStrategy.LoanSummaries" Dense="true" Hover="true" Striped="true" Class="mb-4">
                    <HeaderContent>
                        <MudTh>Ordning</MudTh>
                        <MudTh>L√•n</MudTh>
                        <MudTh Style="text-align: right">Belopp</MudTh>
                        <MudTh Style="text-align: right">R√§nta</MudTh>
                        <MudTh>Betalt datum</MudTh>
                        <MudTh Style="text-align: right">M√•nader</MudTh>
                        <MudTh Style="text-align: right">Total r√§nta</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Ordning">
                            <MudChip T="string" Size="Size.Small" Color="Color.Primary">@context.PayoffOrder</MudChip>
                        </MudTd>
                        <MudTd DataLabel="L√•n">@context.LoanName</MudTd>
                        <MudTd DataLabel="Belopp" Style="text-align: right">@context.OriginalAmount.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))</MudTd>
                        <MudTd DataLabel="R√§nta" Style="text-align: right">@context.InterestRate.ToString("F2")%</MudTd>
                        <MudTd DataLabel="Betalt datum">@context.PayoffDate.ToString("yyyy-MM-dd")</MudTd>
                        <MudTd DataLabel="M√•nader" Style="text-align: right">@context.MonthsToPayoff</MudTd>
                        <MudTd DataLabel="Total r√§nta" Style="text-align: right">@context.TotalInterestPaid.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))</MudTd>
                    </RowTemplate>
                </MudTable>
                
                <!-- Monthly schedule -->
                <MudText Typo="Typo.h6" Class="mb-3">M√•natlig betalningsplan</MudText>
                <MudTable Items="@_detailedStrategy.MonthlySchedule.Take(60)" Dense="true" Hover="true" Striped="true">
                    <HeaderContent>
                        <MudTh>M√•nad</MudTh>
                        <MudTh>Datum</MudTh>
                        <MudTh Style="text-align: right">Total betalning</MudTh>
                        <MudTh Style="text-align: right">Amortering</MudTh>
                        <MudTh Style="text-align: right">R√§nta</MudTh>
                        <MudTh Style="text-align: right">Kvar skuld</MudTh>
                        <MudTh>Aktiva l√•n</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="M√•nad">@context.MonthNumber</MudTd>
                        <MudTd DataLabel="Datum">@context.PaymentDate.ToString("yyyy-MM")</MudTd>
                        <MudTd DataLabel="Total betalning" Style="text-align: right">@context.TotalPayment.ToString("N0")</MudTd>
                        <MudTd DataLabel="Amortering" Style="text-align: right">@context.TotalPrincipal.ToString("N0")</MudTd>
                        <MudTd DataLabel="R√§nta" Style="text-align: right">@context.TotalInterest.ToString("N0")</MudTd>
                        <MudTd DataLabel="Kvar skuld" Style="text-align: right">@context.RemainingTotalDebt.ToString("N0")</MudTd>
                        <MudTd DataLabel="Aktiva l√•n">
                            @foreach (var loan in context.LoanPayments.Where(l => l.EndingBalance > 0))
                            {
                                <MudChip T="string" Size="Size.Small" 
                                         Color="@(loan.IsFocusLoan ? Color.Primary : Color.Default)">
                                    @loan.LoanName
                                </MudChip>
                            }
                            @foreach (var loan in context.LoanPayments.Where(l => l.IsPaidOff))
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Success">
                                    ‚úì @loan.LoanName
                                </MudChip>
                            }
                        </MudTd>
                    </RowTemplate>
                </MudTable>
                @if (_detailedStrategy.MonthlySchedule.Count > 60)
                {
                    <MudText Typo="Typo.body2" Class="mt-2">
                        Visar f√∂rsta 60 av @_detailedStrategy.MonthlySchedule.Count m√•nader
                    </MudText>
                }
            }
            else
            {
                <MudText>K√∂r en simulering i fliken "Avbetalningsstrategier" f√∂r att se detaljerad m√•natlig plan.</MudText>
            }
        </MudTabPanel>
        
        <MudTabPanel Text="Bol√•neanalys" Icon="@Icons.Material.Filled.HomeWork">
            @if (_mortgages.Any())
            {
                <MudText Typo="Typo.h6" Class="mb-4">Analys av bol√•n enligt svenska regler</MudText>
                
                <MudAlert Severity="Severity.Info" Class="mb-4" Dense="true">
                    <strong>Svenska amorteringskrav:</strong><br/>
                    ‚Ä¢ Bel√•ningsgrad √∂ver 70%: 2% √•rlig amortering av ursprungligt l√•nebelopp<br/>
                    ‚Ä¢ Bel√•ningsgrad 50-70%: 1% √•rlig amortering av ursprungligt l√•nebelopp<br/>
                    ‚Ä¢ Bel√•ningsgrad under 50%: Inget amorteringskrav
                </MudAlert>
                
                @foreach (var mortgage in _mortgages)
                {
                    var amortRequirement = MortgageAnalysisService.CalculateAmortizationRequirement(mortgage);
                    var riskAnalysis = MortgageAnalysisService.AnalyzeInterestRateRisk(mortgage, new[] { 0m, 1m, 2m, 3m });
                    
                    <MudCard Elevation="2" Class="mb-4">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">@mortgage.Name</MudText>
                                @if (!string.IsNullOrEmpty(mortgage.PropertyAddress))
                                {
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">@mortgage.PropertyAddress</MudText>
                                }
                            </CardHeaderContent>
                            <CardHeaderActions>
                                <MudChip T="string" Size="Size.Small" Color="@GetRiskLevelColor(riskAnalysis.RiskLevel)">
                                    @GetRiskLevelText(riskAnalysis.RiskLevel)
                                </MudChip>
                            </CardHeaderActions>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudGrid>
                                <!-- Loan details -->
                                <MudItem xs="12" md="6">
                                    <MudText Typo="Typo.subtitle2" Class="mb-2">üìä L√•neuppgifter</MudText>
                                    <MudText><strong>L√•nebelopp:</strong> @mortgage.Amount.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))</MudText>
                                    @if (mortgage.PropertyValue.HasValue)
                                    {
                                        <MudText><strong>Fastighetsv√§rde:</strong> @mortgage.PropertyValue.Value.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))</MudText>
                                        <MudText><strong>Bel√•ningsgrad (LTV):</strong> @amortRequirement.LoanToValueRatio.ToString("F1")%</MudText>
                                    }
                                    <MudText><strong>Aktuell r√§nta:</strong> @mortgage.InterestRate.ToString("F2")%</MudText>
                                    @if (!string.IsNullOrEmpty(mortgage.LoanProvider))
                                    {
                                        <MudText><strong>Bank:</strong> @mortgage.LoanProvider</MudText>
                                    }
                                </MudItem>
                                
                                <!-- Interest rate binding -->
                                <MudItem xs="12" md="6">
                                    <MudText Typo="Typo.subtitle2" Class="mb-2">üîí R√§ntebindning</MudText>
                                    <MudText><strong>Typ:</strong> @(mortgage.IsFixedRate ? "Bunden r√§nta" : "R√∂rlig r√§nta")</MudText>
                                    @if (mortgage.IsFixedRate && mortgage.RateResetDate.HasValue)
                                    {
                                        <MudText><strong>Bindning l√∂per ut:</strong> @mortgage.RateResetDate.Value.ToString("yyyy-MM-dd")</MudText>
                                        @if (riskAnalysis.MonthsUntilRateReset.HasValue)
                                        {
                                            <MudText><strong>M√•nader kvar:</strong> @riskAnalysis.MonthsUntilRateReset m√•nader</MudText>
                                        }
                                        @if (mortgage.BindingPeriodMonths.HasValue)
                                        {
                                            <MudText><strong>Bindningsperiod:</strong> @mortgage.BindingPeriodMonths m√•nader</MudText>
                                        }
                                    }
                                    else if (!mortgage.IsFixedRate)
                                    {
                                        <MudAlert Severity="Severity.Warning" Dense="true" Class="mt-2">
                                            R√∂rlig r√§nta inneb√§r h√∂gre r√§nterisk. √ñverv√§g att binda r√§ntan.
                                        </MudAlert>
                                    }
                                </MudItem>
                                
                                <!-- Amortization requirement -->
                                <MudItem xs="12" md="6">
                                    <MudText Typo="Typo.subtitle2" Class="mb-2">üí∞ Amorteringskrav</MudText>
                                    <MudText Class="mb-2">@amortRequirement.RuleDescription</MudText>
                                    <MudText><strong>Kr√§vs per m√•nad:</strong> @amortRequirement.RequiredMonthlyAmortization.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))</MudText>
                                    <MudText><strong>Du amorterar:</strong> @amortRequirement.CurrentMonthlyAmortization.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))</MudText>
                                    
                                    @if (!amortRequirement.MeetsRequirement)
                                    {
                                        <MudAlert Severity="Severity.Error" Dense="true" Class="mt-2">
                                            ‚ö†Ô∏è Du amorterar <strong>@amortRequirement.MonthlyShortage.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))</strong> mindre per m√•nad √§n kravet!
                                        </MudAlert>
                                    }
                                    else if (amortRequirement.RequiredMonthlyAmortization > 0)
                                    {
                                        <MudAlert Severity="Severity.Success" Dense="true" Class="mt-2">
                                            ‚úì Du uppfyller amorteringskravet
                                        </MudAlert>
                                    }
                                    
                                    @if (amortRequirement.YearsToPayoff.HasValue)
                                    {
                                        <MudText Class="mt-2"><strong>Ber√§knad √•terbetalningstid:</strong> @amortRequirement.YearsToPayoff √•r</MudText>
                                    }
                                </MudItem>
                                
                                <!-- Interest rate risk -->
                                <MudItem xs="12" md="6">
                                    <MudText Typo="Typo.subtitle2" Class="mb-2">‚ö†Ô∏è R√§nterisk</MudText>
                                    <MudText Class="mb-2">@riskAnalysis.RiskDescription</MudText>
                                    <MudText Typo="Typo.body2" Class="mb-2"><strong>R√§ntescenarier:</strong></MudText>
                                    <MudSimpleTable Dense="true" Hover="true" Class="mt-2">
                                        <thead>
                                            <tr>
                                                <th>Scenario</th>
                                                <th style="text-align: right">R√§nta</th>
                                                <th style="text-align: right">M√•nadskostnad</th>
                                                <th style="text-align: right">√ñkning</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var scenario in riskAnalysis.Scenarios)
                                            {
                                                <tr>
                                                    <td>@scenario.ScenarioName</td>
                                                    <td style="text-align: right">@scenario.InterestRate.ToString("F2")%</td>
                                                    <td style="text-align: right">@scenario.MonthlyCost.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))</td>
                                                    <td style="text-align: right">
                                                        @if (scenario.MonthlyIncrease > 0)
                                                        {
                                                            <span style="color: var(--mud-palette-error)">+@scenario.MonthlyIncrease.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))</span>
                                                        }
                                                        else
                                                        {
                                                            <span>-</span>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </MudSimpleTable>
                                </MudItem>
                            </MudGrid>
                        </MudCardContent>
                    </MudCard>
                }
                
                <!-- Upcoming rate resets -->
                @if (_upcomingRateResets.Any())
                {
                    <MudAlert Severity="Severity.Warning" Class="mt-4">
                        <MudText Typo="Typo.h6" Class="mb-2">‚è∞ Kommande r√§ntebindningar som l√∂per ut</MudText>
                        @foreach (var loan in _upcomingRateResets)
                        {
                            <MudText>‚Ä¢ <strong>@loan.Name</strong> - Bindning l√∂per ut @loan.RateResetDate?.ToString("yyyy-MM-dd")</MudText>
                        }
                    </MudAlert>
                }
            }
            else
            {
                <MudText>Inga bol√•n registrerade. L√§gg till ett bol√•n f√∂r att se analys.</MudText>
            }
        </MudTabPanel>
    </MudTabs>
}

@code {
    private bool _loading = true;
    private bool _showCreateForm = false;
    private IEnumerable<Loan> _loans = new List<Loan>();
    private IEnumerable<Loan> _mortgages = new List<Loan>();
    private IEnumerable<Loan> _upcomingRateResets = new List<Loan>();
    private decimal _totalDebt = 0;
    private decimal _totalMonthlyCost = 0;
    private DateTime? _debtFreeDate = null;
    private Loan _formLoan = new Loan();
    private Loan? _editingLoan = null;
    
    // Amortization schedule
    private Loan? _selectedLoanForSchedule = null;
    private List<AmortizationScheduleEntry> _amortizationSchedule = new();
    
    // Debt strategies
    private DebtPayoffStrategy? _snowballStrategy = null;
    private DebtPayoffStrategy? _avalancheStrategy = null;
    
    // Detailed strategy
    private DetailedDebtPayoffStrategy? _detailedStrategy = null;
    
    // Simulation
    private decimal _simulationMonthlyPayment = 0;
    private bool _simulationRun = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;
        _loans = await LoanService.GetAllLoansAsync();
        _totalDebt = _loans.Sum(l => l.Amount);
        _totalMonthlyCost = _loans.Sum(l => CalculateMonthlyCost(l));
        
        // Load mortgages and upcoming rate resets
        _mortgages = _loans.Where(l => l.Type == "Bol√•n").ToList();
        _upcomingRateResets = await MortgageAnalysisService.GetUpcomingRateResetsAsync(6);
        
        // Calculate debt-free date
        _debtFreeDate = await DebtStrategyService.CalculateDebtFreeDate();
        
        // Load first loan's amortization schedule
        if (_loans.Any())
        {
            _selectedLoanForSchedule = _loans.First();
            _amortizationSchedule = DebtStrategyService.GenerateAmortizationSchedule(
                _selectedLoanForSchedule, 
                _selectedLoanForSchedule.ExtraMonthlyPayment ?? 0
            );
            
            // Calculate strategies if we have loans
            var totalMinPayment = _loans.Sum(l => l.Amortization + (l.Amount * l.InterestRate / 100 / 12));
            var strategies = await DebtStrategyService.CompareStrategies(totalMinPayment);
            _snowballStrategy = strategies.Snowball;
            _avalancheStrategy = strategies.Avalanche;
            
            // Initialize simulation payment to minimum payment
            if (_simulationMonthlyPayment == 0)
            {
                _simulationMonthlyPayment = totalMinPayment;
            }
        }
        
        _loading = false;
    }

    private decimal CalculateMonthlyCost(Loan loan)
    {
        // M√•nadsr√§nta = (Belopp * R√§nta/100) / 12 + Amortering
        var monthlyInterest = (loan.Amount * loan.InterestRate / 100) / 12;
        return monthlyInterest + loan.Amortization;
    }

    private Color GetLoanTypeColor(string type)
    {
        return type switch
        {
            "Bol√•n" => Color.Primary,
            "CSN-l√•n" => Color.Info,
            "Privatl√•n" => Color.Warning,
            "Kreditkort" => Color.Secondary,
            "BNPL/Avbetalning" => Color.Tertiary,
            _ => Color.Default
        };
    }

    private Color GetUtilizationColor(decimal utilizationRate)
    {
        if (utilizationRate < 30) return Color.Success;
        if (utilizationRate < 50) return Color.Info;
        if (utilizationRate < 70) return Color.Warning;
        return Color.Error;
    }

    private void ToggleCreateForm()
    {
        _showCreateForm = !_showCreateForm;
        if (_showCreateForm)
        {
            _formLoan = new Loan();
            _editingLoan = null;
        }
    }

    private void EditLoan(Loan loan)
    {
        _editingLoan = loan;
        _formLoan = new Loan
        {
            LoanId = loan.LoanId,
            Name = loan.Name,
            Type = loan.Type,
            Amount = loan.Amount,
            InterestRate = loan.InterestRate,
            Amortization = loan.Amortization,
            ExtraMonthlyPayment = loan.ExtraMonthlyPayment,
            CreditLimit = loan.CreditLimit,
            MinimumPayment = loan.MinimumPayment,
            InstallmentMonths = loan.InstallmentMonths,
            InstallmentFee = loan.InstallmentFee,
            Priority = loan.Priority,
            // Mortgage-specific fields
            PropertyAddress = loan.PropertyAddress,
            PropertyValue = loan.PropertyValue,
            LoanProvider = loan.LoanProvider,
            IsFixedRate = loan.IsFixedRate,
            RateResetDate = loan.RateResetDate,
            BindingPeriodMonths = loan.BindingPeriodMonths
        };
        _showCreateForm = true;
    }

    private async Task SaveLoan()
    {
        if (string.IsNullOrWhiteSpace(_formLoan.Name))
        {
            Snackbar.Add("Namn √§r obligatoriskt", Severity.Error);
            return;
        }

        if (string.IsNullOrWhiteSpace(_formLoan.Type))
        {
            Snackbar.Add("Typ √§r obligatorisk", Severity.Error);
            return;
        }

        if (_formLoan.Amount <= 0)
        {
            Snackbar.Add("Belopp m√•ste vara st√∂rre √§n 0", Severity.Error);
            return;
        }

        try
        {
            if (_editingLoan != null)
            {
                await LoanService.UpdateLoanAsync(_formLoan);
                Snackbar.Add("L√•n/Kredit uppdaterat!", Severity.Success);
            }
            else
            {
                await LoanService.CreateLoanAsync(_formLoan);
                Snackbar.Add("L√•n/Kredit tillagt!", Severity.Success);
            }

            _showCreateForm = false;
            _editingLoan = null;
            await LoadData();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fel: {ex.Message}", Severity.Error);
        }
    }

    private void CancelForm()
    {
        _showCreateForm = false;
        _editingLoan = null;
        _formLoan = new Loan();
    }

    private async Task DeleteLoan(int id)
    {
        var result = await DialogService.ShowMessageBox(
            "Bekr√§fta borttagning",
            "√Ñr du s√§ker p√• att du vill ta bort detta l√•n/kredit?",
            yesText: "Ja", cancelText: "Avbryt");

        if (result == true)
        {
            await LoanService.DeleteLoanAsync(id);
            Snackbar.Add("L√•n/Kredit borttaget", Severity.Success);
            await LoadData();
        }
    }
    
    private void ExportCurrentAmortizationSchedule()
    {
        if (_selectedLoanForSchedule == null)
        {
            Snackbar.Add("Inget l√•n valt", Severity.Warning);
            return;
        }
        
        var extra = _selectedLoanForSchedule.ExtraMonthlyPayment ?? 0;
        var url = $"/api/debtstrategy/export-amortization-schedule/{_selectedLoanForSchedule.LoanId}?extraMonthlyPayment={extra}";
        
        // Open download in new window
        NavigationManager.NavigateTo(url, true);
        Snackbar.Add("Exporterar amorteringsplan...", Severity.Info);
    }
    
    private void ExportSnowballStrategy()
    {
        if (_snowballStrategy == null)
            return;
            
        var url = $"/api/debtstrategy/export-strategy?strategyType=snowball&availableMonthlyPayment={_simulationMonthlyPayment}";
        NavigationManager.NavigateTo(url, true);
        Snackbar.Add($"Exporterar {_snowballStrategy.StrategyName} strategi...", Severity.Info);
    }
    
    private void ExportAvalancheStrategy()
    {
        if (_avalancheStrategy == null)
            return;
            
        var url = $"/api/debtstrategy/export-strategy?strategyType=avalanche&availableMonthlyPayment={_simulationMonthlyPayment}";
        NavigationManager.NavigateTo(url, true);
        Snackbar.Add($"Exporterar {_avalancheStrategy.StrategyName} strategi...", Severity.Info);
    }
    
    private async Task RunSimulation()
    {
        if (_simulationMonthlyPayment < _totalMonthlyCost)
        {
            Snackbar.Add($"M√•nadsbetalningen m√•ste vara minst {_totalMonthlyCost:C0} f√∂r att t√§cka minimumbetalningarna", Severity.Warning);
            return;
        }
        
        try
        {
            _loading = true;
            
            // Calculate strategies with the simulation amount
            var strategies = await DebtStrategyService.CompareStrategies(_simulationMonthlyPayment);
            _snowballStrategy = strategies.Snowball;
            _avalancheStrategy = strategies.Avalanche;
            
            // Generate detailed strategy (default to avalanche as it's more optimal)
            _detailedStrategy = await DebtStrategyService.GenerateDetailedStrategy("Avalanche", _simulationMonthlyPayment);
            
            _simulationRun = true;
            Snackbar.Add("Simulering klar!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fel vid simulering: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }
    
    // Helper methods for mortgage analysis UI
    private Color GetRiskLevelColor(RiskLevel riskLevel)
    {
        return riskLevel switch
        {
            RiskLevel.Low => Color.Success,
            RiskLevel.Medium => Color.Warning,
            RiskLevel.High => Color.Error,
            _ => Color.Default
        };
    }
    
    private string GetRiskLevelText(RiskLevel riskLevel)
    {
        return riskLevel switch
        {
            RiskLevel.Low => "L√•g risk",
            RiskLevel.Medium => "M√•ttlig risk",
            RiskLevel.High => "H√∂g risk",
            _ => "Ok√§nd risk"
        };
    }
}
