@page "/investments/loans"
@page "/loans"
@rendermode InteractiveServer
@inject ILoanService LoanService
@inject IDebtStrategyService DebtStrategyService
@inject IMortgageAnalysisService MortgageAnalysisService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@using Privatekonomi.Core.Models
@using Privatekonomi.Web.Components.Shared

<PageTitle>Lån & Krediter - Privatekonomi</PageTitle>

<div class="page-header mb-4">
    <MudText Typo="Typo.h4">
        <MudIcon Icon="@Icons.Material.Filled.CreditCard" Color="Color.Primary" Class="mr-2" aria-hidden="true" />
        Lån & Krediter
    </MudText>
    <div class="page-header-buttons">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="ToggleCreateForm">
            Nytt Lån/Kredit
        </MudButton>
    </div>
</div>

@if (_showCreateForm)
{
    <MudPaper Class="pa-4 mb-4">
        <MudText Typo="Typo.h6" Class="mb-3">@(_editingLoan != null ? "Redigera Lån/Kredit" : "Lägg till Nytt Lån/Kredit")</MudText>
        
        <MudTextField @bind-Value="_formLoan.Name" 
                      Label="Namn" 
                      Variant="Variant.Outlined"
                      Required="true"
                      MaxLength="200"
                      Class="mb-3" />
        
        <MudRadioGroup @bind-Value="_formLoan.Type" Required="true">
            <MudText Typo="Typo.subtitle2" Class="mb-2">Typ</MudText>
            <MudRadio Value="@("Bolån")" Color="Color.Primary">Bolån</MudRadio>
            <MudRadio Value="@("CSN-lån")" Color="Color.Primary">CSN-lån</MudRadio>
            <MudRadio Value="@("Privatlån")" Color="Color.Primary">Privatlån</MudRadio>
            <MudRadio Value="@("Kreditkort")" Color="Color.Primary">Kreditkort</MudRadio>
            <MudRadio Value="@("BNPL/Avbetalning")" Color="Color.Primary">BNPL/Avbetalning</MudRadio>
        </MudRadioGroup>
        <MudDivider Class="mb-3 mt-3" />

        <MudNumericField @bind-Value="_formLoan.Amount" 
                         Label="Belopp (kr)" 
                         Variant="Variant.Outlined"
                         Min="0"
                         Format="N2"
                         Culture="@(new System.Globalization.CultureInfo("sv-SE"))"
                         Class="mb-3" />

        <MudNumericField @bind-Value="_formLoan.InterestRate" 
                         Label="Ränta (%)" 
                         Variant="Variant.Outlined"
                         Min="0"
                         Max="100"
                         Format="N2"
                         Culture="@(new System.Globalization.CultureInfo("sv-SE"))"
                         Class="mb-3" />

        <MudNumericField @bind-Value="_formLoan.Amortization" 
                         Label="Amortering per månad (kr)" 
                         Variant="Variant.Outlined"
                         Min="0"
                         Format="N2"
                         Culture="@(new System.Globalization.CultureInfo("sv-SE"))"
                         Class="mb-3" />

        <MudNumericField @bind-Value="_formLoan.ExtraMonthlyPayment" 
                         Label="Extra amortering per månad (kr) - valfritt" 
                         Variant="Variant.Outlined"
                         Min="0"
                         Format="N2"
                         Culture="@(new System.Globalization.CultureInfo("sv-SE"))"
                         Class="mb-3" />

        @if (_formLoan.Type == "Kreditkort")
        {
            <MudNumericField @bind-Value="_formLoan.CreditLimit" 
                             Label="Kreditgräns (kr)" 
                             Variant="Variant.Outlined"
                             Min="0"
                             Format="N2"
                             Culture="@(new System.Globalization.CultureInfo("sv-SE"))"
                             Class="mb-3" />
            
            <MudNumericField @bind-Value="_formLoan.MinimumPayment" 
                             Label="Minimibetalning per månad (kr)" 
                             Variant="Variant.Outlined"
                             Min="0"
                             Format="N2"
                             Culture="@(new System.Globalization.CultureInfo("sv-SE"))"
                             Class="mb-3" />
        }

        @if (_formLoan.Type == "BNPL/Avbetalning")
        {
            <MudNumericField @bind-Value="_formLoan.InstallmentMonths" 
                             Label="Antal månader" 
                             Variant="Variant.Outlined"
                             Min="1"
                             Max="120"
                             Class="mb-3" />
            
            <MudNumericField @bind-Value="_formLoan.InstallmentFee" 
                             Label="Fast avgift (kr)" 
                             Variant="Variant.Outlined"
                             Min="0"
                             Format="N2"
                             Culture="@(new System.Globalization.CultureInfo("sv-SE"))"
                             Class="mb-3" />
        }

        @if (_formLoan.Type == "Bolån")
        {
            <MudDivider Class="mb-3 mt-3" />
            <MudText Typo="Typo.subtitle2" Class="mb-2">Bolånespecifik information</MudText>
            
            <MudTextField @bind-Value="_formLoan.PropertyAddress" 
                          Label="Fastighetsadress (valfritt)" 
                          Variant="Variant.Outlined"
                          MaxLength="200"
                          Class="mb-3" />
            
            <MudNumericField @bind-Value="_formLoan.PropertyValue" 
                             Label="Fastighetsvärde (kr)" 
                             Variant="Variant.Outlined"
                             Min="0"
                             Format="N0"
                             Culture="@(new System.Globalization.CultureInfo("sv-SE"))"
                             HelperText="Används för att beräkna belåningsgrad (LTV)"
                             Class="mb-3" />
            
            <MudTextField @bind-Value="_formLoan.LoanProvider" 
                          Label="Bank/Långivare (valfritt)" 
                          Variant="Variant.Outlined"
                          MaxLength="100"
                          Class="mb-3" />
            
            <MudSwitch @bind-Value="_formLoan.IsFixedRate" 
                       Label="Bunden ränta" 
                       Color="Color.Primary"
                       Class="mb-3" />
            
            @if (_formLoan.IsFixedRate)
            {
                <MudNumericField @bind-Value="_formLoan.BindingPeriodMonths" 
                                 Label="Bindningsperiod (månader)" 
                                 Variant="Variant.Outlined"
                                 Min="1"
                                 Max="180"
                                 HelperText="T.ex. 12, 24, 36, 60 månader"
                                 Class="mb-3" />
                
                <MudDatePicker @bind-Date="_formLoan.RateResetDate" 
                               Label="Datum när bindning löper ut" 
                               Variant="Variant.Outlined"
                               DateFormat="yyyy-MM-dd"
                               Editable="true"
                               Class="mb-3" />
            }
        }

        <div class="d-flex gap-2">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveLoan">
                @(_editingLoan != null ? "Uppdatera" : "Lägg till")
            </MudButton>
            <MudButton Variant="Variant.Outlined" OnClick="CancelForm">Avbryt</MudButton>
        </div>
    </MudPaper>
}

@if (_loading)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else
{
    <MudPaper Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" md="3">
                <MudCard Elevation="2" Class="pa-4">
                    <MudCardContent>
                        <MudText Typo="Typo.h6">Total Belåning</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Error">@_totalDebt.ToString("C", new System.Globalization.CultureInfo("sv-SE"))</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudCard Elevation="2" Class="pa-4">
                    <MudCardContent>
                        <MudText Typo="Typo.h6">Total Månadskostnad</MudText>
                        <MudText Typo="Typo.h4">@_totalMonthlyCost.ToString("C", new System.Globalization.CultureInfo("sv-SE"))</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudCard Elevation="2" Class="pa-4">
                    <MudCardContent>
                        <MudText Typo="Typo.h6">Antal Lån/Krediter</MudText>
                        <MudText Typo="Typo.h4">@_loans.Count()</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudCard Elevation="2" Class="pa-4">
                    <MudCardContent>
                        <MudText Typo="Typo.h6">Skuldfri Datum</MudText>
                        @if (_debtFreeDate.HasValue)
                        {
                            <MudText Typo="Typo.h4" Color="Color.Success">@_debtFreeDate.Value.ToString("yyyy-MM-dd")</MudText>
                        }
                        else
                        {
                            <MudText Typo="Typo.h6">-</MudText>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
        <MudTabPanel Text="Översikt" Icon="@Icons.Material.Filled.List">

            @if (!_loans.Any())
            {
                <EmptyState IconName="@Icons.Material.Filled.CreditCard"
                            IconColor="Color.Secondary"
                            Title="Inga lån eller krediter registrerade"
                            Description="Lägg till dina lån och krediter för att få en samlad bild av din belåning och planera din amortering."
                            ActionText="Lägg till Lån/Kredit"
                            ActionIcon="@Icons.Material.Filled.Add"
                            OnActionClick="ToggleCreateForm"
                            Class="mt-4" />
            }
            else
            {
                <MudTable Items="@_loans" Hover="true" Striped="true">
                    <HeaderContent>
                        <MudTh>Namn</MudTh>
                        <MudTh>Typ</MudTh>
                        <MudTh Style="text-align: right">Belopp</MudTh>
                        <MudTh Style="text-align: right">Ränta</MudTh>
                        <MudTh Style="text-align: right">Amortering/mån</MudTh>
                        <MudTh Style="text-align: right">Månadskostnad</MudTh>
                        <MudTh Style="text-align: right">Extra Info</MudTh>
                        <MudTh>Åtgärder</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Namn">@context.Name</MudTd>
                        <MudTd DataLabel="Typ">
                            <MudChip T="string" Size="Size.Small" Color="GetLoanTypeColor(context.Type)">
                                @context.Type
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="Belopp" Style="text-align: right">
                            @context.Amount.ToString("C", new System.Globalization.CultureInfo("sv-SE"))
                        </MudTd>
                        <MudTd DataLabel="Ränta" Style="text-align: right">
                            @context.InterestRate.ToString("F2")%
                        </MudTd>
                        <MudTd DataLabel="Amortering/mån" Style="text-align: right">
                        @context.Amortization.ToString("C", new System.Globalization.CultureInfo("sv-SE"))
                    </MudTd>
                    <MudTd DataLabel="Månadskostnad" Style="text-align: right">
                        <MudText Color="Color.Warning">
                            @CalculateMonthlyCost(context).ToString("C", new System.Globalization.CultureInfo("sv-SE"))
                        </MudText>
                    </MudTd>
                    <MudTd DataLabel="Extra Info" Style="text-align: right">
                        @if (context.Type == "Kreditkort" && context.UtilizationRate.HasValue)
                        {
                            <MudChip T="string" Size="Size.Small" Color="@GetUtilizationColor(context.UtilizationRate.Value)">
                                Utnyttjande: @context.UtilizationRate.Value.ToString("F1")%
                            </MudChip>
                        }
                        @if (context.ExtraMonthlyPayment.HasValue && context.ExtraMonthlyPayment.Value > 0)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Info">
                                Extra: @context.ExtraMonthlyPayment.Value.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))
                            </MudChip>
                        }
                    </MudTd>
                    <MudTd DataLabel="Åtgärder">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small"
                                       OnClick="@(() => EditLoan(context))" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                                       OnClick="@(() => DeleteLoan(context.LoanId))" />
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
        </MudTabPanel>
        
        <MudTabPanel Text="Amorteringsplan" Icon="@Icons.Material.Filled.CalendarMonth">
            @if (_selectedLoanForSchedule != null && _amortizationSchedule.Any())
            {
                <div class="d-flex justify-space-between align-center mb-4">
                    <MudText Typo="Typo.h6">Amorteringsplan för @_selectedLoanForSchedule.Name</MudText>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                               StartIcon="@Icons.Material.Filled.Download" 
                               OnClick="ExportCurrentAmortizationSchedule">
                        Exportera till CSV
                    </MudButton>
                </div>
                <MudTable Items="@_amortizationSchedule.Take(60)" Dense="true" Hover="true" Striped="true">
                    <HeaderContent>
                        <MudTh>Betalning</MudTh>
                        <MudTh>Datum</MudTh>
                        <MudTh Style="text-align: right">Ingående Saldo</MudTh>
                        <MudTh Style="text-align: right">Betalning</MudTh>
                        <MudTh Style="text-align: right">Ränta</MudTh>
                        <MudTh Style="text-align: right">Amortering</MudTh>
                        <MudTh Style="text-align: right">Utgående Saldo</MudTh>
                        <MudTh Style="text-align: right">Tot. Ränta</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Betalning">@context.PaymentNumber</MudTd>
                        <MudTd DataLabel="Datum">@context.PaymentDate.ToString("yyyy-MM")</MudTd>
                        <MudTd DataLabel="Ingående Saldo" Style="text-align: right">@context.BeginningBalance.ToString("N0")</MudTd>
                        <MudTd DataLabel="Betalning" Style="text-align: right">@context.Payment.ToString("N0")</MudTd>
                        <MudTd DataLabel="Ränta" Style="text-align: right">@context.Interest.ToString("N0")</MudTd>
                        <MudTd DataLabel="Amortering" Style="text-align: right">@context.Principal.ToString("N0")</MudTd>
                        <MudTd DataLabel="Utgående Saldo" Style="text-align: right">@context.EndingBalance.ToString("N0")</MudTd>
                        <MudTd DataLabel="Tot. Ränta" Style="text-align: right">@context.TotalInterestPaid.ToString("N0")</MudTd>
                    </RowTemplate>
                </MudTable>
                @if (_amortizationSchedule.Count > 60)
                {
                    <MudText Typo="Typo.body2" Class="mt-2">Visar första 60 av @_amortizationSchedule.Count betalningar</MudText>
                }
            }
            else
            {
                <MudText>Välj ett lån från översikten för att se amorteringsplan.</MudText>
            }
        </MudTabPanel>
        
        <MudTabPanel Text="Avbetalningsstrategier" Icon="@Icons.Material.Filled.TrendingDown">
            <MudText Typo="Typo.h6" Class="mb-4">Jämför avbetalningsstrategier</MudText>
            <MudAlert Severity="Severity.Info" Class="mb-4">
                Snöboll-metoden betalar av minsta skulden först för psykologiska vinster. 
                Lavin-metoden betalar av högsta räntan först för att minimera räntekostnader.
            </MudAlert>
            
            <!-- Interactive simulation controls -->
            <MudPaper Class="pa-4 mb-4">
                <MudText Typo="Typo.h6" Class="mb-3">💡 Simuleringsverktyg</MudText>
                <MudText Typo="Typo.body2" Class="mb-3">
                    Justera din tillgängliga månadsbetalning för att se hur det påverkar avbetalningen av dina skulder.
                </MudText>
                <MudNumericField @bind-Value="_simulationMonthlyPayment" 
                                 Label="Tillgänglig månadsbetalning (kr)" 
                                 Variant="Variant.Outlined"
                                 Min="0"
                                 Format="N2"
                                 Culture="@(new System.Globalization.CultureInfo("sv-SE"))"
                                 Class="mb-3" />
                <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                           OnClick="RunSimulation" 
                           Disabled="_loans.Count() == 0">
                    Kör simulering
                </MudButton>
                @if (_simulationRun && _loans.Any())
                {
                    <MudText Typo="Typo.caption" Class="mt-2" Color="Color.Secondary">
                        Minsta månatliga betalning: @_totalMonthlyCost.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))
                    </MudText>
                }
            </MudPaper>
            
            @if (_snowballStrategy != null && _avalancheStrategy != null)
            {
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudCard Elevation="2">
                            <MudCardHeader>
                                <CardHeaderContent>
                                    <div class="d-flex justify-space-between align-center">
                                        <MudText Typo="Typo.h6">⛷️ Snöboll-metoden</MudText>
                                        <MudIconButton Icon="@Icons.Material.Filled.Download" 
                                                       Size="Size.Small" 
                                                       Color="Color.Primary"
                                                       OnClick="ExportSnowballStrategy" />
                                    </div>
                                </CardHeaderContent>
                            </MudCardHeader>
                            <MudCardContent>
                                <MudText>@_snowballStrategy.Description</MudText>
                                <MudDivider Class="my-3" />
                                <MudText><strong>Skuldfri:</strong> @_snowballStrategy.DebtFreeDate.ToString("yyyy-MM-dd")</MudText>
                                <MudText><strong>Total ränta:</strong> @_snowballStrategy.TotalInterestPaid.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))</MudText>
                                <MudText><strong>Antal månader:</strong> @_snowballStrategy.TotalMonths</MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudCard Elevation="2">
                            <MudCardHeader>
                                <CardHeaderContent>
                                    <div class="d-flex justify-space-between align-center">
                                        <MudText Typo="Typo.h6">🏔️ Lavin-metoden</MudText>
                                        <MudIconButton Icon="@Icons.Material.Filled.Download" 
                                                       Size="Size.Small" 
                                                       Color="Color.Primary"
                                                       OnClick="ExportAvalancheStrategy" />
                                    </div>
                                </CardHeaderContent>
                            </MudCardHeader>
                            <MudCardContent>
                                <MudText>@_avalancheStrategy.Description</MudText>
                                <MudDivider Class="my-3" />
                                <MudText><strong>Skuldfri:</strong> @_avalancheStrategy.DebtFreeDate.ToString("yyyy-MM-dd")</MudText>
                                <MudText><strong>Total ränta:</strong> @_avalancheStrategy.TotalInterestPaid.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))</MudText>
                                <MudText><strong>Antal månader:</strong> @_avalancheStrategy.TotalMonths</MudText>
                                
                                @if (_avalancheStrategy.TotalInterestPaid < _snowballStrategy.TotalInterestPaid)
                                {
                                    <MudAlert Severity="Severity.Success" Class="mt-3" Dense="true">
                                        Sparar @((_snowballStrategy.TotalInterestPaid - _avalancheStrategy.TotalInterestPaid).ToString("C0", new System.Globalization.CultureInfo("sv-SE"))) i ränta!
                                    </MudAlert>
                                }
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                </MudGrid>
            }
            else
            {
                <MudText>Lägg till lån för att se strategier.</MudText>
            }
        </MudTabPanel>
        
        <MudTabPanel Text="Detaljerad Simulering" Icon="@Icons.Material.Filled.Timeline">
            @if (_detailedStrategy != null && _detailedStrategy.MonthlySchedule.Any())
            {
                <MudText Typo="Typo.h6" Class="mb-4">
                    Månad-för-månad simulering: @_detailedStrategy.StrategyName
                </MudText>
                
                <MudAlert Severity="Severity.Info" Class="mb-4" Dense="true">
                    <strong>Algoritm:</strong> @_detailedStrategy.Description
                    <br/>
                    <strong>Formel:</strong> Månadsränta = (Belopp × Årsränta / 100) / 12; Amortering = Betalning - Ränta
                </MudAlert>
                
                <!-- Summary cards -->
                <MudGrid Class="mb-4">
                    <MudItem xs="12" md="3">
                        <MudCard Elevation="2">
                            <MudCardContent>
                                <MudText Typo="Typo.subtitle2">Skuldfri datum</MudText>
                                <MudText Typo="Typo.h6" Color="Color.Success">@_detailedStrategy.DebtFreeDate.ToString("yyyy-MM-dd")</MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="12" md="3">
                        <MudCard Elevation="2">
                            <MudCardContent>
                                <MudText Typo="Typo.subtitle2">Total ränta</MudText>
                                <MudText Typo="Typo.h6">@_detailedStrategy.TotalInterestPaid.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))</MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="12" md="3">
                        <MudCard Elevation="2">
                            <MudCardContent>
                                <MudText Typo="Typo.subtitle2">Antal månader</MudText>
                                <MudText Typo="Typo.h6">@_detailedStrategy.TotalMonths</MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="12" md="3">
                        <MudCard Elevation="2">
                            <MudCardContent>
                                <MudText Typo="Typo.subtitle2">Total kostnad</MudText>
                                <MudText Typo="Typo.h6">@_detailedStrategy.TotalAmountPaid.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))</MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                </MudGrid>
                
                <!-- Loan summaries -->
                <MudText Typo="Typo.h6" Class="mb-3">Avbetalningsordning</MudText>
                <MudTable Items="@_detailedStrategy.LoanSummaries" Dense="true" Hover="true" Striped="true" Class="mb-4">
                    <HeaderContent>
                        <MudTh>Ordning</MudTh>
                        <MudTh>Lån</MudTh>
                        <MudTh Style="text-align: right">Belopp</MudTh>
                        <MudTh Style="text-align: right">Ränta</MudTh>
                        <MudTh>Betalt datum</MudTh>
                        <MudTh Style="text-align: right">Månader</MudTh>
                        <MudTh Style="text-align: right">Total ränta</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Ordning">
                            <MudChip T="string" Size="Size.Small" Color="Color.Primary">@context.PayoffOrder</MudChip>
                        </MudTd>
                        <MudTd DataLabel="Lån">@context.LoanName</MudTd>
                        <MudTd DataLabel="Belopp" Style="text-align: right">@context.OriginalAmount.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))</MudTd>
                        <MudTd DataLabel="Ränta" Style="text-align: right">@context.InterestRate.ToString("F2")%</MudTd>
                        <MudTd DataLabel="Betalt datum">@context.PayoffDate.ToString("yyyy-MM-dd")</MudTd>
                        <MudTd DataLabel="Månader" Style="text-align: right">@context.MonthsToPayoff</MudTd>
                        <MudTd DataLabel="Total ränta" Style="text-align: right">@context.TotalInterestPaid.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))</MudTd>
                    </RowTemplate>
                </MudTable>
                
                <!-- Monthly schedule -->
                <MudText Typo="Typo.h6" Class="mb-3">Månatlig betalningsplan</MudText>
                <MudTable Items="@_detailedStrategy.MonthlySchedule.Take(60)" Dense="true" Hover="true" Striped="true">
                    <HeaderContent>
                        <MudTh>Månad</MudTh>
                        <MudTh>Datum</MudTh>
                        <MudTh Style="text-align: right">Total betalning</MudTh>
                        <MudTh Style="text-align: right">Amortering</MudTh>
                        <MudTh Style="text-align: right">Ränta</MudTh>
                        <MudTh Style="text-align: right">Kvar skuld</MudTh>
                        <MudTh>Aktiva lån</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Månad">@context.MonthNumber</MudTd>
                        <MudTd DataLabel="Datum">@context.PaymentDate.ToString("yyyy-MM")</MudTd>
                        <MudTd DataLabel="Total betalning" Style="text-align: right">@context.TotalPayment.ToString("N0")</MudTd>
                        <MudTd DataLabel="Amortering" Style="text-align: right">@context.TotalPrincipal.ToString("N0")</MudTd>
                        <MudTd DataLabel="Ränta" Style="text-align: right">@context.TotalInterest.ToString("N0")</MudTd>
                        <MudTd DataLabel="Kvar skuld" Style="text-align: right">@context.RemainingTotalDebt.ToString("N0")</MudTd>
                        <MudTd DataLabel="Aktiva lån">
                            @foreach (var loan in context.LoanPayments.Where(l => l.EndingBalance > 0))
                            {
                                <MudChip T="string" Size="Size.Small" 
                                         Color="@(loan.IsFocusLoan ? Color.Primary : Color.Default)">
                                    @loan.LoanName
                                </MudChip>
                            }
                            @foreach (var loan in context.LoanPayments.Where(l => l.IsPaidOff))
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Success">
                                    ✓ @loan.LoanName
                                </MudChip>
                            }
                        </MudTd>
                    </RowTemplate>
                </MudTable>
                @if (_detailedStrategy.MonthlySchedule.Count > 60)
                {
                    <MudText Typo="Typo.body2" Class="mt-2">
                        Visar första 60 av @_detailedStrategy.MonthlySchedule.Count månader
                    </MudText>
                }
            }
            else
            {
                <MudText>Kör en simulering i fliken "Avbetalningsstrategier" för att se detaljerad månatlig plan.</MudText>
            }
        </MudTabPanel>
        
        <MudTabPanel Text="Bolåneanalys" Icon="@Icons.Material.Filled.HomeWork">
            @if (_mortgages.Any())
            {
                <MudText Typo="Typo.h6" Class="mb-4">Analys av bolån enligt svenska regler</MudText>
                
                <MudAlert Severity="Severity.Info" Class="mb-4" Dense="true">
                    <strong>Svenska amorteringskrav:</strong><br/>
                    • Belåningsgrad över 70%: 2% årlig amortering av ursprungligt lånebelopp<br/>
                    • Belåningsgrad 50-70%: 1% årlig amortering av ursprungligt lånebelopp<br/>
                    • Belåningsgrad under 50%: Inget amorteringskrav
                </MudAlert>
                
                @foreach (var mortgage in _mortgages)
                {
                    var amortRequirement = MortgageAnalysisService.CalculateAmortizationRequirement(mortgage);
                    var riskAnalysis = MortgageAnalysisService.AnalyzeInterestRateRisk(mortgage, new[] { 0m, 1m, 2m, 3m });
                    
                    <MudCard Elevation="2" Class="mb-4">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">@mortgage.Name</MudText>
                                @if (!string.IsNullOrEmpty(mortgage.PropertyAddress))
                                {
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">@mortgage.PropertyAddress</MudText>
                                }
                            </CardHeaderContent>
                            <CardHeaderActions>
                                <MudChip T="string" Size="Size.Small" Color="@GetRiskLevelColor(riskAnalysis.RiskLevel)">
                                    @GetRiskLevelText(riskAnalysis.RiskLevel)
                                </MudChip>
                            </CardHeaderActions>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudGrid>
                                <!-- Loan details -->
                                <MudItem xs="12" md="6">
                                    <MudText Typo="Typo.subtitle2" Class="mb-2">📊 Låneuppgifter</MudText>
                                    <MudText><strong>Lånebelopp:</strong> @mortgage.Amount.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))</MudText>
                                    @if (mortgage.PropertyValue.HasValue)
                                    {
                                        <MudText><strong>Fastighetsvärde:</strong> @mortgage.PropertyValue.Value.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))</MudText>
                                        <MudText><strong>Belåningsgrad (LTV):</strong> @amortRequirement.LoanToValueRatio.ToString("F1")%</MudText>
                                    }
                                    <MudText><strong>Aktuell ränta:</strong> @mortgage.InterestRate.ToString("F2")%</MudText>
                                    @if (!string.IsNullOrEmpty(mortgage.LoanProvider))
                                    {
                                        <MudText><strong>Bank:</strong> @mortgage.LoanProvider</MudText>
                                    }
                                </MudItem>
                                
                                <!-- Interest rate binding -->
                                <MudItem xs="12" md="6">
                                    <MudText Typo="Typo.subtitle2" Class="mb-2">🔒 Räntebindning</MudText>
                                    <MudText><strong>Typ:</strong> @(mortgage.IsFixedRate ? "Bunden ränta" : "Rörlig ränta")</MudText>
                                    @if (mortgage.IsFixedRate && mortgage.RateResetDate.HasValue)
                                    {
                                        <MudText><strong>Bindning löper ut:</strong> @mortgage.RateResetDate.Value.ToString("yyyy-MM-dd")</MudText>
                                        @if (riskAnalysis.MonthsUntilRateReset.HasValue)
                                        {
                                            <MudText><strong>Månader kvar:</strong> @riskAnalysis.MonthsUntilRateReset månader</MudText>
                                        }
                                        @if (mortgage.BindingPeriodMonths.HasValue)
                                        {
                                            <MudText><strong>Bindningsperiod:</strong> @mortgage.BindingPeriodMonths månader</MudText>
                                        }
                                    }
                                    else if (!mortgage.IsFixedRate)
                                    {
                                        <MudAlert Severity="Severity.Warning" Dense="true" Class="mt-2">
                                            Rörlig ränta innebär högre ränterisk. Överväg att binda räntan.
                                        </MudAlert>
                                    }
                                </MudItem>
                                
                                <!-- Amortization requirement -->
                                <MudItem xs="12" md="6">
                                    <MudText Typo="Typo.subtitle2" Class="mb-2">💰 Amorteringskrav</MudText>
                                    <MudText Class="mb-2">@amortRequirement.RuleDescription</MudText>
                                    <MudText><strong>Krävs per månad:</strong> @amortRequirement.RequiredMonthlyAmortization.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))</MudText>
                                    <MudText><strong>Du amorterar:</strong> @amortRequirement.CurrentMonthlyAmortization.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))</MudText>
                                    
                                    @if (!amortRequirement.MeetsRequirement)
                                    {
                                        <MudAlert Severity="Severity.Error" Dense="true" Class="mt-2">
                                            ⚠️ Du amorterar <strong>@amortRequirement.MonthlyShortage.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))</strong> mindre per månad än kravet!
                                        </MudAlert>
                                    }
                                    else if (amortRequirement.RequiredMonthlyAmortization > 0)
                                    {
                                        <MudAlert Severity="Severity.Success" Dense="true" Class="mt-2">
                                            ✓ Du uppfyller amorteringskravet
                                        </MudAlert>
                                    }
                                    
                                    @if (amortRequirement.YearsToPayoff.HasValue)
                                    {
                                        <MudText Class="mt-2"><strong>Beräknad återbetalningstid:</strong> @amortRequirement.YearsToPayoff år</MudText>
                                    }
                                </MudItem>
                                
                                <!-- Interest rate risk -->
                                <MudItem xs="12" md="6">
                                    <MudText Typo="Typo.subtitle2" Class="mb-2">⚠️ Ränterisk</MudText>
                                    <MudText Class="mb-2">@riskAnalysis.RiskDescription</MudText>
                                    <MudText Typo="Typo.body2" Class="mb-2"><strong>Räntescenarier:</strong></MudText>
                                    <MudSimpleTable Dense="true" Hover="true" Class="mt-2">
                                        <thead>
                                            <tr>
                                                <th>Scenario</th>
                                                <th style="text-align: right">Ränta</th>
                                                <th style="text-align: right">Månadskostnad</th>
                                                <th style="text-align: right">Ökning</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var scenario in riskAnalysis.Scenarios)
                                            {
                                                <tr>
                                                    <td>@scenario.ScenarioName</td>
                                                    <td style="text-align: right">@scenario.InterestRate.ToString("F2")%</td>
                                                    <td style="text-align: right">@scenario.MonthlyCost.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))</td>
                                                    <td style="text-align: right">
                                                        @if (scenario.MonthlyIncrease > 0)
                                                        {
                                                            <span style="color: var(--mud-palette-error)">+@scenario.MonthlyIncrease.ToString("C0", new System.Globalization.CultureInfo("sv-SE"))</span>
                                                        }
                                                        else
                                                        {
                                                            <span>-</span>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </MudSimpleTable>
                                </MudItem>
                            </MudGrid>
                        </MudCardContent>
                    </MudCard>
                }
                
                <!-- Upcoming rate resets -->
                @if (_upcomingRateResets.Any())
                {
                    <MudAlert Severity="Severity.Warning" Class="mt-4">
                        <MudText Typo="Typo.h6" Class="mb-2">⏰ Kommande räntebindningar som löper ut</MudText>
                        @foreach (var loan in _upcomingRateResets)
                        {
                            <MudText>• <strong>@loan.Name</strong> - Bindning löper ut @loan.RateResetDate?.ToString("yyyy-MM-dd")</MudText>
                        }
                    </MudAlert>
                }
            }
            else
            {
                <MudText>Inga bolån registrerade. Lägg till ett bolån för att se analys.</MudText>
            }
        </MudTabPanel>
    </MudTabs>
}

@code {
    private bool _loading = true;
    private bool _showCreateForm = false;
    private IEnumerable<Loan> _loans = new List<Loan>();
    private IEnumerable<Loan> _mortgages = new List<Loan>();
    private IEnumerable<Loan> _upcomingRateResets = new List<Loan>();
    private decimal _totalDebt = 0;
    private decimal _totalMonthlyCost = 0;
    private DateTime? _debtFreeDate = null;
    private Loan _formLoan = new Loan();
    private Loan? _editingLoan = null;
    
    // Amortization schedule
    private Loan? _selectedLoanForSchedule = null;
    private List<AmortizationScheduleEntry> _amortizationSchedule = new();
    
    // Debt strategies
    private DebtPayoffStrategy? _snowballStrategy = null;
    private DebtPayoffStrategy? _avalancheStrategy = null;
    
    // Detailed strategy
    private DetailedDebtPayoffStrategy? _detailedStrategy = null;
    
    // Simulation
    private decimal _simulationMonthlyPayment = 0;
    private bool _simulationRun = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;
        _loans = await LoanService.GetAllLoansAsync();
        _totalDebt = _loans.Sum(l => l.Amount);
        _totalMonthlyCost = _loans.Sum(l => CalculateMonthlyCost(l));
        
        // Load mortgages and upcoming rate resets
        _mortgages = _loans.Where(l => l.Type == "Bolån").ToList();
        _upcomingRateResets = await MortgageAnalysisService.GetUpcomingRateResetsAsync(6);
        
        // Calculate debt-free date
        _debtFreeDate = await DebtStrategyService.CalculateDebtFreeDate();
        
        // Load first loan's amortization schedule
        if (_loans.Any())
        {
            _selectedLoanForSchedule = _loans.First();
            _amortizationSchedule = DebtStrategyService.GenerateAmortizationSchedule(
                _selectedLoanForSchedule, 
                _selectedLoanForSchedule.ExtraMonthlyPayment ?? 0
            );
            
            // Calculate strategies if we have loans
            var totalMinPayment = _loans.Sum(l => l.Amortization + (l.Amount * l.InterestRate / 100 / 12));
            var strategies = await DebtStrategyService.CompareStrategies(totalMinPayment);
            _snowballStrategy = strategies.Snowball;
            _avalancheStrategy = strategies.Avalanche;
            
            // Initialize simulation payment to minimum payment
            if (_simulationMonthlyPayment == 0)
            {
                _simulationMonthlyPayment = totalMinPayment;
            }
        }
        
        _loading = false;
    }

    private decimal CalculateMonthlyCost(Loan loan)
    {
        // Månadsränta = (Belopp * Ränta/100) / 12 + Amortering
        var monthlyInterest = (loan.Amount * loan.InterestRate / 100) / 12;
        return monthlyInterest + loan.Amortization;
    }

    private Color GetLoanTypeColor(string type)
    {
        return type switch
        {
            "Bolån" => Color.Primary,
            "CSN-lån" => Color.Info,
            "Privatlån" => Color.Warning,
            "Kreditkort" => Color.Secondary,
            "BNPL/Avbetalning" => Color.Tertiary,
            _ => Color.Default
        };
    }

    private Color GetUtilizationColor(decimal utilizationRate)
    {
        if (utilizationRate < 30) return Color.Success;
        if (utilizationRate < 50) return Color.Info;
        if (utilizationRate < 70) return Color.Warning;
        return Color.Error;
    }

    private void ToggleCreateForm()
    {
        _showCreateForm = !_showCreateForm;
        if (_showCreateForm)
        {
            _formLoan = new Loan();
            _editingLoan = null;
        }
    }

    private void EditLoan(Loan loan)
    {
        _editingLoan = loan;
        _formLoan = new Loan
        {
            LoanId = loan.LoanId,
            Name = loan.Name,
            Type = loan.Type,
            Amount = loan.Amount,
            InterestRate = loan.InterestRate,
            Amortization = loan.Amortization,
            ExtraMonthlyPayment = loan.ExtraMonthlyPayment,
            CreditLimit = loan.CreditLimit,
            MinimumPayment = loan.MinimumPayment,
            InstallmentMonths = loan.InstallmentMonths,
            InstallmentFee = loan.InstallmentFee,
            Priority = loan.Priority,
            // Mortgage-specific fields
            PropertyAddress = loan.PropertyAddress,
            PropertyValue = loan.PropertyValue,
            LoanProvider = loan.LoanProvider,
            IsFixedRate = loan.IsFixedRate,
            RateResetDate = loan.RateResetDate,
            BindingPeriodMonths = loan.BindingPeriodMonths
        };
        _showCreateForm = true;
    }

    private async Task SaveLoan()
    {
        if (string.IsNullOrWhiteSpace(_formLoan.Name))
        {
            Snackbar.Add("Namn är obligatoriskt", Severity.Error);
            return;
        }

        if (string.IsNullOrWhiteSpace(_formLoan.Type))
        {
            Snackbar.Add("Typ är obligatorisk", Severity.Error);
            return;
        }

        if (_formLoan.Amount <= 0)
        {
            Snackbar.Add("Belopp måste vara större än 0", Severity.Error);
            return;
        }

        try
        {
            if (_editingLoan != null)
            {
                await LoanService.UpdateLoanAsync(_formLoan);
                Snackbar.Add("Lån/Kredit uppdaterat!", Severity.Success);
            }
            else
            {
                await LoanService.CreateLoanAsync(_formLoan);
                Snackbar.Add("Lån/Kredit tillagt!", Severity.Success);
            }

            _showCreateForm = false;
            _editingLoan = null;
            await LoadData();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fel: {ex.Message}", Severity.Error);
        }
    }

    private void CancelForm()
    {
        _showCreateForm = false;
        _editingLoan = null;
        _formLoan = new Loan();
    }

    private async Task DeleteLoan(int id)
    {
        var result = await DialogService.ShowMessageBoxAsync(
            "Bekräfta borttagning",
            "Är du säker på att du vill ta bort detta lån/kredit?",
            yesText: "Ja", cancelText: "Avbryt");
        if (result == true)
        {
            await LoanService.DeleteLoanAsync(id);
            Snackbar.Add("Lån/Kredit borttaget", Severity.Success);
            await LoadData();
        }
    }
    
    private void ExportCurrentAmortizationSchedule()
    {
        if (_selectedLoanForSchedule == null)
        {
            Snackbar.Add("Inget lån valt", Severity.Warning);
            return;
        }
        
        var extra = _selectedLoanForSchedule.ExtraMonthlyPayment ?? 0;
        var url = $"/api/debtstrategy/export-amortization-schedule/{_selectedLoanForSchedule.LoanId}?extraMonthlyPayment={extra}";
        
        // Open download in new window
        NavigationManager.NavigateTo(url, true);
        Snackbar.Add("Exporterar amorteringsplan...", Severity.Info);
    }
    
    private void ExportSnowballStrategy()
    {
        if (_snowballStrategy == null)
            return;
            
        var url = $"/api/debtstrategy/export-strategy?strategyType=snowball&availableMonthlyPayment={_simulationMonthlyPayment}";
        NavigationManager.NavigateTo(url, true);
        Snackbar.Add($"Exporterar {_snowballStrategy.StrategyName} strategi...", Severity.Info);
    }
    
    private void ExportAvalancheStrategy()
    {
        if (_avalancheStrategy == null)
            return;
            
        var url = $"/api/debtstrategy/export-strategy?strategyType=avalanche&availableMonthlyPayment={_simulationMonthlyPayment}";
        NavigationManager.NavigateTo(url, true);
        Snackbar.Add($"Exporterar {_avalancheStrategy.StrategyName} strategi...", Severity.Info);
    }
    
    private async Task RunSimulation()
    {
        if (_simulationMonthlyPayment < _totalMonthlyCost)
        {
            Snackbar.Add($"Månadsbetalningen måste vara minst {_totalMonthlyCost:C0} för att täcka minimumbetalningarna", Severity.Warning);
            return;
        }
        
        try
        {
            _loading = true;
            
            // Calculate strategies with the simulation amount
            var strategies = await DebtStrategyService.CompareStrategies(_simulationMonthlyPayment);
            _snowballStrategy = strategies.Snowball;
            _avalancheStrategy = strategies.Avalanche;
            
            // Generate detailed strategy (default to avalanche as it's more optimal)
            _detailedStrategy = await DebtStrategyService.GenerateDetailedStrategy("Avalanche", _simulationMonthlyPayment);
            
            _simulationRun = true;
            Snackbar.Add("Simulering klar!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fel vid simulering: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }
    
    // Helper methods for mortgage analysis UI
    private Color GetRiskLevelColor(RiskLevel riskLevel)
    {
        return riskLevel switch
        {
            RiskLevel.Low => Color.Success,
            RiskLevel.Medium => Color.Warning,
            RiskLevel.High => Color.Error,
            _ => Color.Default
        };
    }
    
    private string GetRiskLevelText(RiskLevel riskLevel)
    {
        return riskLevel switch
        {
            RiskLevel.Low => "Låg risk",
            RiskLevel.Medium => "Måttlig risk",
            RiskLevel.High => "Hög risk",
            _ => "Okänd risk"
        };
    }
}
