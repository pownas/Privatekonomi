@page "/family/households/{HouseholdId:int}"
@page "/households/{HouseholdId:int}"
@using Privatekonomi.Core.Models
@using Privatekonomi.Core.Services
@inject IHouseholdService HouseholdService
@inject NavigationManager NavigationManager

<PageTitle>@(household?.Name ?? "Hushåll")</PageTitle>

@if (household == null)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
}
else
{
    <MudBreadcrumbs Items="breadcrumbs" Class="mb-4" />
    
    <MudText Typo="Typo.h4" Class="mb-2">
        <MudIcon Icon="@Icons.Material.Filled.Group" Color="Color.Primary" Class="mr-2" aria-hidden="true" />
        @household.Name
    </MudText>
    @if (!string.IsNullOrEmpty(household.Description))
    {
        <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">@household.Description</MudText>
    }

    <MudButton Variant="Variant.Filled" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.ChildCare" OnClick="@(() => NavigationManager.NavigateTo($"/family/households/{HouseholdId}/allowances"))" Class="mb-4">
        Barnkonton & Veckopeng
    </MudButton>

    <MudTabs Elevation="2" Rounded="true" Color="Color.Primary" Class="mt-4">
        <MudTabPanel Text="Medlemmar" Icon="@Icons.Material.Filled.People">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.PersonAdd" OnClick="OpenAddMemberDialog" Class="my-4">
                Lägg till medlem
            </MudButton>

            @if (!household.Members.Any())
            {
                <MudAlert Severity="Severity.Info" Class="mt-4">Inga medlemmar ännu. Lägg till minst 2 medlemmar för att dela kostnader.</MudAlert>
            }
            else
            {
                <MudTable Items="@household.Members.Where(m => m.IsActive)" Class="mt-4" Hover="true">
                    <HeaderContent>
                        <MudTh>Namn</MudTh>
                        <MudTh>E-post</MudTh>
                        <MudTh>Gick med</MudTh>
                        <MudTh>Åtgärder</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Namn">@context.Name</MudTd>
                        <MudTd DataLabel="E-post">@context.Email</MudTd>
                        <MudTd DataLabel="Gick med">@context.JoinedDate.ToString("yyyy-MM-dd")</MudTd>
                        <MudTd DataLabel="Åtgärder">
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="@(() => RemoveMember(context.HouseholdMemberId))" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            }
        </MudTabPanel>

        <MudTabPanel Text="Utgifter" Icon="@Icons.Material.Filled.Receipt">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="OpenAddExpenseDialog" Class="my-4">
                Lägg till utgift
            </MudButton>

            @if (!household.SharedExpenses.Any())
            {
                <MudAlert Severity="Severity.Info" Class="mt-4">Inga delade utgifter ännu.</MudAlert>
            }
            else
            {
                <MudTable Items="@household.SharedExpenses.OrderByDescending(e => e.ExpenseDate)" Class="mt-4" Hover="true">
                    <HeaderContent>
                        <MudTh>Namn</MudTh>
                        <MudTh>Typ</MudTh>
                        <MudTh>Belopp</MudTh>
                        <MudTh>Fördelning</MudTh>
                        <MudTh>Datum</MudTh>
                        <MudTh>Åtgärder</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Namn">@context.Name</MudTd>
                        <MudTd DataLabel="Typ">@GetExpenseTypeText(context.Type)</MudTd>
                        <MudTd DataLabel="Belopp">@context.TotalAmount.ToString("N2") kr</MudTd>
                        <MudTd DataLabel="Fördelning">@GetSplitMethodText(context.SplitMethod)</MudTd>
                        <MudTd DataLabel="Datum">@context.ExpenseDate.ToString("yyyy-MM-dd")</MudTd>
                        <MudTd DataLabel="Åtgärder">
                            <MudIconButton Icon="@Icons.Material.Filled.Visibility" Color="Color.Primary" Size="Size.Small" OnClick="@(() => ViewExpenseDetails(context.SharedExpenseId))" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="@(() => DeleteExpense(context.SharedExpenseId))" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            }
        </MudTabPanel>

        <MudTabPanel Text="Rapport" Icon="@Icons.Material.Filled.BarChart">
            <MudText Typo="Typo.h6" Class="my-4">Kostnadsfördelning per medlem</MudText>
            
            @if (memberTotals != null && memberTotals.Any())
            {
                <MudSimpleTable Class="mt-4" Hover="true">
                    <thead>
                        <tr>
                            <th>Medlem</th>
                            <th style="text-align: right;">Total kostnad</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var memberTotal in memberTotals)
                        {
                            var member = household.Members.FirstOrDefault(m => m.HouseholdMemberId == memberTotal.Key);
                            @if (member != null)
                            {
                                <tr>
                                    <td>@member.Name</td>
                                    <td style="text-align: right;"><strong>@memberTotal.Value.ToString("N2") kr</strong></td>
                                </tr>
                            }
                        }
                    </tbody>
                </MudSimpleTable>
            }
            else
            {
                <MudAlert Severity="Severity.Info" Class="mt-4">Inga utgifter att visa i rapporten.</MudAlert>
            }
        </MudTabPanel>

        <MudTabPanel Text="Tidslinje" Icon="@Icons.Material.Filled.Timeline">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="OpenAddActivityDialog" Class="my-4">
                Lägg till aktivitet
            </MudButton>

            <MudStack Row="true" Class="mb-4">
                <MudDatePicker @bind-Date="activityFilterStartDate" Label="Från datum" Clearable="true" />
                <MudDatePicker @bind-Date="activityFilterEndDate" Label="Till datum" Clearable="true" />
                <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="FilterActivities">Filtrera</MudButton>
            </MudStack>

            @if (!filteredActivities.Any())
            {
                <MudAlert Severity="Severity.Info" Class="mt-4">Inga aktiviteter ännu. Lägg till genomförda aktiviteter för att se dem här.</MudAlert>
            }
            else
            {
                <MudTimeline TimelineOrientation="TimelineOrientation.Vertical" TimelinePosition="TimelinePosition.Start" Class="mt-4">
                    @foreach (var activity in filteredActivities)
                    {
                        <MudTimelineItem Color="Color.Primary" Size="Size.Small">
                            <ItemContent>
                                <MudCard Elevation="2" Class="mb-2">
                                    <MudCardContent>
                                        <MudText Typo="Typo.h6">@activity.Title</MudText>
                                        @if (!string.IsNullOrEmpty(activity.Description))
                                        {
                                            <MudText Typo="Typo.body2" Color="Color.Secondary">@activity.Description</MudText>
                                        }
                                        <MudChip T="string" Size="Size.Small" Color="Color.Info">@GetActivityTypeText(activity.Type)</MudChip>
                                        @if (activity.CompletedByMember != null)
                                        {
                                            <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.Person">@activity.CompletedByMember.Name</MudChip>
                                        }
                                    </MudCardContent>
                                    <MudCardActions>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">@activity.CompletedDate.ToString("yyyy-MM-dd HH:mm")</MudText>
                                        <MudSpacer />
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="@(() => DeleteActivity(activity.HouseholdActivityId))" />
                                    </MudCardActions>
                                </MudCard>
                            </ItemContent>
                        </MudTimelineItem>
                    }
                </MudTimeline>
            }
        </MudTabPanel>

        <MudTabPanel Text="Att göra" Icon="@Icons.Material.Filled.Checklist">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="OpenAddTaskDialog" Class="my-4">
                Lägg till uppgift
            </MudButton>

            <MudStack Row="true" Class="mb-4">
                <MudTextField @bind-Value="taskSearchTerm" Label="Sök uppgifter" Immediate="true" Clearable="true" 
                              Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" />
                <MudSwitch @bind-Value="showCompletedTasks" Label="Visa genomförda" Color="Color.Primary" />
            </MudStack>

            @if (!filteredTasks.Any())
            {
                <MudAlert Severity="Severity.Info" Class="mt-4">Inga uppgifter ännu. Lägg till uppgifter att göra.</MudAlert>
            }
            else
            {
                <MudList T="string" Class="mt-4">
                    @foreach (var task in filteredTasks)
                    {
                        <MudListItem T="string" Class="@(task.IsCompleted ? "opacity-70" : "")">
                            <MudCard Elevation="2" Class="mb-2">
                                <MudCardContent>
                                    <MudStack Row="true">
                                        <MudCheckBox T="bool" Value="@task.IsCompleted" 
                                                     ValueChanged="@((bool value) => ToggleTaskComplete(task.HouseholdTaskId, value))"
                                                     Color="Color.Success" />
                                        <MudStack Spacing="1" Style="flex-grow: 1;">
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                <MudText Typo="Typo.h6" Style="@(task.IsCompleted ? "text-decoration: line-through;" : "")">
                                                    @task.Title
                                                </MudText>
                                                @if (task.Priority == HouseholdTaskPriority.High)
                                                {
                                                    <MudChip T="string" Size="Size.Small" Color="Color.Error" Icon="@Icons.Material.Filled.PriorityHigh">Hög</MudChip>
                                                }
                                                else if (task.Priority == HouseholdTaskPriority.Low)
                                                {
                                                    <MudChip T="string" Size="Size.Small" Color="Color.Default">Låg</MudChip>
                                                }
                                                <MudChip T="string" Size="Size.Small" Color="Color.Info">@GetActivityTypeText(task.Category)</MudChip>
                                            </MudStack>
                                            @if (!string.IsNullOrEmpty(task.Description))
                                            {
                                                <MudText Typo="Typo.body2" Color="Color.Secondary">@task.Description</MudText>
                                            }
                                            <MudStack Row="true" Spacing="2">
                                                @if (task.DueDate.HasValue)
                                                {
                                                    var isOverdue = !task.IsCompleted && task.DueDate.Value < DateTime.Today;
                                                    <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.CalendarToday" 
                                                             Color="@(isOverdue ? Color.Error : Color.Default)">
                                                        Förfaller: @task.DueDate.Value.ToString("yyyy-MM-dd")
                                                    </MudChip>
                                                }
                                                @if (task.AssignedToMember != null)
                                                {
                                                    <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.Person">
                                                        @task.AssignedToMember.Name
                                                    </MudChip>
                                                }
                                                @if (task.IsCompleted && task.CompletedByMember != null)
                                                {
                                                    <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success">
                                                        Genomförd av @task.CompletedByMember.Name
                                                    </MudChip>
                                                }
                                            </MudStack>
                                        </MudStack>
                                    </MudStack>
                                </MudCardContent>
                                <MudCardActions>
                                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small" 
                                                   OnClick="@(() => OpenEditTaskDialog(task))" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" 
                                                   OnClick="@(() => DeleteTask(task.HouseholdTaskId))" />
                                </MudCardActions>
                            </MudCard>
                        </MudListItem>
                    }
                </MudList>
            }
        </MudTabPanel>
    </MudTabs>
}

<!-- Add Member Dialog -->
<MudDialog @bind-Visible="showAddMemberDialog" Options="dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">Lägg till medlem</MudText>
    </TitleContent>
    <DialogContent>
        <MudTextField @bind-Value="newMember.Name" Label="Namn" Required="true" />
        <MudTextField @bind-Value="newMember.Email" Label="E-post" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseAddMemberDialog">Avbryt</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="AddMember">Lägg till</MudButton>
    </DialogActions>
</MudDialog>

<!-- Add Expense Dialog -->
<MudDialog @bind-Visible="showAddExpenseDialog" Options="dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">Lägg till delad utgift</MudText>
    </TitleContent>
    <DialogContent>
        <MudTextField @bind-Value="newExpense.Name" Label="Namn" Required="true" />
        <MudTextField @bind-Value="newExpense.Description" Label="Beskrivning" Lines="2" />
        <MudNumericField @bind-Value="newExpense.TotalAmount" Label="Totalt belopp" Adornment="Adornment.End" AdornmentText="kr" Required="true" />
        <MudSelect @bind-Value="newExpense.Type" Label="Typ" Required="true">
            <MudSelectItem Value="@ExpenseType.Rent">Hyra</MudSelectItem>
            <MudSelectItem Value="@ExpenseType.Electricity">El</MudSelectItem>
            <MudSelectItem Value="@ExpenseType.Internet">Bredband</MudSelectItem>
            <MudSelectItem Value="@ExpenseType.Water">Vatten</MudSelectItem>
            <MudSelectItem Value="@ExpenseType.Heating">Värme</MudSelectItem>
            <MudSelectItem Value="@ExpenseType.Insurance">Försäkring</MudSelectItem>
            <MudSelectItem Value="@ExpenseType.Other">Övrigt</MudSelectItem>
        </MudSelect>
        <MudDatePicker @bind-Date="expenseDate" Label="Datum" Required="true" />
        <MudSelect @bind-Value="newExpense.SplitMethod" Label="Fördelningsmetod" Required="true">
            <MudSelectItem Value="@SplitMethod.Equal">Jämnt fördelat</MudSelectItem>
            <MudSelectItem Value="@SplitMethod.ByPercentage">Efter procent</MudSelectItem>
            <MudSelectItem Value="@SplitMethod.ByAmount">Efter specifikt belopp</MudSelectItem>
            <MudSelectItem Value="@SplitMethod.ByRoomSize">Efter rumsyta</MudSelectItem>
        </MudSelect>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseAddExpenseDialog">Avbryt</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="AddExpense">Lägg till</MudButton>
    </DialogActions>
</MudDialog>

<!-- Expense Details Dialog -->
<MudDialog @bind-Visible="showExpenseDetailsDialog" Options="dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">Utgiftsdetaljer</MudText>
    </TitleContent>
    <DialogContent>
        @if (selectedExpense != null)
        {
            <MudText><strong>Namn:</strong> @selectedExpense.Name</MudText>
            <MudText><strong>Typ:</strong> @GetExpenseTypeText(selectedExpense.Type)</MudText>
            <MudText><strong>Totalt belopp:</strong> @selectedExpense.TotalAmount.ToString("N2") kr</MudText>
            <MudText><strong>Fördelningsmetod:</strong> @GetSplitMethodText(selectedExpense.SplitMethod)</MudText>
            <MudText Class="mt-4"><strong>Fördelning per medlem:</strong></MudText>
            <MudSimpleTable Class="mt-2">
                <thead>
                    <tr>
                        <th>Medlem</th>
                        <th style="text-align: right;">Belopp</th>
                        <th style="text-align: right;">Procent</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var share in selectedExpense.ExpenseShares)
                    {
                        <tr>
                            <td>@share.HouseholdMember?.Name</td>
                            <td style="text-align: right;">@share.ShareAmount.ToString("N2") kr</td>
                            <td style="text-align: right;">@share.SharePercentage?.ToString("N1")%</td>
                        </tr>
                    }
                </tbody>
            </MudSimpleTable>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseExpenseDetailsDialog">Stäng</MudButton>
    </DialogActions>
</MudDialog>

<!-- Add Activity Dialog -->
<MudDialog @bind-Visible="showAddActivityDialog" Options="dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">Lägg till aktivitet</MudText>
    </TitleContent>
    <DialogContent>
        <MudTextField @bind-Value="newActivity.Title" Label="Titel" Required="true" />
        <MudTextField @bind-Value="newActivity.Description" Label="Beskrivning" Lines="3" />
        <MudSelect @bind-Value="newActivity.Type" Label="Typ" Required="true">
            <MudSelectItem Value="@HouseholdActivityType.General">Allmänt</MudSelectItem>
            <MudSelectItem Value="@HouseholdActivityType.Cleaning">Städning</MudSelectItem>
            <MudSelectItem Value="@HouseholdActivityType.Maintenance">Underhåll</MudSelectItem>
            <MudSelectItem Value="@HouseholdActivityType.Shopping">Inköp</MudSelectItem>
            <MudSelectItem Value="@HouseholdActivityType.Cooking">Matlagning</MudSelectItem>
            <MudSelectItem Value="@HouseholdActivityType.Repair">Reparation</MudSelectItem>
            <MudSelectItem Value="@HouseholdActivityType.Other">Övrigt</MudSelectItem>
        </MudSelect>
        <MudDatePicker @bind-Date="activityCompletedDate" Label="Genomförd datum" Required="true" />
        @if (household?.Members.Any(m => m.IsActive) == true)
        {
            <MudSelect @bind-Value="selectedActivityMemberId" Label="Genomförd av (valfritt)">
                <MudSelectItem Value="@((int?)null)">Ingen vald</MudSelectItem>
                @foreach (var member in household.Members.Where(m => m.IsActive))
                {
                    <MudSelectItem Value="@((int?)member.HouseholdMemberId)">@member.Name</MudSelectItem>
                }
            </MudSelect>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseAddActivityDialog">Avbryt</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="AddActivity">Lägg till</MudButton>
    </DialogActions>
</MudDialog>

<!-- Add/Edit Task Dialog -->
<MudDialog @bind-Visible="showAddTaskDialog" Options="dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">@(editingTask != null ? "Redigera uppgift" : "Lägg till uppgift")</MudText>
    </TitleContent>
    <DialogContent>
        <MudTextField @bind-Value="newTask.Title" Label="Titel" Required="true" />
        <MudTextField @bind-Value="newTask.Description" Label="Beskrivning" Lines="3" />
        <MudSelect @bind-Value="newTask.Category" Label="Kategori" Required="true">
            <MudSelectItem Value="@HouseholdActivityType.General">Allmänt</MudSelectItem>
            <MudSelectItem Value="@HouseholdActivityType.Cleaning">Städning</MudSelectItem>
            <MudSelectItem Value="@HouseholdActivityType.Maintenance">Underhåll</MudSelectItem>
            <MudSelectItem Value="@HouseholdActivityType.Shopping">Inköp</MudSelectItem>
            <MudSelectItem Value="@HouseholdActivityType.Cooking">Matlagning</MudSelectItem>
            <MudSelectItem Value="@HouseholdActivityType.Repair">Reparation</MudSelectItem>
            <MudSelectItem Value="@HouseholdActivityType.Other">Övrigt</MudSelectItem>
        </MudSelect>
        <MudSelect @bind-Value="newTask.Priority" Label="Prioritet" Required="true">
            <MudSelectItem Value="@HouseholdTaskPriority.Low">Låg</MudSelectItem>
            <MudSelectItem Value="@HouseholdTaskPriority.Normal">Normal</MudSelectItem>
            <MudSelectItem Value="@HouseholdTaskPriority.High">Hög</MudSelectItem>
        </MudSelect>
        <MudDatePicker @bind-Date="taskDueDate" Label="Förfaller datum (valfritt)" Clearable="true" />
        @if (household?.Members.Any(m => m.IsActive) == true)
        {
            <MudSelect @bind-Value="selectedTaskMemberId" Label="Tilldela till (valfritt)">
                <MudSelectItem Value="@((int?)null)">Ingen vald</MudSelectItem>
                @foreach (var member in household.Members.Where(m => m.IsActive))
                {
                    <MudSelectItem Value="@((int?)member.HouseholdMemberId)">@member.Name</MudSelectItem>
                }
            </MudSelect>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseAddTaskDialog">Avbryt</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="SaveTask">@(editingTask != null ? "Spara" : "Lägg till")</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter]
    public int HouseholdId { get; set; }

    private Household? household;
    private Dictionary<int, decimal>? memberTotals;
    private List<BreadcrumbItem> breadcrumbs = new();
    
    private bool showAddMemberDialog = false;
    private bool showAddExpenseDialog = false;
    private bool showExpenseDetailsDialog = false;
    private HouseholdMember newMember = new HouseholdMember();
    private SharedExpense newExpense = new SharedExpense();
    private SharedExpense? selectedExpense;
    private DateTime? expenseDate = DateTime.Today;
    private DialogOptions dialogOptions = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };

    // Timeline (Activity) variables
    private List<HouseholdActivity> filteredActivities = new();
    private bool showAddActivityDialog = false;
    private HouseholdActivity newActivity = new HouseholdActivity();
    private DateTime? activityCompletedDate = DateTime.Today;
    private DateTime? activityFilterStartDate;
    private DateTime? activityFilterEndDate;
    private int? selectedActivityMemberId;

    // To-Do (Task) variables
    private List<HouseholdTask> filteredTasks = new();
    private bool showAddTaskDialog = false;
    private HouseholdTask newTask = new HouseholdTask();
    private HouseholdTask? editingTask;
    private DateTime? taskDueDate;
    private int? selectedTaskMemberId;
    private string taskSearchTerm = string.Empty;
    private bool showCompletedTasks = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadHousehold();
        
        breadcrumbs = new List<BreadcrumbItem>
        {
            new BreadcrumbItem("Hushåll", "/family/households"),
            new BreadcrumbItem(household?.Name ?? "Detaljer", null, disabled: true)
        };
    }

    private async Task LoadHousehold()
    {
        household = await HouseholdService.GetHouseholdByIdAsync(HouseholdId);
        if (household != null)
        {
            memberTotals = await HouseholdService.GetMemberTotalSharesAsync(HouseholdId);
            await LoadActivities();
            await LoadTasks();
        }
    }

    private async Task LoadActivities()
    {
        var activities = await HouseholdService.GetActivitiesAsync(
            HouseholdId,
            activityFilterStartDate,
            activityFilterEndDate
        );
        filteredActivities = activities.ToList();
    }

    private async Task LoadTasks()
    {
        IEnumerable<HouseholdTask> tasks;
        
        if (!string.IsNullOrWhiteSpace(taskSearchTerm))
        {
            tasks = await HouseholdService.SearchTasksAsync(HouseholdId, taskSearchTerm);
        }
        else
        {
            tasks = await HouseholdService.GetTasksAsync(HouseholdId, includeCompleted: showCompletedTasks);
        }
        
        filteredTasks = tasks.ToList();
    }

    private void OpenAddMemberDialog()
    {
        if (household?.Members.Count(m => m.IsActive) >= 4)
        {
            // Show error that max 4 members allowed
            return;
        }
        newMember = new HouseholdMember { HouseholdId = HouseholdId };
        showAddMemberDialog = true;
    }

    private void CloseAddMemberDialog()
    {
        showAddMemberDialog = false;
    }

    private async Task AddMember()
    {
        if (string.IsNullOrWhiteSpace(newMember.Name))
            return;

        await HouseholdService.AddMemberAsync(newMember);
        await LoadHousehold();
        CloseAddMemberDialog();
    }

    private async Task RemoveMember(int memberId)
    {
        await HouseholdService.RemoveMemberAsync(memberId);
        await LoadHousehold();
    }

    private void OpenAddExpenseDialog()
    {
        if (household?.Members.Count(m => m.IsActive) < 2)
        {
            // Show error that at least 2 members required
            return;
        }
        newExpense = new SharedExpense { HouseholdId = HouseholdId, SplitMethod = SplitMethod.Equal };
        expenseDate = DateTime.Today;
        showAddExpenseDialog = true;
    }

    private void CloseAddExpenseDialog()
    {
        showAddExpenseDialog = false;
    }

    private async Task AddExpense()
    {
        if (string.IsNullOrWhiteSpace(newExpense.Name) || newExpense.TotalAmount <= 0)
            return;

        newExpense.ExpenseDate = expenseDate ?? DateTime.Today;
        var expense = await HouseholdService.CreateSharedExpenseAsync(newExpense);
        
        // Automatically distribute according to selected method
        if (newExpense.SplitMethod == SplitMethod.Equal)
        {
            await HouseholdService.DistributeExpenseEquallyAsync(expense.SharedExpenseId);
        }
        
        await LoadHousehold();
        CloseAddExpenseDialog();
    }

    private async Task DeleteExpense(int expenseId)
    {
        await HouseholdService.DeleteSharedExpenseAsync(expenseId);
        await LoadHousehold();
    }

    private async Task ViewExpenseDetails(int expenseId)
    {
        selectedExpense = await HouseholdService.GetSharedExpenseByIdAsync(expenseId);
        showExpenseDetailsDialog = true;
    }

    private void CloseExpenseDetailsDialog()
    {
        showExpenseDetailsDialog = false;
    }

    private string GetExpenseTypeText(ExpenseType type)
    {
        return type switch
        {
            ExpenseType.Rent => "Hyra",
            ExpenseType.Electricity => "El",
            ExpenseType.Internet => "Bredband",
            ExpenseType.Water => "Vatten",
            ExpenseType.Heating => "Värme",
            ExpenseType.Insurance => "Försäkring",
            ExpenseType.Other => "Övrigt",
            _ => type.ToString()
        };
    }

    private string GetSplitMethodText(SplitMethod method)
    {
        return method switch
        {
            SplitMethod.Equal => "Jämnt",
            SplitMethod.ByPercentage => "Efter procent",
            SplitMethod.ByAmount => "Efter belopp",
            SplitMethod.ByRoomSize => "Efter rumsyta",
            _ => method.ToString()
        };
    }

    // Activity (Timeline) methods
    private void OpenAddActivityDialog()
    {
        newActivity = new HouseholdActivity 
        { 
            HouseholdId = HouseholdId,
            Type = HouseholdActivityType.General
        };
        activityCompletedDate = DateTime.Today;
        selectedActivityMemberId = null;
        showAddActivityDialog = true;
    }

    private void CloseAddActivityDialog()
    {
        showAddActivityDialog = false;
    }

    private async Task AddActivity()
    {
        if (string.IsNullOrWhiteSpace(newActivity.Title))
            return;

        newActivity.CompletedDate = activityCompletedDate ?? DateTime.Now;
        newActivity.CompletedByMemberId = selectedActivityMemberId;
        
        await HouseholdService.CreateActivityAsync(newActivity);
        await LoadActivities();
        CloseAddActivityDialog();
    }

    private async Task DeleteActivity(int activityId)
    {
        await HouseholdService.DeleteActivityAsync(activityId);
        await LoadActivities();
    }

    private async Task FilterActivities()
    {
        await LoadActivities();
    }

    private string GetActivityTypeText(HouseholdActivityType type)
    {
        return type switch
        {
            HouseholdActivityType.General => "Allmänt",
            HouseholdActivityType.Cleaning => "Städning",
            HouseholdActivityType.Maintenance => "Underhåll",
            HouseholdActivityType.Shopping => "Inköp",
            HouseholdActivityType.Cooking => "Matlagning",
            HouseholdActivityType.Repair => "Reparation",
            HouseholdActivityType.Other => "Övrigt",
            _ => type.ToString()
        };
    }

    // Task (To-Do) methods
    private void OpenAddTaskDialog()
    {
        editingTask = null;
        newTask = new HouseholdTask 
        { 
            HouseholdId = HouseholdId,
            Priority = HouseholdTaskPriority.Normal,
            Category = HouseholdActivityType.General
        };
        taskDueDate = null;
        selectedTaskMemberId = null;
        showAddTaskDialog = true;
    }

    private void OpenEditTaskDialog(HouseholdTask task)
    {
        editingTask = task;
        newTask = new HouseholdTask
        {
            HouseholdTaskId = task.HouseholdTaskId,
            HouseholdId = task.HouseholdId,
            Title = task.Title,
            Description = task.Description,
            Priority = task.Priority,
            Category = task.Category,
            DueDate = task.DueDate,
            AssignedToMemberId = task.AssignedToMemberId,
            IsCompleted = task.IsCompleted,
            CompletedDate = task.CompletedDate,
            CompletedByMemberId = task.CompletedByMemberId,
            CreatedDate = task.CreatedDate
        };
        taskDueDate = task.DueDate;
        selectedTaskMemberId = task.AssignedToMemberId;
        showAddTaskDialog = true;
    }

    private void CloseAddTaskDialog()
    {
        showAddTaskDialog = false;
        editingTask = null;
    }

    private async Task SaveTask()
    {
        if (string.IsNullOrWhiteSpace(newTask.Title))
            return;

        newTask.DueDate = taskDueDate;
        newTask.AssignedToMemberId = selectedTaskMemberId;

        if (editingTask != null)
        {
            // Update existing task
            await HouseholdService.UpdateTaskAsync(newTask);
        }
        else
        {
            // Create new task
            await HouseholdService.CreateTaskAsync(newTask);
        }
        
        await LoadTasks();
        CloseAddTaskDialog();
    }

    private async Task DeleteTask(int taskId)
    {
        await HouseholdService.DeleteTaskAsync(taskId);
        await LoadTasks();
    }

    private async Task ToggleTaskComplete(int taskId, bool isCompleted)
    {
        if (isCompleted)
        {
            await HouseholdService.MarkTaskCompleteAsync(taskId);
        }
        else
        {
            await HouseholdService.MarkTaskIncompleteAsync(taskId);
        }
        await LoadTasks();
    }
}
