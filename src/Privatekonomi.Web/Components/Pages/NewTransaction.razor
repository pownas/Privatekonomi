@page "/transactions/new"
@rendermode InteractiveServer
@inject ITransactionService TransactionService
@inject ICategoryService CategoryService
@inject IBankSourceService BankSourceService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<PageTitle>Ny Transaktion - Privatekonomi</PageTitle>

<div class="d-flex align-center mb-4">
    <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" 
                   Color="Color.Default" 
                   OnClick="Cancel"
                   aria-label="Tillbaka till transaktioner" 
                   Class="mr-2" />
    <MudText Typo="Typo.h4">
        <MudIcon Icon="@Icons.Material.Filled.Add" Color="Color.Primary" Class="mr-2" aria-hidden="true" />
        Ny Transaktion
    </MudText>
</div>

<MudPaper Class="pa-4">
    <EditForm Model="@_transaction" OnValidSubmit="OnValidSubmit" FormName="NewTransactionForm">
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudDatePicker Label="Datum" 
                               @bind-Date="_date" 
                               Required="true"
                               aria-label="Välj transaktionsdatum" />
            </MudItem>
            
            <MudItem xs="12" md="6">
                <MudNumericField Label="Belopp" 
                                 @bind-Value="_transaction.Amount" 
                                 Required="true" 
                                 Format="N2" 
                                 Culture="@(new System.Globalization.CultureInfo("sv-SE"))" 
                                 Adornment="Adornment.Start" 
                                 AdornmentText="kr"
                                 aria-label="Ange transaktionsbelopp i kronor" />
            </MudItem>
            
            <MudItem xs="12">
                <MudTextField Label="Beskrivning" 
                              @bind-Value="_transaction.Description" 
                              Required="true"
                              aria-label="Ange transaktionsbeskrivning" />
            </MudItem>
            
            <MudItem xs="12">
                <MudSelect T="int?" 
                          Label="Bank" 
                          @bind-Value="_transaction.BankSourceId" 
                          Clearable="true"
                          aria-label="Välj bank (valfritt)">
                    @foreach (var bank in _bankSources)
                    {
                        <MudSelectItem T="int?" Value="@bank.BankSourceId">
                            @bank.Name
                        </MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            
            <MudItem xs="12">
                <MudSwitch @bind-Value="_transaction.IsIncome" 
                           Color="Color.Success" 
                           Label="@(_transaction.IsIncome ? "Inkomst" : "Utgift")"
                           aria-label="Välj om det är en inkomst eller utgift" />
            </MudItem>
            
            <MudItem xs="12">
                <div class="d-flex align-center mb-2">
                    <MudText Typo="Typo.h6">Kategorier</MudText>
                    <MudTooltip Text="Välj en eller flera kategorier för transaktionen">
                        <MudIconButton Icon="@Icons.Material.Filled.Info" Size="Size.Small" Color="Color.Info" aria-label="Information om kategorier" />
                    </MudTooltip>
                </div>
                @if (_loading)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                }
                else if (!_categories.Any())
                {
                    <MudText>Inga kategorier tillgängliga.</MudText>
                }
                else
                {
                    <MudGrid>
                        @foreach (var category in _categories)
                        {
                            <MudItem xs="12" sm="6" md="4">
                                <MudCheckBox @bind-Value="@_selectedCategories[category.CategoryId]" 
                                             Color="Color.Primary">
                                    <MudChip T="string" Size="Size.Small" Style="@($"background-color: {category.Color}; color: white;")">
                                        @category.Name
                                    </MudChip>
                                </MudCheckBox>
                            </MudItem>
                        }
                    </MudGrid>
                }
            </MudItem>
            
            <MudItem xs="12" Class="d-flex justify-space-between mt-4">
                <MudButton Variant="Variant.Outlined" 
                           Color="Color.Default" 
                           OnClick="Cancel"
                           StartIcon="@Icons.Material.Filled.Close"
                           aria-label="Avbryt och gå tillbaka">
                    Avbryt
                </MudButton>
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary" 
                           ButtonType="ButtonType.Submit"
                           StartIcon="@Icons.Material.Filled.Save"
                           aria-label="Spara transaktion">
                    Spara Transaktion
                </MudButton>
            </MudItem>
        </MudGrid>
    </EditForm>
</MudPaper>

@code {
    private bool _loading = true;
    private Transaction _transaction = new Transaction { Date = DateTime.Today, Amount = 0 };
    private DateTime? _date = DateTime.Today;
    private IEnumerable<Category> _categories = new List<Category>();
    private IEnumerable<BankSource> _bankSources = new List<BankSource>();
    private Dictionary<int, bool> _selectedCategories = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadCategories();
        await LoadBankSources();
    }

    private async Task LoadCategories()
    {
        _loading = true;
        _categories = await CategoryService.GetAllCategoriesAsync();
        
        foreach (var category in _categories)
        {
            _selectedCategories[category.CategoryId] = false;
        }
        
        _loading = false;
    }

    private async Task LoadBankSources()
    {
        _bankSources = await BankSourceService.GetAllBankSourcesAsync();
    }

    private async Task OnValidSubmit()
    {
        if (_date.HasValue)
        {
            _transaction.Date = _date.Value;
        }

        // Add selected categories
        var selectedCategoryIds = _selectedCategories.Where(kvp => kvp.Value).Select(kvp => kvp.Key).ToList();
        
        if (selectedCategoryIds.Any())
        {
            // Split amount equally among selected categories
            var amountPerCategory = _transaction.Amount / selectedCategoryIds.Count;
            
            foreach (var categoryId in selectedCategoryIds)
            {
                _transaction.TransactionCategories.Add(new TransactionCategory
                {
                    CategoryId = categoryId,
                    Amount = amountPerCategory
                });
            }
        }

        try
        {
            await TransactionService.CreateTransactionAsync(_transaction);
            Snackbar.Add("Transaktion skapad", Severity.Success);
            Navigation.NavigateTo("/transactions");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fel vid skapande av transaktion: {ex.Message}", Severity.Error);
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/transactions");
    }
}
