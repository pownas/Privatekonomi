@inherits LayoutComponentBase
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.Extensions.Options
@using Microsoft.Extensions.DependencyInjection
@using Privatekonomi.Core.Configuration
@using Privatekonomi.Core.Services.Persistence
@using Privatekonomi.Core.Data
@inject ThemeService ThemeService
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject IOptions<StorageSettings> StorageSettings
@inject IServiceProvider ServiceProvider
@inject ISnackbar Snackbar
@implements IDisposable

<MudThemeProvider @ref="@_mudThemeProvider" Theme="@_theme" @bind-IsDarkMode="@_isDarkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="1">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@ToggleDrawer" />
        <MudText Typo="Typo.h5" Class="ml-3">Privatekonomi</MudText>
        <MudSpacer />
        @if (IsJsonFileStorage)
        {
            <MudTooltip Text="Spara data till JSON-filer">
                <MudIconButton Icon="@Icons.Material.Filled.Save" 
                               Color="Color.Inherit" 
                               OnClick="@SaveJsonData"
                               Disabled="@_isSaving"
                               aria-label="Spara JSON-data" />
            </MudTooltip>
        }
        <AuthorizeView>
            <Authorized>
                <MudText Typo="Typo.body2" Class="mr-2">@context.User.Identity?.Name</MudText>
                <MudButton Href="/Account/Logout" Color="Color.Inherit" StartIcon="@Icons.Material.Filled.Logout">Logga ut</MudButton>
            </Authorized>
            <NotAuthorized>
                <MudButton Href="/Account/Login" Color="Color.Inherit" StartIcon="@Icons.Material.Filled.Login">Logga in</MudButton>
            </NotAuthorized>
        </AuthorizeView>
        <MudIconButton Icon="@(_isDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)" 
                       Color="Color.Inherit" 
                       OnClick="@ToggleTheme" 
                       aria-label="@(_isDarkMode ? "Ljust läge" : "Mörkt läge")" />
    </MudAppBar>
    
    <MudDrawer @bind-Open="@_drawerOpen" 
               ClipMode="DrawerClipMode.Always" 
               Elevation="2"
               Breakpoint="Breakpoint.Md"
               Variant="@DrawerVariant.Responsive">
        <NavMenu />
    </MudDrawer>
    
    <MudMainContent Class="pa-2 pa-md-4">
        @Body
    </MudMainContent>
</MudLayout>

@code {
    private bool _drawerOpen = true;
    private bool _isDarkMode = false;
    private bool _isSaving = false;
    private MudThemeProvider? _mudThemeProvider;
    private MudTheme _theme = new MudTheme()
    {
        PaletteLight = new PaletteLight()
        {
            Primary = "#594AE2",
            Secondary = "#FF4081",
            AppbarBackground = "#594AE2",
        },
        PaletteDark = new PaletteDark()
        {
            Primary = "#776BE7",
            Secondary = "#FF4081",
            AppbarBackground = "#27272f",
            AppbarText = "rgba(255,255,255, 0.87)",
            Background = "#1a1a1f",
            BackgroundGray = "#27272f",
            Surface = "#27272f",
            DrawerBackground = "#27272f",
            DrawerText = "rgba(255,255,255, 0.87)",
            DrawerIcon = "rgba(255,255,255, 0.87)",
            TextPrimary = "rgba(255,255,255, 0.87)",
            TextSecondary = "rgba(255,255,255, 0.60)",
            ActionDefault = "rgba(255,255,255, 0.87)",
            ActionDisabled = "rgba(255,255,255, 0.26)",
            ActionDisabledBackground = "rgba(255,255,255, 0.12)",
            Divider = "rgba(255,255,255, 0.12)",
            DividerLight = "rgba(255,255,255, 0.06)",
            TableLines = "rgba(255,255,255, 0.12)",
            LinesDefault = "rgba(255,255,255, 0.12)",
            LinesInputs = "rgba(255,255,255, 0.3)",
            TextDisabled = "rgba(255,255,255, 0.38)",
        }
    };

    private bool IsJsonFileStorage => 
        StorageSettings.Value.Provider.Equals("JsonFile", StringComparison.OrdinalIgnoreCase);

    private async Task SaveJsonData()
    {
        if (!IsJsonFileStorage)
        {
            return;
        }

        _isSaving = true;
        StateHasChanged();

        try
        {
            using var scope = ServiceProvider.CreateScope();
            var context = scope.ServiceProvider.GetRequiredService<PrivatekonomyContext>();
            var persistenceService = scope.ServiceProvider.GetService<IDataPersistenceService>();

            if (persistenceService != null)
            {
                await persistenceService.SaveAsync(context);
                Snackbar.Add("Data sparad till JSON-filer", Severity.Success);
            }
            else
            {
                Snackbar.Add("Kunde inte hitta persistence service", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fel vid sparande: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _mudThemeProvider != null)
        {
            try
            {
                // Get the initial theme that was already applied in the head script
                _isDarkMode = await JSRuntime.InvokeAsync<bool>("themeManager.getInitialTheme");
                
                // If no saved preference exists, save the system preference
                var hasSavedPreference = await JSRuntime.InvokeAsync<bool>("themeManager.hasPreference");
                if (!hasSavedPreference)
                {
                    await JSRuntime.InvokeVoidAsync("themeManager.setTheme", _isDarkMode);
                }
                
                ThemeService.IsDarkMode = _isDarkMode;
                StateHasChanged();
            }
            catch
            {
                // Ignore JS interop errors on first render
            }
        }
    }

    protected override void OnInitialized()
    {
        _isDarkMode = ThemeService.IsDarkMode;
        ThemeService.OnThemeChanged += OnThemeChanged;
    }

    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }
    
    private async Task ToggleTheme()
    {
        _isDarkMode = !_isDarkMode;
        ThemeService.IsDarkMode = _isDarkMode;
        
        try
        {
            await JSRuntime.InvokeVoidAsync("themeManager.setTheme", _isDarkMode);
        }
        catch
        {
            // Ignore JS interop errors
        }
    }
    
    private void OnThemeChanged()
    {
        _isDarkMode = ThemeService.IsDarkMode;
        StateHasChanged();
    }
    
    public void Dispose()
    {
        ThemeService.OnThemeChanged -= OnThemeChanged;
    }
}
