@inject NavigationManager NavigationManager
@inject Microsoft.AspNetCore.Identity.UserManager<Privatekonomi.Core.Models.ApplicationUser> UserManager
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthenticationStateProvider
@inject Privatekonomi.Core.Services.INavigationPerformanceService NavigationPerformanceService
@inject ILogger<NavMenu> Logger
@implements IDisposable

<MudNavMenu Class="nav-menu">
    <div class="nav-section-header">ÖVERSIKT</div>
    <MudNavLink Href="/" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Dashboard" OnClick="@(() => TrackNavigation("/", "Dashboard"))">Dashboard</MudNavLink>
    <MudNavLink Href="/dashboard/custom" Icon="@Icons.Material.Filled.ViewModule" OnClick="@(() => TrackNavigation("/dashboard/custom", "Anpassad Dashboard"))">Anpassad Dashboard</MudNavLink>
  
    @if (_isSystemAdmin)
    {
        <MudNavLink Href="/admin/metrics" Icon="@Icons.Material.Filled.AdminPanelSettings" Style="color: #ff6b6b;" OnClick="@(() => TrackNavigation("/admin/metrics", "Admin Dashboard"))">
            Admin Dashboard
        </MudNavLink>
    }

    <div class="nav-section-header">EKONOMI</div>
    <MudNavGroup Title="Ekonomi" Icon="@Icons.Material.Filled.AccountBalance" Class="@GetGroupClass(EconomyKey)" Expanded="@IsGroupExpanded(EconomyKey)" ExpandedChanged="@(expanded => OnGroupExpandedChanged(EconomyKey, expanded))">
        <MudNavLink Href="/economy/transactions" Icon="@Icons.Material.Filled.List" OnClick="@(() => TrackNavigation("/economy/transactions", "Transaktioner"))">Transaktioner</MudNavLink>
        <MudNavLink Href="/economy/transactions/calendar" Icon="@Icons.Material.Filled.CalendarMonth" OnClick="@(() => TrackNavigation("/economy/transactions/calendar", "Kalendervy"))">Kalendervy</MudNavLink>
        <MudNavLink Href="/economy/transactions/new" Icon="@Icons.Material.Filled.Add" OnClick="@(() => TrackNavigation("/economy/transactions/new", "Ny Transaktion"))">Ny Transaktion</MudNavLink>
        <MudNavLink Href="/economy/reports/expense-heatmap" Icon="@Icons.Material.Filled.LocalFireDepartment" OnClick="@(() => TrackNavigation("/economy/reports/expense-heatmap", "Utgifts-heatmap"))">Utgifts-heatmap</MudNavLink>
        <MudNavLink Href="/economy/reports/spending-pattern" Icon="@Icons.Material.Filled.Analytics" OnClick="@(() => TrackNavigation("/economy/reports/spending-pattern", "Utgiftsmönster-analys"))">Utgiftsmönster-analys</MudNavLink>
        <MudNavLink Href="/economy/budgets" Icon="@Icons.Material.Filled.PieChart" OnClick="@(() => TrackNavigation("/economy/budgets", "Budget"))">Budget</MudNavLink>
        <MudNavLink Href="/economy/budgets/builder" Icon="@Icons.Material.Filled.AutoAwesome" OnClick="@(() => TrackNavigation("/economy/budgets/builder", "Budgetbyggare"))">Budgetbyggare</MudNavLink>
        <MudNavLink Href="/economy/budgets/konsumentverket-comparison" Icon="@Icons.Material.Filled.CompareArrows" OnClick="@(() => TrackNavigation("/economy/budgets/konsumentverket-comparison", "Konsumentverket Jämförelse"))">Konsumentverket Jämförelse</MudNavLink>
        <MudNavLink Href="/economy/budgets/kalp-comparison" Icon="@Icons.Material.Filled.AccountBalanceWallet" OnClick="@(() => TrackNavigation("/economy/budgets/kalp-comparison", "KALP Kalkyl"))">KALP Kalkyl</MudNavLink>
        <MudNavLink Href="/economy/receipts" Icon="@Icons.Material.Filled.Receipt" OnClick="@(() => TrackNavigation("/economy/receipts", "Kvitton"))">Kvitton</MudNavLink>
        <MudNavLink Href="/economy/bills" Icon="@Icons.Material.Filled.RequestQuote" OnClick="@(() => TrackNavigation("/economy/bills", "Räkningar"))">Räkningar</MudNavLink>
        <MudNavLink Href="/economy/subscriptions" Icon="@Icons.Material.Filled.Autorenew" OnClick="@(() => TrackNavigation("/economy/subscriptions", "Abonnemang"))">Abonnemang</MudNavLink>
        <MudNavLink Href="/economy/cashflow/sankey" Icon="@Icons.Material.Filled.WaterfallChart" OnClick="@(() => TrackNavigation("/economy/cashflow/sankey", "Sankey-diagram"))">Sankey-diagram</MudNavLink>
        <MudNavLink Href="/economy/balance-sheet" Icon="@Icons.Material.Filled.AccountBalanceWallet" OnClick="@(() => TrackNavigation("/economy/balance-sheet", "Balansräkning"))">Balansräkning</MudNavLink>
        <MudNavLink Href="/economy/networth-chart" Icon="@Icons.Material.Filled.ShowChart" OnClick="@(() => TrackNavigation("/economy/networth-chart", "Nettoförmögenhetskurva"))">Nettoförmögenhetskurva</MudNavLink>
        <MudNavLink Href="/economy/timeline" Icon="@Icons.Material.Filled.History" OnClick="@(() => TrackNavigation("/economy/timeline", "Ekonomisk Tidsresa"))">Ekonomisk Tidsresa</MudNavLink>
        <MudNavLink Href="/economy/health-score" Icon="@Icons.Material.Filled.MonitorHeart" OnClick="@(() => TrackNavigation("/economy/health-score", "Ekonomisk Hälsa"))">Ekonomisk Hälsa</MudNavLink>
    </MudNavGroup>

    <div class="nav-section-header">SPARANDE</div>
    <MudNavGroup Title="Sparande" Icon="@Icons.Material.Filled.Savings" Class="@GetGroupClass(SavingsKey)" Expanded="@IsGroupExpanded(SavingsKey)" ExpandedChanged="@(expanded => OnGroupExpandedChanged(SavingsKey, expanded))">
        <MudNavLink Href="/savings/goals" Icon="@Icons.Material.Filled.EmojiEvents" OnClick="@(() => TrackNavigation("/savings/goals", "Sparmål"))">Sparmål</MudNavLink>
        <MudNavLink Href="/savings/scenario-analysis" Icon="@Icons.Material.Filled.TrendingUp" OnClick="@(() => TrackNavigation("/savings/scenario-analysis", "Scenarioanalys"))">Scenarioanalys</MudNavLink>
        <MudNavLink Href="/savings/roundup" Icon="@Icons.Material.Filled.AccountBalanceWallet" OnClick="@(() => TrackNavigation("/savings/roundup", "Round-up Sparande"))">Round-up Sparande</MudNavLink>
        <MudNavLink Href="/savings/challenges" Icon="@Icons.Material.Filled.Flag" OnClick="@(() => TrackNavigation("/savings/challenges", "Sparmåls-utmaningar"))">Sparmåls-utmaningar</MudNavLink>
        <MudNavLink Href="/savings/shared-goals" Icon="@Icons.Material.Filled.Groups" OnClick="@(() => TrackNavigation("/savings/shared-goals", "Gemensamma Sparmål"))">Gemensamma Sparmål</MudNavLink>
        <MudNavLink Href="/savings/pockets" Icon="@Icons.Material.Filled.Wallet" OnClick="@(() => TrackNavigation("/savings/pockets", "Sparfickor"))">Sparflickor</MudNavLink>
        <MudNavLink Href="/savings/life-timeline" Icon="@Icons.Material.Filled.Timeline" OnClick="@(() => TrackNavigation("/savings/life-timeline", "Livslinjeplanering"))">Livslinjeplanering</MudNavLink>
    </MudNavGroup>

    <div class="nav-section-header">SOCIALT</div>
    <MudNavGroup Title="Socialt" Icon="@Icons.Material.Filled.Share" Class="@GetGroupClass(SocialKey)" Expanded="@IsGroupExpanded(SocialKey)" ExpandedChanged="@(expanded => OnGroupExpandedChanged(SocialKey, expanded))">
        <MudNavLink Href="/social/privacy-settings" Icon="@Icons.Material.Filled.Security" OnClick="@(() => TrackNavigation("/social/privacy-settings", "Integritetsinställningar"))">Integritetsinställningar</MudNavLink>
    </MudNavGroup>

    <div class="nav-section-header">INVESTERINGAR & TILLGÅNGAR</div>
    <MudNavGroup Title="Investeringar & Tillgångar" Icon="@Icons.Material.Filled.TrendingUp" Class="@GetGroupClass(InvestmentsKey)" Expanded="@IsGroupExpanded(InvestmentsKey)" ExpandedChanged="@(expanded => OnGroupExpandedChanged(InvestmentsKey, expanded))">
        <MudNavLink Href="/investments/overview" Icon="@Icons.Material.Filled.ShowChart" OnClick="@(() => TrackNavigation("/investments/overview", "Aktier & Fonder"))">Aktier & Fonder</MudNavLink>
        <MudNavLink Href="/investments/pensions" Icon="@Icons.Material.Filled.Elderly" OnClick="@(() => TrackNavigation("/investments/pensions", "Pension"))">Pension</MudNavLink>
        <MudNavLink Href="/investments/assets" Icon="@Icons.Material.Filled.BusinessCenter" OnClick="@(() => TrackNavigation("/investments/assets", "Tillgångar"))">Tillgångar</MudNavLink>
        <MudNavLink Href="/investments/currencies" Icon="@Icons.Material.Filled.AttachMoney" OnClick="@(() => TrackNavigation("/investments/currencies", "Kontanter/Valutor"))">Kontanter/Valutor</MudNavLink>
        <MudNavLink Href="/investments/loans" Icon="@Icons.Material.Filled.CreditCard" OnClick="@(() => TrackNavigation("/investments/loans", "Lån & Krediter"))">Lån & Krediter</MudNavLink>
    </MudNavGroup>

    <div class="nav-section-header">KATEGORIER</div>
    <MudNavGroup Title="Kategorier" Icon="@Icons.Material.Filled.Category" Class="@GetGroupClass(CategoriesKey)" Expanded="@IsGroupExpanded(CategoriesKey)" ExpandedChanged="@(expanded => OnGroupExpandedChanged(CategoriesKey, expanded))">
        <MudNavLink Href="/categories/manage" Icon="@Icons.Material.Filled.Label" OnClick="@(() => TrackNavigation("/categories/manage", "Hantera Kategorier"))">Hantera Kategorier</MudNavLink>
        <MudNavLink Href="/categories/tags" Icon="@Icons.Material.Filled.LocalOffer" OnClick="@(() => TrackNavigation("/categories/tags", "Taggar"))">Taggar</MudNavLink>
        <MudNavLink Href="/categories/overview" Icon="@Icons.Material.Filled.InsertChart" OnClick="@(() => TrackNavigation("/categories/overview", "Kategoriöversikt"))">Kategoriöversikt</MudNavLink>
        <MudNavLink Href="/categories/summary" Icon="@Icons.Material.Filled.Summarize" OnClick="@(() => TrackNavigation("/categories/summary", "Kategorisammanfattning"))">Kategorisammanfattning</MudNavLink>
        <MudNavLink Href="/categories/rules" Icon="@Icons.Material.Filled.AutoAwesome" OnClick="@(() => TrackNavigation("/categories/rules", "Kategoriseringsregler"))">Kategoriseringsregler</MudNavLink>
    </MudNavGroup>

    <div class="nav-section-header">FAMILJ & HUSHÅLL</div>
    <MudNavGroup Title="Familj & Hushåll" Icon="@Icons.Material.Filled.Home" Class="@GetGroupClass(FamilyKey)" Expanded="@IsGroupExpanded(FamilyKey)" ExpandedChanged="@(expanded => OnGroupExpandedChanged(FamilyKey, expanded))">
        <MudNavLink Href="/family/households" Icon="@Icons.Material.Filled.Group" OnClick="@(() => TrackNavigation("/family/households", "Hushåll"))">Hushåll</MudNavLink>
        <MudNavLink Href="/family/salary-history" Icon="@Icons.Material.Filled.WorkHistory" OnClick="@(() => TrackNavigation("/family/salary-history", "Löneutveckling"))">Löneutveckling</MudNavLink>
    </MudNavGroup>
    
    <div class="nav-section-header">SKATTEDEKLARATION</div>
    <MudNavGroup Title="Skattedeklaration" Icon="@Icons.Material.Filled.Description" Class="@GetGroupClass(TaxKey)" Expanded="@IsGroupExpanded(TaxKey)" ExpandedChanged="@(expanded => OnGroupExpandedChanged(TaxKey, expanded))">
        <MudNavLink Href="/tax/deductions" Icon="@Icons.Material.Filled.HomeRepairService" OnClick="@(() => TrackNavigation("/tax/deductions", "ROT/RUT-avdrag"))">ROT/RUT-avdrag</MudNavLink>
        <MudNavLink Href="/tax/k4-report" Icon="@Icons.Material.Filled.Assessment" OnClick="@(() => TrackNavigation("/tax/k4-report", "K4 Kapitalvinster"))">K4 Kapitalvinster</MudNavLink>
        <MudNavLink Href="/tax/sie-export" Icon="@Icons.Material.Filled.Download" OnClick="@(() => TrackNavigation("/tax/sie-export", "SIE-export"))">SIE-export</MudNavLink>
    </MudNavGroup>

    <div class="nav-section-header">INSTÄLLNINGAR</div>
    <MudNavGroup Title="Inställningar" Icon="@Icons.Material.Filled.Settings" Class="@GetGroupClass(SettingsKey)" Expanded="@IsGroupExpanded(SettingsKey)" ExpandedChanged="@(expanded => OnGroupExpandedChanged(SettingsKey, expanded))">
        <MudNavLink Href="/settings/accounts" Icon="@Icons.Material.Filled.AccountBalance" OnClick="@(() => TrackNavigation("/settings/accounts", "Konton"))">Konton</MudNavLink>
        <MudNavLink Href="/reminders" Icon="@Icons.Material.Filled.NotificationImportant" OnClick="@(() => TrackNavigation("/reminders", "Påminnelser"))">Påminnelser</MudNavLink>
        <MudNavLink Href="/settings/notifications" Icon="@Icons.Material.Filled.Notifications" OnClick="@(() => TrackNavigation("/settings/notifications", "Notifikationer"))">Notifikationer</MudNavLink>
        <MudNavLink Href="/settings/bank-connections" Icon="@Icons.Material.Filled.CloudSync" OnClick="@(() => TrackNavigation("/settings/bank-connections", "Bankkopplingar"))">Bankkopplingar</MudNavLink>
        <MudNavLink Href="/settings/import" Icon="@Icons.Material.Filled.Upload" OnClick="@(() => TrackNavigation("/settings/import", "Importera CSV"))">Importera CSV</MudNavLink>
        <MudNavLink Href="/settings/data-management" Icon="@Icons.Material.Filled.Backup" OnClick="@(() => TrackNavigation("/settings/data-management", "Datahantering"))">Datahantering</MudNavLink>
    </MudNavGroup>

    @if (_isDevelopment)
    {
        <MudNavGroup Title="Utvecklare" Icon="@Icons.Material.Filled.DeveloperMode" Class="@GetGroupClass(DeveloperKey)" Expanded="@IsGroupExpanded(DeveloperKey)" ExpandedChanged="@(expanded => OnGroupExpandedChanged(DeveloperKey, expanded))">
            <MudNavLink Href="/telemetry-example" Icon="@Icons.Material.Filled.BugReport" OnClick="@(() => TrackNavigation("/telemetry-example", "Telemetri Test"))">Telemetri Test</MudNavLink>
            <MudNavLink Href="/navigation-performance" Icon="@Icons.Material.Filled.Speed" OnClick="@(() => TrackNavigation("/navigation-performance", "Navigation Performance"))">Navigation Performance</MudNavLink>
        </MudNavGroup>
    }
</MudNavMenu>

@code {
    private bool _isSystemAdmin = false;
    private bool _isDevelopment = false;
    
    private const string EconomyKey = "economy";
    private const string SavingsKey = "savings";
    private const string SocialKey = "social";
    private const string InvestmentsKey = "investments";
    private const string CategoriesKey = "categories";
    private const string FamilyKey = "family";
    private const string TaxKey = "tax";
    private const string SettingsKey = "settings";
    private const string DeveloperKey = "developer";

    private string? activeGroupKey = EconomyKey;
    private string? currentRouteGroupKey;

    private static readonly string[] EconomyRoutes = new[]
    {
        "economy",
        "economy/transactions",
        "economy/transactions/calendar",
        "economy/transactions/new",
        "economy/reports/expense-heatmap",
        "economy/reports/spending-pattern",
        "economy/budgets",
        "economy/budgets/builder",
        "economy/budgets/konsumentverket-comparison",
        "economy/budgets/kalp-comparison",
        "economy/receipts",
        "economy/bills",
        "economy/subscriptions",
        "economy/cashflow/sankey",
        "economy/balance-sheet",
        "economy/networth-chart",
        "economy/timeline",
        "economy/health-score",
        "transactions",
        "transactions/calendar",
        "transactions/new",
        "reports/expense-heatmap",
        "reports/spending-pattern",
        "budgets",
        "budgets/builder",
        "budgets/konsumentverket-comparison",
        "budgets/kalp-comparison",
        "receipts",
        "bills",
        "subscriptions",
        "cashflow/sankey",
        "balancesheet",
        "networth-chart",
        "timeline",
        "health-score",
    };

    private static readonly string[] SavingsRoutes = new[]
    {
        "savings",
        "savings/goals",
        "savings/scenario-analysis",
        "savings/roundup",
        "savings/challenges",
        "savings/shared-goals",
        "savings/shared-goals/notifications",
        "savings/pockets",
        "savings/life-timeline",
        "goals",
        "scenario-analysis",
        "roundup",
        "savingschallenges",
        "sharedgoals",
        "pockets",
        "lifetimeline",
    };

    private static readonly string[] SocialRoutes = new[]
    {
        "social",
        "social/privacy-settings",
        "privacy-settings",
    };

    private static readonly string[] InvestmentsRoutes = new[]
    {
        "investments",
        "investments/overview",
        "investments/pensions",
        "investments/assets",
        "investments/currencies",
        "investments/loans",
        "pensions",
        "assets",
        "currencies",
        "loans",
    };

    private static readonly string[] CategoriesRoutes = new[]
    {
        "categories",
        "categories/manage",
        "categories/tags",
        "categories/overview",
        "categories/summary",
        "categories/rules",
        "tags",
        "category-overview",
        "categories-summary",
        "category-rules",
    };

    private static readonly string[] FamilyRoutes = new[]
    {
        "family",
        "family/households",
        "family/salary-history",
        "households",
        "salary-history",
    };

    private static readonly string[] TaxRoutes = new[]
    {
        "tax",
        "tax/deductions",
        "tax/k4-report",
        "tax/sie-export",
        "tax-deductions",
        "k4-report",
        "sie-export",
    };

    private static readonly string[] SettingsRoutes = new[]
    {
        "settings",
        "settings/notifications",
        "settings/bank-connections",
        "settings/import",
        "settings/data-management",
        "admin",
        "admin/notifications",
        "admin/bank-connections",
        "admin/import",
        "admin/data-management",
        "notifications",
        "bank-connections",
        "import",
        "data-management",
    };

    private static readonly string[] DeveloperRoutes = new[]
    {
        "telemetry-example",
    };

    private string currentPath = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        Logger.LogInformation("[NavMenu] OnInitializedAsync started");
        
        UpdateCurrentPath(NavigationManager.Uri);
        EnsureGroupForCurrentRoute();
        NavigationManager.LocationChanged += OnLocationChanged;
        AuthenticationStateProvider.AuthenticationStateChanged += OnAuthenticationStateChanged;
        
        // Check if user is system admin and if we're in development mode
        await CheckIfSystemAdminAsync();
        CheckIfDevelopmentMode();
        
        Logger.LogInformation("[NavMenu] OnInitializedAsync completed - Current Path: {Path}, Active Group: {Group}, IsDev: {IsDev}, IsAdmin: {IsAdmin}", 
            currentPath, activeGroupKey, _isDevelopment, _isSystemAdmin);
    }
    
    private void CheckIfDevelopmentMode()
    {
        // Använd IWebHostEnvironment eller kontrollera appsettings
        var env = Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT");
        _isDevelopment = env == "Development" || env == "Local";
    }
    
    private void OnAuthenticationStateChanged(Task<AuthenticationState> task)
    {
        _ = Task.Run(async () =>
        {
            try
            {
                await CheckIfSystemAdminAsync();
                await InvokeAsync(StateHasChanged);
            }
            catch (Exception)
            {
                // Silently handle exceptions during auth state change
                // to prevent unhandled exceptions in event handlers
            }
        });
    }
    
    private async Task CheckIfSystemAdminAsync()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            
            if (user.Identity?.IsAuthenticated == true)
            {
                var userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
                if (userId != null)
                {
                    var appUser = await UserManager.FindByIdAsync(userId);
                    _isSystemAdmin = appUser?.IsSystemAdmin ?? false;
                }
            }
            else
            {
                _isSystemAdmin = false;
            }
        }
        catch
        {
            _isSystemAdmin = false;
        }
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        Logger.LogInformation("[NavMenu] OnLocationChanged - New Location: {Location}", e.Location);
        
        UpdateCurrentPath(e.Location);
        EnsureGroupForCurrentRoute();
        
        Logger.LogInformation("[NavMenu] After location change - Current Path: {Path}, Active Group: {Group}", 
            currentPath, activeGroupKey);
        
        _ = InvokeAsync(StateHasChanged);
    }

    private void UpdateCurrentPath(string uri)
    {
        var relative = NavigationManager.ToBaseRelativePath(uri) ?? string.Empty;

        var queryIndex = relative.IndexOf('?', System.StringComparison.Ordinal);
        if (queryIndex >= 0)
        {
            relative = relative[..queryIndex];
        }

        var fragmentIndex = relative.IndexOf('#', System.StringComparison.Ordinal);
        if (fragmentIndex >= 0)
        {
            relative = relative[..fragmentIndex];
        }

        currentPath = relative.Trim('/');
    }

    private void EnsureGroupForCurrentRoute()
    {
        var groupKey = GetGroupKeyForCurrentPath();
        currentRouteGroupKey = groupKey;

        if (groupKey is null)
        {
            return;
        }

        activeGroupKey = groupKey;
    }

    private string? GetGroupKeyForCurrentPath()
    {
        if (MatchesRoutes(EconomyRoutes))
        {
            return EconomyKey;
        }

        if (MatchesRoutes(SavingsRoutes))
        {
            return SavingsKey;
        }

        if (MatchesRoutes(SocialRoutes))
        {
            return SocialKey;
        }

        if (MatchesRoutes(InvestmentsRoutes))
        {
            return InvestmentsKey;
        }

        if (MatchesRoutes(CategoriesRoutes))
        {
            return CategoriesKey;
        }

        if (MatchesRoutes(FamilyRoutes))
        {
            return FamilyKey;
        }

        if (MatchesRoutes(TaxRoutes))
        {
            return TaxKey;
        }

        if (MatchesRoutes(SettingsRoutes))
        {
            return SettingsKey;
        }

        if (MatchesRoutes(DeveloperRoutes))
        {
            return DeveloperKey;
        }

        return null;
    }

    private bool MatchesRoutes(string[]? routes)
    {
        if (routes is null || routes.Length == 0)
        {
            return false;
        }

        foreach (var route in routes)
        {
            if (RouteMatches(route))
            {
                return true;
            }
        }

        return false;
    }

    private bool RouteMatches(string? route)
    {
        if (string.IsNullOrWhiteSpace(route))
        {
            return string.IsNullOrEmpty(currentPath);
        }

        var normalizedRoute = route.Trim('/');
        if (string.IsNullOrEmpty(normalizedRoute))
        {
            return string.IsNullOrEmpty(currentPath);
        }

        if (string.IsNullOrEmpty(currentPath))
        {
            return false;
        }

        if (currentPath.Equals(normalizedRoute, System.StringComparison.OrdinalIgnoreCase))
        {
            return true;
        }

        return currentPath.StartsWith(normalizedRoute + "/", System.StringComparison.OrdinalIgnoreCase);
    }

    private string GetGroupClass(string key)
    {
        return IsGroupActive(key)
            ? "nav-group-active"
            : string.Empty;
    }

    private bool IsGroupActive(string key)
    {
        return !string.IsNullOrEmpty(currentRouteGroupKey) && string.Equals(currentRouteGroupKey, key, System.StringComparison.OrdinalIgnoreCase);
    }

    private bool IsGroupExpanded(string key)
    {
        var isExpanded = !string.IsNullOrEmpty(activeGroupKey) && string.Equals(activeGroupKey, key, System.StringComparison.OrdinalIgnoreCase);
        
        if (_isDevelopment)
        {
            Logger.LogDebug("[NavMenu] IsGroupExpanded - Key: {Key}, Result: {IsExpanded}, ActiveGroupKey: {ActiveGroupKey}", 
                key, isExpanded, activeGroupKey);
        }
        
        return isExpanded;
    }

    private void OnGroupExpandedChanged(string key, bool expanded)
    {
        Logger.LogInformation("[NavMenu] OnGroupExpandedChanged called - Key: {Key}, Expanded: {Expanded}, Current ActiveGroupKey: {ActiveGroupKey}", 
            key, expanded, activeGroupKey);

        if (!expanded)
        {
            if (string.Equals(activeGroupKey, key, System.StringComparison.OrdinalIgnoreCase))
            {
                Logger.LogInformation("[NavMenu] Collapsing group: {Key}", key);
                activeGroupKey = null;
            }
            return;
        }

        Logger.LogInformation("[NavMenu] Expanding group: {Key}", key);
        activeGroupKey = key;
    }

    private void TrackNavigation(string path, string name)
    {
        Logger.LogInformation("[NavMenu] TrackNavigation - Path: {Path}, Name: {Name}", path, name);
        NavigationPerformanceService.StartNavigation(path, $"NavMenu:{name}");
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
        AuthenticationStateProvider.AuthenticationStateChanged -= OnAuthenticationStateChanged;
    }
}
