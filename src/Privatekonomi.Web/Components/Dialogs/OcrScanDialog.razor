@using Privatekonomi.Core.Models
@using Privatekonomi.Core.Services
@using Microsoft.AspNetCore.Components.Forms
@using MudBlazor
@inject IOcrService OcrService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudPaper Class="pa-4">
            @if (_processing)
            {
                <div class="d-flex flex-column align-center pa-6">
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
                    <MudText Typo="Typo.body1" Class="mt-4">Bearbetar kvittobild med OCR...</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">Detta kan ta några sekunder</MudText>
                </div>
            }
            else if (_ocrResult != null)
            {
                @if (_ocrResult.Success && _ocrResult.ParsedData != null)
                {
                    <MudAlert Severity="Severity.Success" Class="mb-4">
                        OCR-skanning lyckades! Säkerhet: @(_ocrResult.Confidence.ToString("P0"))
                    </MudAlert>

                    <MudText Typo="Typo.h6" Class="mb-3">Extraherad data</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                        Granska och redigera informationen nedan innan du sparar.
                    </MudText>

                    <MudGrid>
                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="_parsedData!.Merchant"
                                        Label="Butik/Återförsäljare"
                                        Variant="Variant.Outlined"
                                        Required="true"
                                        Class="mb-3" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudNumericField @bind-Value="_parsedData!.TotalAmount"
                                           Label="Totalt belopp (kr)"
                                           Variant="Variant.Outlined"
                                           Min="0"
                                           Format="N2"
                                           Culture="@(new System.Globalization.CultureInfo("sv-SE"))"
                                           Class="mb-3" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudDatePicker @bind-Date="_parsedData!.Date"
                                         Label="Kvittodatum"
                                         Variant="Variant.Outlined"
                                         Class="mb-3" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="_parsedData!.ReceiptNumber"
                                        Label="Kvittonummer (valfritt)"
                                        Variant="Variant.Outlined"
                                        Class="mb-3" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="_parsedData!.PaymentMethod"
                                        Label="Betalningsmetod (valfritt)"
                                        Variant="Variant.Outlined"
                                        Class="mb-3" />
                        </MudItem>
                    </MudGrid>

                    @if (_parsedData!.LineItems != null && _parsedData.LineItems.Any())
                    {
                        <MudText Typo="Typo.h6" Class="mt-4 mb-3">Radposter (@_parsedData.LineItems.Count st)</MudText>
                        <MudSimpleTable Dense="true" Hover="true" Class="mb-4">
                            <thead>
                                <tr>
                                    <th>Beskrivning</th>
                                    <th>Antal</th>
                                    <th>À-pris</th>
                                    <th>Totalt</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in _parsedData.LineItems)
                                {
                                    <tr>
                                        <td>@item.Description</td>
                                        <td>@item.Quantity?.ToString("N2")</td>
                                        <td>@item.UnitPrice?.ToString("C", new System.Globalization.CultureInfo("sv-SE"))</td>
                                        <td>@item.TotalPrice?.ToString("C", new System.Globalization.CultureInfo("sv-SE"))</td>
                                    </tr>
                                }
                            </tbody>
                        </MudSimpleTable>
                    }

                    <MudExpansionPanels Class="mt-4">
                        <MudExpansionPanel Text="Visa råtext från OCR">
                            <MudTextField @bind-Value="_ocrResult.RawText"
                                        Label="OCR Råtext"
                                        Variant="Variant.Outlined"
                                        Lines="10"
                                        ReadOnly="true" />
                        </MudExpansionPanel>
                    </MudExpansionPanels>
                }
                else
                {
                    <MudAlert Severity="Severity.Error" Class="mb-4">
                        @_ocrResult.ErrorMessage
                    </MudAlert>
                    
                    <MudButton Variant="Variant.Outlined" 
                             Color="Color.Primary" 
                             StartIcon="@Icons.Material.Filled.Refresh"
                             OnClick="Reset">
                        Försök igen
                    </MudButton>
                }
            }
            else
            {
                <MudText Typo="Typo.h6" Class="mb-3">Skanna kvitto med OCR</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                    Ladda upp en bild på ditt kvitto så extraherar vi informationen automatiskt med hjälp av OCR-teknik.
                </MudText>

                <MudFileUpload T="IBrowserFile" FilesChanged="OnFileSelected" Accept="image/*" MaximumFileCount="1">
                    <ActivatorContent>
                        <MudPaper Outlined="true" Class="pa-6 d-flex flex-column align-center justify-center" 
                                Style="min-height: 200px; cursor: pointer; border: 2px dashed var(--mud-palette-primary);">
                            <MudIcon Icon="@Icons.Material.Filled.CloudUpload" Size="Size.Large" Color="Color.Primary" Class="mb-3" />
                            <MudText Typo="Typo.h6" Class="mb-2">Ladda upp kvittobild</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">eller dra och släpp här</MudText>
                            <MudChip T="string" Icon="@Icons.Material.Filled.Image" Color="Color.Info" Size="Size.Small">
                                JPEG, PNG, GIF, WebP (Max 10 MB)
                            </MudChip>
                        </MudPaper>
                    </ActivatorContent>
                </MudFileUpload>

                @if (_selectedFile != null)
                {
                    <MudAlert Severity="Severity.Info" Class="mt-4">
                        <div class="d-flex justify-space-between align-center">
                            <div>
                                <strong>@_selectedFile.Name</strong>
                                <MudText Typo="Typo.body2">@FormatFileSize(_selectedFile.Size)</MudText>
                            </div>
                            <div>
                                <MudButton Variant="Variant.Filled" 
                                         Color="Color.Primary" 
                                         StartIcon="@Icons.Material.Filled.Scanner"
                                         OnClick="ProcessImage">
                                    Skanna med OCR
                                </MudButton>
                            </div>
                        </div>
                    </MudAlert>
                }

                <MudAlert Severity="Severity.Info" Class="mt-4" Icon="@Icons.Material.Filled.Info">
                    <MudText Typo="Typo.body2">
                        <strong>Tips för bästa resultat:</strong>
                        <ul class="mt-2 mb-0">
                            <li>Använd god belysning och fotografera rakt uppifrån</li>
                            <li>Se till att hela kvittot syns i bilden</li>
                            <li>Undvik skuggor och reflektioner</li>
                            <li>Kvittot ska vara plant och inte vikt eller skrynkligt</li>
                        </ul>
                    </MudText>
                </MudAlert>
            }
        </MudPaper>
    </DialogContent>
    <DialogActions>
        @if (_ocrResult?.Success == true && _ocrResult.ParsedData != null)
        {
            <MudButton OnClick="Cancel">Avbryt</MudButton>
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="UseData">
                Använd data
            </MudButton>
        }
        else if (!_processing)
        {
            <MudButton OnClick="Cancel">Avbryt</MudButton>
        }
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] 
    private IMudDialogInstance? MudDialog { get; set; }

    private IBrowserFile? _selectedFile;
    private bool _processing = false;
    private OcrResult? _ocrResult;
    private OcrReceiptData? _parsedData;
    private const long MaxFileSize = 10 * 1024 * 1024; // 10 MB

    private void OnFileSelected(IBrowserFile file)
    {
        if (file.Size > MaxFileSize)
        {
            Snackbar.Add($"Filen är för stor. Max storlek är {MaxFileSize / 1024 / 1024} MB.", Severity.Error);
            return;
        }

        // Validate file type
        var allowedTypes = new[] { "image/jpeg", "image/jpg", "image/png", "image/gif", "image/webp" };
        if (!allowedTypes.Contains(file.ContentType.ToLower()))
        {
            Snackbar.Add("Endast bildfiler är tillåtna (JPEG, PNG, GIF, WebP).", Severity.Error);
            return;
        }

        _selectedFile = file;
    }

    private async Task ProcessImage()
    {
        if (_selectedFile == null)
        {
            Snackbar.Add("Ingen fil vald", Severity.Warning);
            return;
        }

        _processing = true;
        StateHasChanged();

        try
        {
            // Check if OCR service is available
            var isAvailable = await OcrService.IsAvailableAsync();
            if (!isAvailable)
            {
                Snackbar.Add("OCR-tjänsten är inte tillgänglig. Kontrollera att Tesseract-data är installerad.", Severity.Error);
                _processing = false;
                return;
            }

            // Process the image
            using var stream = _selectedFile.OpenReadStream(MaxFileSize);
            _ocrResult = await OcrService.ProcessReceiptImageAsync(stream, _selectedFile.Name);

            if (_ocrResult.Success && _ocrResult.ParsedData != null)
            {
                _parsedData = _ocrResult.ParsedData;
                Snackbar.Add("OCR-skanning slutförd! Granska resultatet.", Severity.Success);
            }
            else
            {
                Snackbar.Add(_ocrResult.ErrorMessage ?? "OCR-skanning misslyckades", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ett fel uppstod: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processing = false;
            StateHasChanged();
        }
    }

    private void Reset()
    {
        _selectedFile = null;
        _ocrResult = null;
        _parsedData = null;
    }

    private void Cancel()
    {
        MudDialog?.Cancel();
    }

    private void UseData()
    {
        if (_parsedData != null)
        {
            MudDialog?.Close(DialogResult.Ok(_parsedData));
        }
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }
}
