@using Privatekonomi.Core.Models
@using Privatekonomi.Core.Services
@inject IBankSourceService BankSourceService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="@_isValid">
            <MudGrid>
                <MudItem xs="12">
                    <MudTextField @bind-Value="_account.Name" 
                                  Label="Kontonamn" 
                                  Required="true"
                                  RequiredError="Kontonamn är obligatoriskt"
                                  Placeholder="T.ex. Mitt lönekonto, Nordea sparkonto"
                                  aria-label="Ange kontonamn" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudSelect @bind-Value="_account.AccountType" 
                              Label="Kontotyp" 
                              Required="true"
                              aria-label="Välj kontotyp">
                        <MudSelectItem Value="@("checking")">
                            <div class="d-flex align-center">
                                <MudIcon Icon="@Icons.Material.Filled.AccountBalance" Size="Size.Small" Class="mr-2" />
                                Lönekonto
                            </div>
                        </MudSelectItem>
                        <MudSelectItem Value="@("savings")">
                            <div class="d-flex align-center">
                                <MudIcon Icon="@Icons.Material.Filled.Savings" Size="Size.Small" Class="mr-2" />
                                Sparkonto
                            </div>
                        </MudSelectItem>
                        <MudSelectItem Value="@("credit_card")">
                            <div class="d-flex align-center">
                                <MudIcon Icon="@Icons.Material.Filled.CreditCard" Size="Size.Small" Class="mr-2" />
                                Kreditkort
                            </div>
                        </MudSelectItem>
                        <MudSelectItem Value="@("investment")">
                            <div class="d-flex align-center">
                                <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Size="Size.Small" Class="mr-2" />
                                Investeringskonto
                            </div>
                        </MudSelectItem>
                        <MudSelectItem Value="@("loan")">
                            <div class="d-flex align-center">
                                <MudIcon Icon="@Icons.Material.Filled.CreditScore" Size="Size.Small" Class="mr-2" />
                                Lån
                            </div>
                        </MudSelectItem>
                        <MudSelectItem Value="@("pension")">
                            <div class="d-flex align-center">
                                <MudIcon Icon="@Icons.Material.Filled.Elderly" Size="Size.Small" Class="mr-2" />
                                Pension
                            </div>
                        </MudSelectItem>
                        <MudSelectItem Value="@("cash")">
                            <div class="d-flex align-center">
                                <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Size="Size.Small" Class="mr-2" />
                                Kontanter
                            </div>
                        </MudSelectItem>
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_account.Institution" 
                                  Label="Bank/Institution" 
                                  Placeholder="T.ex. Swedbank, Nordea, SEB"
                                  aria-label="Ange bank eller institution" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_account.ClearingNumber" 
                                  Label="Clearingnummer" 
                                  Placeholder="T.ex. 8327"
                                  HelperText="För svenska bankkonton"
                                  aria-label="Ange clearingnummer" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_account.AccountNumber" 
                                  Label="Kontonummer" 
                                  Placeholder="T.ex. 123456789"
                                  aria-label="Ange kontonummer" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_account.Currency" 
                                  Label="Valuta" 
                                  Required="true"
                                  RequiredError="Valuta är obligatoriskt"
                                  aria-label="Ange valuta" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_account.ChartOfAccountsCode" 
                                  Label="Kontoplan (BAS)" 
                                  Placeholder="T.ex. 1930, 1510"
                                  HelperText="Koppla till BAS-kontoplan för redovisning"
                                  aria-label="Ange kontoplan" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudNumericField @bind-Value="_account.InitialBalance" 
                                    Label="Ingående saldo" 
                                    Format="N2"
                                    Culture="@(new System.Globalization.CultureInfo("sv-SE"))"
                                    Adornment="Adornment.Start"
                                    AdornmentText="kr"
                                    HelperText="Saldo när kontot öppnades"
                                    aria-label="Ange ingående saldo" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudDatePicker @bind-Date="_openedDate" 
                                  Label="Öppningsdatum" 
                                  HelperText="När kontot öppnades (valfritt)"
                                  aria-label="Välj öppningsdatum" />
                </MudItem>

                <MudItem xs="12">
                    <MudTextField @bind-Value="_account.Color" 
                                 Label="Färg (hex)" 
                                 Placeholder="#1976D2"
                                 HelperText="Färgkod i hex-format för att identifiera kontot i grafer"
                                 aria-label="Ange färg i hex-format" />
                </MudItem>
            </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Avbryt</MudButton>
        <MudButton Color="Color.Primary" OnClick="Submit" Disabled="!_isValid">Lägg till</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    IMudDialogInstance? MudDialog { get; set; }

    private MudForm? _form;
    private bool _isValid;
    private BankSource _account = new() 
    { 
        Name = "",
        AccountType = "checking",
        Currency = "SEK",
        Color = "#1976D2", // Default blue
        InitialBalance = 0
    };
    private DateTime? _openedDate;

    private async Task Submit()
    {
        if (_form is null)
        {
            return;
        }

        await _form.Validate();
        if (!_form.IsValid)
        {
            return;
        }

        try
        {
            // Set opened date if provided
            if (_openedDate.HasValue)
            {
                _account.OpenedDate = _openedDate.Value;
            }

            // Set temporal tracking fields
            _account.ValidFrom = DateTime.UtcNow;
            _account.CreatedAt = DateTime.UtcNow;

            await BankSourceService.CreateBankSourceAsync(_account);
            Snackbar.Add("Konto skapat", Severity.Success);
            MudDialog?.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fel vid skapande av konto: {ex.Message}", Severity.Error);
        }
    }

    private void Cancel()
    {
        MudDialog?.Cancel();
    }
}
