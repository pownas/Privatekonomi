@using Privatekonomi.Core.Models
@using Privatekonomi.Core.Services
@inject ICategoryService CategoryService
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.SwipeRight" Class="mr-2" />
            Snabbkategorisera
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudText Typo="Typo.body2" Class="mb-4">
            Välj kategori för: <strong>@Transaction?.Description</strong>
        </MudText>
        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-4">
            Belopp: @Transaction?.Amount.ToString("N2") kr
        </MudText>

        @if (_loading)
        {
            <div class="d-flex justify-center pa-4">
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            </div>
        }
        else if (_categories.Any())
        {
            <MudText Typo="Typo.subtitle2" Class="mb-2">Välj kategori:</MudText>
            
            <div class="d-flex flex-wrap gap-2 mb-4" style="max-height: 300px; overflow-y: auto;">
                @foreach (var category in _categories.OrderBy(c => c.Name))
                {
                    var isSelected = _selectedCategoryId == category.CategoryId;
                    <MudChip T="string" 
                             Color="@(isSelected ? Color.Primary : Color.Default)"
                             Variant="@(isSelected ? Variant.Filled : Variant.Outlined)"
                             OnClick="@(() => SelectCategory(category.CategoryId))"
                             Style="@($"border-color: {category.Color}; {(isSelected ? $"background-color: {category.Color}; color: white;" : "")}")">
                        <MudIcon Icon="@Icons.Material.Filled.Circle" Style="@($"color: {category.Color};")" Size="Size.Small" Class="mr-1" />
                        @category.Name
                    </MudChip>
                }
            </div>

            <MudDivider Class="my-4" />
            
            <MudSwitch @bind-Value="_createRule" 
                       Color="Color.Primary" 
                       Label="Skapa kategoriseringsregel"
                       Class="mb-2" />
            
            @if (_createRule)
            {
                <MudAlert Severity="Severity.Info" Dense="true" Class="mb-3">
                    En regel skapas baserad på transaktionens beskrivning. Liknande transaktioner kommer automatiskt kategoriseras.
                </MudAlert>
                
                <MudTextField @bind-Value="_rulePattern" 
                              Label="Mönster för regeln" 
                              Variant="Variant.Outlined"
                              HelperText="Lämna tomt för att använda transaktionsbeskrivningen"
                              Placeholder="@Transaction?.Description"
                              Class="mb-2" />
            }
        }
        else
        {
            <MudAlert Severity="Severity.Info">
                Inga kategorier tillgängliga. Skapa kategorier först.
            </MudAlert>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text">Avbryt</MudButton>
        <MudButton OnClick="Submit" 
                   Color="Color.Primary" 
                   Variant="Variant.Filled"
                   Disabled="@(!_selectedCategoryId.HasValue)">
            Kategorisera
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    public required IMudDialogInstance MudDialog { get; set; }

    [Parameter]
    public Transaction? Transaction { get; set; }

    private bool _loading = true;
    private List<Category> _categories = new();
    private int? _selectedCategoryId;
    private bool _createRule = false;
    private string? _rulePattern;

    protected override async Task OnInitializedAsync()
    {
        await LoadCategories();
        
        // Pre-select the category if transaction already has one
        if (Transaction?.TransactionCategories?.Any() == true)
        {
            _selectedCategoryId = Transaction.TransactionCategories.First().CategoryId;
        }
    }

    private async Task LoadCategories()
    {
        _loading = true;
        try
        {
            _categories = (await CategoryService.GetAllCategoriesAsync()).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fel vid laddning av kategorier: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private void SelectCategory(int categoryId)
    {
        _selectedCategoryId = categoryId;
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private void Submit()
    {
        if (!_selectedCategoryId.HasValue)
        {
            Snackbar.Add("Välj en kategori", Severity.Warning);
            return;
        }

        var result = new QuickCategorizeResult
        {
            CategoryId = _selectedCategoryId.Value,
            CreateRule = _createRule,
            RulePattern = string.IsNullOrWhiteSpace(_rulePattern) ? null : _rulePattern
        };

        MudDialog.Close(DialogResult.Ok(result));
    }

    public class QuickCategorizeResult
    {
        public int CategoryId { get; set; }
        public bool CreateRule { get; set; }
        public string? RulePattern { get; set; }
    }
}
